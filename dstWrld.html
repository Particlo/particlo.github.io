<!DOCTYPE html>
<html>
<head>
    <title>Particlo</title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/jpeg" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
    <link rel="image_src" type="image/jpeg" href="https://particlo.org/19.jpg">
    <meta name="description" content="travel in 3D fractal worlds using your vehicle">
    <meta name="keywords" content="videogame,balls,worlds,physics,fun,webgl">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Particlo">
    <meta name="twitter:description" content="travel in 3D fractal worlds using your vehicle">
    <meta name="twitter:image" content="https://particlo.org/19.jpg">
    <meta property="og:url" content="https://particlo.org/18">
    <meta property="og:image" content="https://particlo.org/19.jpg">
    <meta property="og:title" content="Particlo">
    <meta property="og:description" content="travel in 3D fractal worlds using your vehicle">
</head>
<body>
<script>
window.onload = start;

//vector math
var fmar = new Float32Array(64);//for general math vector operations
function vec3(w, a,b,c)
{
    fmar[w] = a; ++w;
    fmar[w] = b; ++w;
    fmar[w] = c; ++w;
}
function mat3(w, a,b,c, d,e,f, g,h,i)
{
    fmar[w] = a; ++w;    fmar[w] = b; ++w;   fmar[w] = c; ++w;
    fmar[w] = d; ++w;    fmar[w] = e; ++w;   fmar[w] = f; ++w;
    fmar[w] = g; ++w;    fmar[w] = h; ++w;   fmar[w] = i; ++w;
}
function cros3(w1, w2,w3)
{
    var a = fmar[w2+1]*fmar[w3+2] - fmar[w2+2]*fmar[w3+1];
    var b = fmar[w2+2]*fmar[w3+0] - fmar[w2+0]*fmar[w3+2];
    var c = fmar[w2+0]*fmar[w3+1] - fmar[w2+1]*fmar[w3+0];
    fmar[w1+0] = a;
    fmar[w1+1] = b;
    fmar[w1+2] = c;
}
function mul93(w1, w2,w3)
{
    var a = fmar[w3+0]*fmar[w2+0] + fmar[w3+1]*fmar[w2+3] + fmar[w3+2]*fmar[w2+6];
    var b = fmar[w3+0]*fmar[w2+1] + fmar[w3+1]*fmar[w2+4] + fmar[w3+2]*fmar[w2+7];
    var c = fmar[w3+0]*fmar[w2+2] + fmar[w3+1]*fmar[w2+5] + fmar[w3+2]*fmar[w2+8];
    fmar[w1+0] = a;
    fmar[w1+1] = b;
    fmar[w1+2] = c;
}
function mul39(w1, w2,w3)
{
    var a = fmar[w3+0]*fmar[w2+0] + fmar[w3+1]*fmar[w2+1] + fmar[w3+2]*fmar[w2+2];
    var b = fmar[w3+0]*fmar[w2+3] + fmar[w3+1]*fmar[w2+4] + fmar[w3+2]*fmar[w2+5];
    var c = fmar[w3+0]*fmar[w2+6] + fmar[w3+1]*fmar[w2+7] + fmar[w3+2]*fmar[w2+8];
    fmar[w1+0] = a;
    fmar[w1+1] = b;
    fmar[w1+2] = c;
}
function mul33(w1, w2,w3)
{
    fmar[w1+0] = fmar[w2+0]*fmar[w3+0];
    fmar[w1+1] = fmar[w2+1]*fmar[w3+1];
    fmar[w1+2] = fmar[w2+2]*fmar[w3+2];
}
function mul31(w, a)
{
    fmar[w] *= a; ++w;
    fmar[w] *= a; ++w;
    fmar[w] *= a; ++w;
}
function sum33(w1, w2,w3)
{
    fmar[w1+0] = fmar[w2+0]+fmar[w3+0];
    fmar[w1+1] = fmar[w2+1]+fmar[w3+1];
    fmar[w1+2] = fmar[w2+2]+fmar[w3+2];
}
function sum31(w, a)
{
    fmar[w] += a; ++w;
    fmar[w] += a; ++w;
    fmar[w] += a; ++w;
}
function sub33(w1, w2,w3)
{
    fmar[w1+0] = fmar[w2+0]-fmar[w3+0];
    fmar[w1+1] = fmar[w2+1]-fmar[w3+1];
    fmar[w1+2] = fmar[w2+2]-fmar[w3+2];
}
function dot33(w1,w2)
{
    return   fmar[w1+0] * fmar[w2+0]
           + fmar[w1+1] * fmar[w2+1]
           + fmar[w1+2] * fmar[w2+2];
}
function length3(w)
{
    return Math.sqrt(dot33(w,w));
}
function normalize3(w1,w2)
{
    var a = length3(w2);
    if(a<(1/65536)){a = 0;}
    else           {a = 1/a;}
    fmar[w1+0] = fmar[w2+0] * a;
    fmar[w1+1] = fmar[w2+1] * a;
    fmar[w1+2] = fmar[w2+2] * a;
}

//shaders
var vxSh0 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec3 vPos;
varying vec3 vNor;
void main()
{
    float vx = (vtx+.5)/mtx[3].z;
    float fx = fract(vx);
    vec4 p = texture2D(tex0,vec2(vx/mtx[0].w,.5));                  //ball position
    vec3 c = texture2D(tex1,vec2(fx*mtx[3].z/mtx[2].z,.1)).xyz;     //icosahedron mesh

    float a = 1.;
    if(fx > 960./1920.00)                                           //sticky
    {
        a = float(p.w>=512.)*(float(p.w>=512.+256.)+.75);
    }
    c *= a;

    vec3 s = c + p.xyz;

    vPos = s;
    vNor = c;

    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.);
}`;
var frSh0 =
`precision highp float;
uniform mat4 mtx;
varying vec3 vPos;
varying vec3 vNor;
FUN
void main()
{
    float t = mtx[1].w;
    float l = length(vNor);
    vec3 n = vNor/l;
    vec3 p;
    vec4 a = vec4(0);

    float b = .35;
    vec3 e0  = vec3( 0.000000,-1.000000, 0.00000);
    vec3 e1  = vec3( 0.723600,-0.447215, 0.52572);
    vec3 e2  = vec3(-0.276385,-0.447215, 0.85064);
    vec3 e3  = vec3(-0.894425,-0.447215, 0.00000);
    vec3 e4  = vec3(-0.276385,-0.447215,-0.85064);
    vec3 e5  = vec3( 0.723600,-0.447215,-0.52572);
    vec3 e6  = vec3( 0.276385, 0.447215, 0.85064);
    vec3 e7  = vec3(-0.723600, 0.447215, 0.52572);
    vec3 e8  = vec3(-0.723600, 0.447215,-0.52572);
    vec3 e9  = vec3( 0.276385, 0.447215,-0.85064);
    vec3 e10 = vec3( 0.894425, 0.447215, 0.00000);
    vec3 e11 = vec3( 0.000000, 1.000000, 0.00000);
    
    p = vPos;
    p += sdf(p,t)*e0;
    p += sdf(p,t)*e0;
    a += sdfCol(p,t)*max(dot(e0*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e1;
    p += sdf(p,t)*e1;
    a += sdfCol(p,t)*max(dot(e1*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e2;
    p += sdf(p,t)*e2;
    a += sdfCol(p,t)*max(dot(e2*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e3;
    p += sdf(p,t)*e3;
    a += sdfCol(p,t)*max(dot(e3*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e4;
    p += sdf(p,t)*e4;
    a += sdfCol(p,t)*max(dot(e4*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e5;
    p += sdf(p,t)*e5;
    a += sdfCol(p,t)*max(dot(e5*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e6;
    p += sdf(p,t)*e6;
    a += sdfCol(p,t)*max(dot(e6*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e7;
    p += sdf(p,t)*e7;
    a += sdfCol(p,t)*max(dot(e7*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e8;
    p += sdf(p,t)*e8;
    a += sdfCol(p,t)*max(dot(e8*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e9;
    p += sdf(p,t)*e9;
    a += sdfCol(p,t)*max(dot(e9*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e10;
    p += sdf(p,t)*e10;
    a += sdfCol(p,t)*max(dot(e10*b,n),0.);
    p = vPos;
    p += sdf(p,t)*e11;
    p += sdf(p,t)*e11;
    a += sdfCol(p,t)*max(dot(e11*b,n),0.);

    gl_FragColor = a+max(l-1.,0.);
}`;
var vxSh1 =
`precision highp float;
attribute float vtx;
//uniform mat4 mtx;
varying vec2 uv;
void main()
{
    vec4 s = vec4(-1.,1.,1.,1.);
    if(vtx == 1.){s.y =-3.;}
    if(vtx == 2.){s.x = 3.;}
    uv = s.xy;
    gl_Position = s*.5;
}`;
var frSh1 =
`#extension GL_EXT_frag_depth : enable
precision highp float;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec2 uv;
FUN
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    mat3 m;
    m[0] = normalize(cross(vEc[0].xyz,eyed));
    m[1] = cross(eyed,m[0]);
    m[2] = eyed;
    vec3 eyel = m*vec3(uv/mtx[2].xy,1.);
         eyel = normalize(eyel);

    float t = mtx[1].w;
    vec3  p = eyep;
    float d = 0.;
    for(int i = 0; i < 33; ++i)
    {
        d = abs(sdf(p,t)); if(d<.01){break;}
        p += d*eyel;
    }
	gl_FragColor = sdfCol(p,t);
    gl_FragDepthEXT = .5+.5/dot(p-eyep,eyed);
}`;
var vxSh2 =
`precision highp float;
attribute float vtx;
varying vec2 uv;
void main()
{
    vec4 a = vec4(-1.,1.,1.,1.);
    if(vtx == 0.){a.x = 3.;}
    if(vtx == 2.){a.y =-3.;}
    uv = a.xy*.5+.5;
    gl_Position = a*.5;
}`;
var frSh2 =
`precision highp float;
uniform sampler2D tex;
uniform mat4 mtx;
varying vec2 uv;
FUN
#define D (1./128.)
void main()
{
    vec4  t = texture2D(tex,uv);
    vec3  p = t.xyz;
    float time = mtx[1].w;
    float l = sdf(p,time);
    p = vec3(sdf(p+vec3(D,0.,0.),time),
             sdf(p+vec3(0.,D,0.),time),
             sdf(p+vec3(0.,0.,D),time))-l;
    float a = length(p);
    p = p/a;

    if(a<(1./8192.)){p = vec3(0);}
    gl_FragColor = vec4(p,l);
}`;
var vxSh3 =
`precision highp float;
attribute float vtx;
uniform mat4 mtx;
varying vec2 uv;
void main()
{
    vec4 s = vec4(0,-1,1,1);
    if(vtx == 0.){s.y = 2.   ;}
    if(vtx == 1.){s.x =-1.732;}
    if(vtx == 2.){s.x = 1.732;}
    uv = s.xy;
    gl_Position = s*vec4(.01*mtx[2].xy,1,1);
}`;
var frSh3 =
`precision highp float;
uniform mat4 mtx;
varying vec2 uv;
void main()
{
	gl_FragColor = vec4(1,1,1,sin(length(uv)*3.1415));
}`;
var vxSh4 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform sampler2D tex2;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec3 vPos;
varying vec3 vCen;
varying vec3 vCin;
void main()
{
    float x = (vtx+.5)/mtx[3].z;
    vec4 c = texture2D(tex1,vec2(fract(x)*mtx[3].z/mtx[2].z,.3));   //joint mesh
    vec4 b = texture2D(tex2,vec2(x/mtx[2].w,.5));                   //joint to what balls
    float b0 = dot(b.xy,vec2(1.,256.)*255.)+.5;
    float b1 = dot(b.zw,vec2(1.,256.)*255.)+.5;
    vec3 p0 = texture2D(tex0,vec2(b0/mtx[0].w,.5)).xyz;             //ball position
    vec3 p1 = texture2D(tex0,vec2(b1/mtx[0].w,.5)).xyz;             //ball position
    
    vec3 jdi = p0-p1;

    mat3 m;
    m[0] = normalize(vec3(jdi.z,0.,-jdi.x));
    m[1] = normalize(cross(jdi,m[0]));
    m[2] = jdi*.5;

    vec3 o = (p0+p1)*.5;
    vec3 s = m*c.xyz + o;

    vPos = s;
    vCen = m*(c.xyz*.9) + o;
    vCin = c.xyz*.2+.8;

    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.);
}`;
var frSh4 =
`precision highp float;
uniform mat4 mtx;
varying vec3 vPos;
varying vec3 vCen;
varying vec3 vCin;
FUN
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;
  //vec3 eyel = reflect(normalize(vPos-eyep),normalize(vPos-vCen));
    vec3 eyel = refract(normalize(vPos-eyep),normalize(vPos-vCen),.7);
  //vec3 eyel = normalize(vPos-vCen);
    float t = mtx[1].w;
    vec3  p = vPos;
    for(int i = 0; i < 8; ++i)
    {
        p += sdf(p,t)*eyel;
    }
	gl_FragColor = sdfCol(p,t)*vec4(vCin,0);
}`;
var vxSh5 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec4 vPos;
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    float x = (vtx+.5)/mtx[3].z;
    vec4 c  = texture2D(tex1,vec2(fract(x)*mtx[3].z/mtx[2].z,.3));      //joint mesh
    vec3 p0 = texture2D(tex0,vec2(mtx[3].x,.5)).xyz;                    //ball position
    vec3 p1 = eyed*16. + eyep;                                          //ball position
    
    vec3 jdi = p0-p1;

    mat3 m;
    m[0] = normalize(vec3(jdi.z,0.,-jdi.x));
    m[1] = normalize(cross(jdi,m[0]));
    m[2] = jdi*.5;

    vec3 s = m*c.xyz;
    vPos = .7-c*.5;
    s += (p0+p1)*.5;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.);
}`;
var frSh5 = 
`precision highp float;
//uniform mat4 mtx;
varying vec4 vPos;
void main()
{
	gl_FragColor = vPos;
}`;
var vxSh6 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform sampler2D tex2;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec4 vPos;
void main()
{
    float x = (vtx+.5)/mtx[3].z;
    float o = floor(mod(x,3.));
    vec4 c = texture2D(tex1,vec2(fract(x)*mtx[3].z/mtx[2].z,.6));       //rotor mesh
                                   x = floor(x*(1./3.));
    vec4 ba = texture2D(tex2,vec2((x+.25)/mtx[2].w,.5));                //rotor to what balls
    vec4 bb = texture2D(tex2,vec2((x+.75)/mtx[2].w,.5));                //rotor to what balls
    float b0 = dot(ba.xy,vec2(1.,256.)*255.)+.5;
    float b1 = dot(ba.zw,vec2(1.,256.)*255.)+.5;
    float b2 = dot(bb.xy,vec2(1.,256.)*255.)+.5;
    vec3 p0 = texture2D(tex0,vec2(b0/mtx[0].w,.5)).xyz;                 //ball position
    vec3 p1 = texture2D(tex0,vec2(b1/mtx[0].w,.5)).xyz;                 //ball position
    vec3 p2 = texture2D(tex0,vec2(b2/mtx[0].w,.5)).xyz;                 //ball position

         vec3 p = p0;
    if(o==1.){p = p1;}
    if(o==2.){p = p2;}
    
    vec3 cen = (p0+p1+p2)*(1./3.);
    vec3 jdi = p-cen;

    mat3 m;
    m[1] = normalize(cross(p1-p0,p2-p0));
    m[0] = normalize(cross(m[1],jdi));
    m[2] = jdi;

    vPos = dot(c,vec4(1,0,1,0))+abs(cos(3.+o*1.3+vec4(1,2,3,4)))*.3;
    vec3 s = m*c.xyz + cen;

    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.);
}`;
var frSh6 =
`precision highp float;
uniform mat4 mtx;
varying vec4 vPos;
void main()
{
	gl_FragColor = vPos;
}`;
var vxSh7 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec4 vPos;
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;
    vec3 cen = eyed*8. + eyep;

    float x = (vtx+.5)/mtx[3].z;
    float o = floor(mod(x,3.));
    vec4 c = texture2D(tex1,vec2(fract(x)*mtx[3].z/mtx[2].z,.6));       //rotor mesh
    float b0 = mtx[3].x;
    float b1 = mtx[3].y;
    vec3 p0 = texture2D(tex0,vec2(b0,.5)).xyz;                          //ball position
    vec3 p1 = texture2D(tex0,vec2(b1,.5)).xyz;                          //ball position
    if(b1<0.){p1 = cen + vec3(0.,1.,0.);}                               
    vec3 p2      = cen + vec3(0.,0.,1.);                                //ball position

         vec3 p = p0;
    if(o==1.){p = p1;}
    if(o==2.){p = p2;}
    
    cen = (p0+p1+p2)*(1./3.);
    vec3 jdi = p-cen;

    mat3 m;
    m[1] = normalize(cross(p1-p0,p2-p0));
    m[0] = normalize(cross(m[1],jdi));
    m[2] = jdi;

    vec3 s = m*c.xyz;
    vPos = vec4(s,0);
    s += cen;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.);
}`;
var frSh7 = frSh6;
var vxSh8 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec3 vPos;
varying vec3 vEye;
varying mat3 mMMm;
varying vec4 col;
FUN
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    float x = (vtx+.5)/mtx[3].z;
    float fx= fract(x);
    float f = floor(x);
    vec4 hd = texture2D(tex0,vec2((f+.25)/mtx[2].w,.5));            //heads direction
    vec4 hp = texture2D(tex0,vec2((f+.75)/mtx[2].w,.5));            //heads positions
    vec4 c  = texture2D(tex1,vec2(fx*mtx[3].z/mtx[2].z,.1))*3.;     //head mesh which is icosahedron
    float b = 1.-hp.w; b*=b;b*=b; b = sin((1.-b)*3.1415);
    c *= 1.+b;
    col = sdfCol((hp+c*.5).xyz,mtx[1].w)*vec4(1,1,1,0)*1.5+b*vec4(0,0,0,1);

    vec3 jdi = hd.xyz;

    mMMm[0] = normalize(cross(vEc[0].xyz,jdi));
    mMMm[1] = cross(jdi,mMMm[0]);
    mMMm[2] = jdi;

    vPos = c.xyz;
    vEye = eyep-hp.xyz;

    vec3 s = (c+hp).xyz;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.)*hd.w*float(fx < 960./1920.00);
}`;
var frSh8 =
`precision highp float;
uniform mat4 mtx;
varying vec3 vPos;
varying vec3 vEye;
varying mat3 mMMm;
varying vec4 col;
float objec(vec3 p)
{
    float s = 1./.7;
    p *= s;

    float pi = 3.141592653589;
    vec2 a = cos(mod(atan(p.z,p.x),pi*2./12.)-vec2(0,pi*.5))*length(p.xz);
    vec2 a2= cos(                  pi   /12. -vec2(0,pi*.5));
    vec3 b = vec3(a.x,p.y,a.y)-vec3(1,0,1)*a2.xyy*1.3;
    
    float c = length(b)-2.;

    b = p+vec3(0,1,0);
    a = cos(mod(atan(b.z,b.x),pi*2./6.)-vec2(0,pi*.5))*length(b.xz);
    a2= cos(                  pi   /6. -vec2(0,pi*.5))*5.;
    b = vec3(a.x,b.y,a.y)-vec3(1,0,1)*a2.xyy;
    
    c = max(c,length(b)-3.6);
    
    b = p-vec3(0,0,0);
    a = cos(mod(atan(b.z,b.x)-pi/6.,pi*2./6.)+pi/6.-vec2(0,pi*.5))*length(b.xz);
    a2= cos(                        pi*2./6.       -vec2(0,pi*.5))*5.;
    b = vec3(a.x,b.y,a.y)-vec3(1,0,1)*a2.xyy;
    
    c = max(c,-length(b)+3.4);
    
    b = p-vec3(0,1.8,0);
    a = cos(mod(atan(b.z,b.x),pi*2./6.)-vec2(0,pi*.5))*length(b.xz);
    a2= cos(                  pi   /6. -vec2(0,pi*.5))*2.9;
    b = vec3(a.x,b.y,a.y)-vec3(1,0,1)*a2.xyy;
    
    c = min(c,length(b)-.5);
    
    return c/s;
}
void main()
{
    vec3 eyep = mtx[1].xyz;
	vec3 ray  = normalize(vPos-vEye);

    float w = col.w; 
    float z = 1./(1.+w); 

    vec3  p = vPos;
    float l = 0.;
    for (int i = 0; i < 12; ++i)
    {
        l = objec(p*mMMm*z);
        p += l*ray;
    }
    if(l>.1){discard;}

    p = p*mMMm*z;

	gl_FragColor = col/length(p)*max(1.,w/(abs(p.y-1.2)));
}`;
var vxSh9 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec3 vPos;
varying vec3 vCen;
void main()
{
    float x  = (vtx+.5)/mtx[3].z;
    float fx = fract(x);
    vec4 p = texture2D(tex0,vec2(x/mtx[0].w,.5));             //ball position
    vec4 c = texture2D(tex1,vec2(fx*mtx[3].z/mtx[2].z,.1));   //icosahedron mesh

    vec3 s = c.xyz*(1.+1./32.) + p.xyz;

    vPos = s;
    vCen = p.xyz;

    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.)*float(p.w!=0. && fx < 960./1920.00);
}`;
var frSh9 =
`precision highp float;
uniform mat4 mtx;
varying vec3 vPos;
varying vec3 vCen;
void main()
{
	float a = length(vPos-vCen);
    if(a<1.){discard;}
	gl_FragColor = (a-1.)*32.*vec4(1.,1.,1.,1.);
}`;
var vxSh10 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex0;
uniform sampler2D tex1;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec3  vPos;
varying vec3  vCen;
varying float vChk;
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    float vx = (vtx+.5)/mtx[3].z;
    float fx = fract(vx);
    float fl = floor(vx);

    vChk = clamp(mtx[3].w-fl,0.,1.);                                //checkpoint animation

    float b = mtx[3].x;//+vChk*8.;                                  //checkpoint size

    float u = vx/mtx[2].w;
    vec3 p0 = texture2D(tex0,vec2(u            ,.25)).xyz;          //checkpoint position 1
    vec3 p1 = texture2D(tex0,vec2(u+1./mtx[2].w,.25)).xyz;          //checkpoint position 2
    vec3 d0 = texture2D(tex0,vec2(u            ,.75)).xyz;          //checkpoint spawn direction
         d0 = mix(d0,normalize(p1-p0),min(mtx[3].y,1.));
    if(fl==vEc[0].w){d0 = normalize(eyep-p0);}

    vec3 c = texture2D(tex1,vec2(fx*mtx[3].z/mtx[2].z,.8)).xyz;     //checkpoint mesh

    //if(dot(c,c)>.99 && vChk!=1.){p0 = mix(p0,vEc[1].xyz,vChk*vChk*vChk*vChk);}
    c*=b;

    mat3 m;
    m[0] = normalize(cross(vEc[0].xyz,d0));
    m[1] = cross(d0,m[0]);
    m[2] = d0;
    vec3 s = m*c+p0;

    vPos = s;
    vCen = p0;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0);
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1,1)*float(!(fx > 960./1344.00 && mtx[3].y==0. && fl!=0.))
                                                       *float(!                     (mtx[3].y==2. && fl==0.))
                                                       *float(!(fx >1008./1344.00 && fl!=vEc[0].w));
}`;
var frSh10 =
`precision highp float;
uniform mat4 mtx;
varying vec3  vPos;
varying vec3  vCen;
varying float vChk;
void main()
{
    vec3 eyep = mtx[1].xyz;
    float dv = 1./mtx[3].x;

    float e = 0.;//vChk*vChk*vChk;

    vec3 d3 = (vPos-vCen)*dv;

    float t = mtx[1].w*2.;
    vec3 v = d3*5.*(1.+e)+5.;
    vec3 a1 = sin(v + sin(v.zxy*vec3(1.23,1.41,1.77)+t*vec3(-.97, .68, .72)))*.1+.5;
    vec3 b1 = cos(v + sin(v.yzx*vec3(1.52,1.24,1.34)+t*vec3( .88,-.77,-.57)))*.1+.5;
    vec3 c1 = sin(v + cos(v.zxy*vec3(1.41,1.13,1.68)+t*vec3(-.79,-.86, .46)))*.1+.5;

    vec3 c = normalize(vCen-eyep);
    vec3 p = vPos-eyep;

    float g = vChk*8.;
          g = 1.-.8/pow(g,g-1.);

    float l  = length(dot(c,p)*c-p);
          l  = l*dv/(1.-e);
    float l2 = max(.7-l*l,0.);
        //l2 = pow(l2,g)*(1.-vChk);
          l2 = l2*max(1.-vChk*4.,0.);

    vec4 b = vec4(dot(a1,b1),dot(b1,c1),dot(a1,c1),1);

    vec4 f = b;//mix(vec4(1),b,l);
         f.w = l2;

    float d = dot(d3,d3);
    vec4 f2 = vec4(1,1,.6,d*2.);
    if(d<.9*.9){f = f2;}

    gl_FragColor = f;
}`;
var vxSh11 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec3 vPos;
varying vec3 vCen;
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    float vx = (vtx+.5)/mtx[3].z;
    float fx = fract(vx);

    float b = 8.;                                                  //arrow size

    vec3 p0 = eyep + eyed*b*2.;
    vec3 c = texture2D(tex,vec2(fx*mtx[3].z/mtx[2].z,.8)).xyz*b;   //checkpoint mesh
    vec3 s = c+p0;

    vPos = s;
    vCen = p0;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1,1);
}`;
var frSh11 =
`precision highp float;
uniform mat4 mtx;
varying vec3 vPos;
varying vec3 vCen;
void main()
{
    vec3 a = (vPos-vCen)*(1./8.);
    gl_FragColor = vec4(2,2,1,3)*dot(a,a)+vec4(.5,.5,.3,0);
}`;
var vxSh12 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex;
uniform mat4 mtx;
uniform mat4 vEc;
varying float vV;
void main()
{
    vV = vtx;
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    float u = (vtx+.5)/mtx[2].w;
    vec3 p0 = texture2D(tex,vec2(u,.25)).xyz;    //checkpoint position

    vec3 s = p0;
         s-= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0);
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1,1);
}`;
var frSh12 =
`precision highp float;
varying float vV;
void main()
{
    gl_FragColor = vec4(cos(vV*6.28318)*.5+.5);
}`;
var vxSh13 =
`precision highp float;
attribute float vtx;
uniform mat4 mtx;
void main()
{
    vec4 s = vec4(0,-1,1,1);
    if(vtx == 0.){s.y = 2.   ;}
    if(vtx == 1.){s.x =-1.732;}
    if(vtx == 2.){s.x = 1.732;}
    gl_Position = s*vec4(8.*mtx[2].xy,1,1);
}`;
var frSh13 =
`precision highp float;
uniform mat4 mtx;
void main()
{
    float a = abs(mtx[3].x);
          a = max(1.2-a*4.,0.);
	gl_FragColor = vec4(0,0,0,a*a);
}`;
var vxSh14 =
`precision highp float;
attribute float vtx;
uniform mat4 mtx;
varying vec2 uv;
void main()
{
    vec4 s = vec4(0,-1,1,1);
    if(vtx == 0.){s.y = 2.   ;}
    if(vtx == 1.){s.x =-1.732;}
    if(vtx == 2.){s.x = 1.732;}
    uv = s.xy;
    float e = 1.-abs(mtx[3].x);
          e = 1.-e*e;
    float d = e; if(mtx[3].x<0.){d = 1.;}
    vec2 a = +cos(mtx[1].w*+2.33+vec2(0.,1.5707)+6.)*.08
             +cos(mtx[1].w*-1.25+vec2(0.,1.5707)+9.)*.07
             +cos(mtx[1].w*+0.81+vec2(0.,1.5707)+3.)*.06
             +cos(mtx[1].w*-1.88+vec2(0.,1.5707)+0.)*.08;
    gl_Position = (s*vec4(d,d,1,1)+vec4(a,0,0))*vec4(.3*mtx[2].xy,1,1);
}`;
var frSh14 =
`precision highp float;
uniform mat4 mtx;
varying vec2 uv;
void main()
{
    if(dot(uv,uv)>=1.){discard;}
    float t = mtx[1].w;
    float e = abs(mtx[3].x);
    float d = max(0.,(length(uv)-.5)*2.);
          d = 1.-d;
    vec2 v = e*3.*uv/(abs(dot(uv,uv)-.25)+.25);
    vec2 a = sin(v + sin(v.yx*vec2(1.23,1.41)+t*vec2(-.97,.68)))*.22+.52;
    vec2 b = cos(v + sin(v.yx*vec2(1.52,1.24)+t*vec2(.88,-.77)))*.22+.52;
    vec2 c = sin(v + cos(v.yx*vec2(1.41,1.13)+t*vec2(-.79,-.86)))*.22+.52;
  
	gl_FragColor = vec4(dot(a,b),dot(b,c),dot(a,c),d*d*e);
}`;
var vxSh15 =
`precision highp float;
attribute float vtx;
uniform sampler2D tex;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec2  uv;
varying float vChk;
varying vec3 vP;
void main()
{
    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    float vx = (vtx+.5)*(1./3.);

    float fr = fract(mtx[3].w);                                     //checkpoint animation
    float fl = floor(mtx[3].w); 
    vChk = max(0.,mtx[3].w-vEc[0].w);

    float b = mtx[3].x;                                             //checkpoint size

    float u = (fl+.5)/mtx[2].w;
    vec3 p0 = texture2D(tex,vec2(u            ,.25)).xyz;           //checkpoint position 1
    vec3 p1 = texture2D(tex,vec2(u+1./mtx[2].w,.25)).xyz;           //checkpoint position 2
  //vec3 d0 = texture2D(tex,vec2(u            ,.75)).xyz;           //checkpoint spawn direction
  //     d0 = mix(d0,normalize(p1-p0),min(mtx[3].y,1.));

    float i1 = floor(vx+512.* fl    +1.);
    float i2 = floor(vx+512.*(fl+1.)+1.);
    vec3 r = fract(sin(i1)*vec3(44678.5754,35668.7654,53658.8254));  //random position in checkpoint
         r = normalize(r-.5);
    vec3 v = fract(sin(i2)*vec3(44678.5754,35668.7654,53658.8254));  //random position in checkpoint
         v = normalize(v-.5);

    float a = fr*2.-1.;
          a = a*a;
          a = 1.-a*a;
    p0 += r*b*(.9+a);
    p1 += v*b*.9;

    p0 = mix(p0,p1,(.5-.5*cos(fr*3.1415))*step(vChk,0.));
    vP = p0*.03;

    vec3 d0 = normalize(p0-eyep);

    vec3 c = vec3(0,-1,0);                                          //checkpoint particles
    float j = floor(fract(vx)*3.);
    if(j == 0.){c.y = 2.   ;}
    if(j == 1.){c.x =-1.732;}
    if(j == 2.){c.x = 1.732;}
    uv = c.xy;
    //c*=.5;                                                        //size of mini particle

    mat3 m;
    m[0] = normalize(cross(vEc[0].xyz,d0));
    m[1] = cross(d0,m[0]);
    m[2] = d0;
    vec3 s = m*c+p0;

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0);
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1,1);
}`;
var frSh15 =
`precision highp float;
uniform mat4 mtx;
varying vec2  uv;
varying float vChk;
varying vec3  vP;
void main()
{
    float a = length(uv);
    if(a>=1.){discard;}

    float t = mtx[1].w*2.;
    vec3 v = vP*9.;
    vec3 a1 = sin(v + sin(v.zxy*vec3(1.23,1.41,1.77)+t*vec3(-.97, .68, .72)))*.3+.5;
    vec3 b1 = cos(v + sin(v.yzx*vec3(1.52,1.24,1.34)+t*vec3( .88,-.77,-.57)))*.3+.5;
    vec3 c1 = sin(v + cos(v.zxy*vec3(1.41,1.13,1.68)+t*vec3(-.79,-.86, .46)))*.3+.5;

    gl_FragColor = vec4(dot(a1,b1),dot(b1,c1),dot(a1,c1),(1.-vChk)*.1/a-.1);
}`;
var vxSh16 =
`precision highp float;
attribute float vtx;
varying vec2 uv;
void main()
{
    vec4 a = vec4(-1.,1.,1.,1.);
    if(vtx == 0.){a.x = 3.;}
    if(vtx == 2.){a.y =-3.;}
    uv = a.xy*.5+.5;
    gl_Position = a*.5;
}`;
var frSh16 =
`precision highp float;
uniform mat4 mtx;
uniform sampler2D tex;
varying vec2 uv;
void main()
{
    vec2 u = uv*mtx[3].xy;
    vec2 d = 1./mtx[3].xy;
    const float z = 1.;
    float t = z*2.+1.;
          t = 1./(t*t-1.);
    vec4 b = texture2D(tex,uv);
    vec4 a = vec4(0);
    for(float i = -z; i<z+.5;++i){
    for(float j = -z; j<z+.5;++j){
      vec4 s = vec4(0);
      for(float i2 = -z; i2<z+.5;++i2){
      for(float j2 = -z; j2<z+.5;++j2){
      s += texture2D(tex,(u+vec2(i,j)+vec2(i2,j2))*d);
      }}
      if(s.x==0.){s.x = 1.;}
      if(s.y==0.){s.y = 1.;}
      if(s.z==0.){s.z = 1.;}
      if(s.w==0.){s.w = 1.;}
      s = b/s;
      s = mix(s,(1.-s)*t,min(texture2D(tex,(u+vec2(i,j))*d)+.2,1.));
      a += s*texture2D(tex,(u+vec2(i,j))*d);
    }}
    gl_FragColor = a;
}`;
var vxSh17 =
`precision highp float;
attribute float vtx;
varying vec2 uv;
void main()
{
    vec4 a = vec4(-1.,1.,1.,1.);
    if(vtx == 0.){a.x = 3.;}
    if(vtx == 2.){a.y =-3.;}
    uv = a.xy*.5+.5;
    gl_Position = a*.5;
}`;
var frSh17 =
`precision highp float;
uniform sampler2D tex;
varying vec2 uv;
void main()
{
    gl_FragColor = texture2D(tex,uv);
}`;
var vxSh18 =
`precision highp float;
attribute float vtx;
uniform mat4 mtx;
uniform mat4 vEc;
varying vec2 uv;
void main()
{
    vec3 s = vec3(0,-1,1);
    if(vtx == 0.){s.y = 2.   ;}
    if(vtx == 1.){s.x =-1.732;}
    if(vtx == 2.){s.x = 1.732;}
    uv = s.xy;

    vec3 eyed = mtx[0].xyz;
    vec3 eyep = mtx[1].xyz;

    mat3 m1 = mat3(1,0,0,
                   0, .7071,.7071,
                   0,-.7071,.7071);

    s = s*vec3(-16,16,16)*m1+vec3(107,2,-18);

    s -= eyep;
    vec3 m0 = normalize(cross(vEc[0].xyz,eyed));
    float xp = dot(s,m0            );
    float yp = dot(s,cross(eyed,m0));
    float zp = dot(s,eyed          );
    gl_Position = vec4(xp,yp,1.,zp)*vec4(mtx[2].xy,1.,1.);
}`;
var frSh18 =
`precision highp float;
uniform mat4 mtx;
varying vec2 uv;
void main()
{
    if(dot(uv,uv)>=1.){discard;}

    vec2 u =22.*uv;

    vec2 v;
    float a;

    v = vec2(abs(u.x-11.)-5.,u.y);
    v = max(abs(v)-1.,vec2(0));
    a = .2/abs(length(v)-1.);
    
    v = vec2(u.x-11.,abs(u.y-2.5)-2.5);
    v = max(abs(v)-1.,vec2(0));
    a+= .2/abs(length(v)-1.);
    
    v = max(abs(u+vec2(9,0))-vec2(8,1),vec2(0));
    a+= (sin(mtx[1].w*8.)*.2+.3)/abs(length(v)-1.);

    gl_FragColor = vec4(a-.1);
}`;


var alertEl1;
var alertEl2;
var alertEl = false; //showing or not alert
var showAlert = function(s)
{
    if(alertEl){return;}
    alertEl = true;
    alertEl1.style.display = hivi[1];
    alertEl2.style.display = hivi[1];
    alertEl2.innerHTML = s;
}
var hideAlert = function()
{
    alertEl = false;
    alertEl1.style.display = hivi[0];
    alertEl2.style.display = hivi[0];
}
function inimyAlert()
{
    var buI = null;
    buI = document.createElement("div");        alertEl1 = buI;
    buI.style.position = "fixed";
    buI.style.left  = "0px";
    buI.style.top   = "0px";
    buI.style.width = "100%";
    buI.style.height = "100%";
    buI.style.background = "rgba(100,100,100,0.5)";
    buI.style.zIndex = "3";
    buI.style.display = hivi[0];
    buI.onclick = hideAlert;
    document.body.appendChild(buI);

    buI = document.createElement("p");          alertEl2 = buI;
    buI.style.whiteSpace = "pre";
    //buI.style.wordWrap = "normal";
    buI.style.fontFamily = "inherit";
    buI.style.fontSize = "18px";
    buI.style.fontWeight = "bold";
    buI.style.position = "fixed";
    buI.style.left  = "25%";
    buI.style.top   = "25%";
    buI.style.width = "50%";
    buI.style.height = "50%";
    buI.style.resize = "none";
    buI.style.background = "rgb(255,255,255)";
    buI.style.color = "rgb(0,0,0)";
    buI.style.zIndex = "4";
    buI.style.display = hivi[0];
    buI.style.lineHeight = "100%";
    //buI.onclick = hideAlert;
    //buI.oninput = runEqu;
    //buI.value = frSh1fun;
    document.body.appendChild(buI);
}

var shdCompiL = new Array(3*16);//vecrtex and fragment shader compile list
var shdCompiN = 0;
function shaderCreator1(n, vectexShaderCode, fragmentShaderCode)
{
    var shader0 = gl.createShader(gl.VERTEX_SHADER);
    var shader1 = gl.createShader(gl.FRAGMENT_SHADER);
    var program = gl.createProgram();
    gl.shaderSource(shader0,   vectexShaderCode);
    gl.shaderSource(shader1, fragmentShaderCode);
    gl.compileShader(shader0);
    gl.compileShader(shader1);
    gl.attachShader(program, shader0);
    gl.attachShader(program, shader1);
    shdCompiL[shdCompiN] = shader0;  ++shdCompiN;
    shdCompiL[shdCompiN] = shader1;  ++shdCompiN;
    shdCompiL[shdCompiN] = program;  ++shdCompiN;
};
function shaderCreatorLink()
{
    for(var i = 2; i < shdCompiN; i+=3)
    {
        gl.linkProgram(shdCompiL[i]);
    }
};
function shaderCreator2(n)
{
    var shader0 = shdCompiL[shdCompiN];  ++shdCompiN;
    var shader1 = shdCompiL[shdCompiN];  ++shdCompiN;
    var program = shdCompiL[shdCompiN];  ++shdCompiN;
    //var s0 = gl.getShaderParameter(shader0, gl.COMPILE_STATUS);
    //var s1 = gl.getShaderParameter(shader1, gl.COMPILE_STATUS);
    //var s  = s0 && s1;
    var s = gl.getProgramParameter(program, gl.LINK_STATUS);
    if(!s)
    {
        //if(!s0){showAlert(gl.getShaderInfoLog(shader0));}
        //if(!s1){showAlert(gl.getShaderInfoLog(shader1));}
        //gl.getProgramInfoLog(program)+"\n"+
        showAlert(gl.getShaderInfoLog(shader0)+"\n"+
                  gl.getShaderInfoLog(shader1));
    }
    gl.detachShader(program, shader0);
    gl.detachShader(program, shader1);
    gl.deleteShader(shader0);
    gl.deleteShader(shader1);
    if(!s){gl.deleteProgram(program); program = null;}
    shdCompiL[n+0] = null;
    shdCompiL[n+1] = null;
    shdCompiL[n+2] = null;
    return program;
};
function grvtCompile(s)
{
    var d = s.replace(/[^0-9-.,]/g, '').split(',').map(parseFloat);
    for(var i = 0; i < d.length; ++i)
    {
        if(d.length != 8 || !isFinite(d[i]) || 
           d[i]>1 || d[i]<-1 ||
           (i<4 && d[i]!=0 && d[i]!=1)){showAlert("-GRAVITY- text data is incorrect"); return;}
    }
    nGair = (d[0] << 0) |
            (d[1] << 1) |
            (d[2] << 2) |
            (d[3] << 3) ;
    grty0  = d[4];
    grty1  = d[5];
    grty2  = d[6];
    grty3  = d[7];
    gyck0.checked = (nGair&(1<<0)) != 0;
    gyck1.checked = (nGair&(1<<1)) != 0;
    gyck2.checked = (nGair&(1<<2)) != 0;
    gyck3.checked = (nGair&(1<<3)) != 0;
}
function chckCompile(s,rsp)
{
    var d = s.replace(/[^0-9-.,]/g, '').split(',').map(parseFloat);
    for(var i = 0; i < d.length; ++i)
    {
        if(!isFinite(d[i])){showAlert("-CHECKPOINTS- text data is incorrect");return;}
    }
    if(d.length >= 2 && d[0]>=chckZm && d[1]>=0 && d[1]<=chckMx && Math.floor(d[1])-d[1] == 0 && d.length == d[1]*8+2)//legit numbers
    {
        var lgt = true;
        var l8 = d[1]<<3;
        for(var i = l8>>1; i < l8; i+=4)
        {
            var n0 = d[2+i+0];
            var n1 = d[2+i+1];
            var n2 = d[2+i+2];
            if(Math.abs(n0*n0 + n1*n1 + n2*n2-1)>.002){lgt = false; break;}
        }
        if(lgt)//legit checkpoint normals
        {
            chckA = 0;
            for(var i = 0; i < plyMx; ++i){chckP[i]=0;}
            for(var i = 0; i < plyMx; ++i){chckG[(i<<1)+0] = 0;
                                           chckG[(i<<1)+1] = 0;}

            chckGPUo = true;
            chckZ = d[0];
            chckN = d[1];    if(chckN==0){return;}
            var cn4 = chckN<<2;
            var r = 2;
            for(var i = 0; i < cn4; ++i){chckL[            i] = d[r]; ++r;}
            for(var i = 0; i < cn4; ++i){chckL[(chckMx<<2)+i] = d[r]; ++r;}

            var cd0 = chckL[0];
            var cd1 = chckL[1];
            var cd2 = chckL[2];
            var dd0 = chckL[(chckMx<<2)+0];
            var dd1 = chckL[(chckMx<<2)+1];
            var dd2 = chckL[(chckMx<<2)+2];
            var ddd = Math.sqrt(dd0*dd0 + dd1*dd1 + dd2*dd2);
                dd0 /= ddd;
                dd1 /= ddd;
                dd2 /= ddd;
            if(rsp)
            {
                var cmr = camN*plyMe;
                cam[cmr+0] = dd0;
                cam[cmr+1] = dd1;
                cam[cmr+2] = dd2;
                cam[cmr+3] = cd0-dd0*chckZ*2.5;
                cam[cmr+4] = cd1-dd1*chckZ*2.5;
                cam[cmr+5] = cd2-dd2*chckZ*2.5;
            }
        }
        else{showAlert("-CHECKPOINTS- text data is incorrect");}
    }   else{showAlert("-CHECKPOINTS- text data is incorrect");}
}
function chckOverwrite()
{
    var s = wrldEl.value;
        s =    s.split("----------------SHADERS----------------"); if(s.length!=2){return;}
        s = s[1].split("--------------CHECKPOINTS--------------"); if(s.length!=2){return;}
    var s0 = s[0];//shaders
        s = s[1].split("----------------GRAVITY----------------"); if(s.length!=2){return;}
    var s1 = s[0];//checkpoints
    var s2 = s[1];//gravity

    var cks = Math.ceil(chckZ)+","+chckN;
    var cn4 = chckN<<2;
    for(var i = 0; i < cn4; ++i)
    {
        var ind = chckL[i];
        cks += "," + ind.toFixed((ind-Math.floor(ind)!=0)*1);
    }
    for(var i = 0; i < cn4; ++i)
    {
        var ind = chckL[(chckMx<<2)+i];
        cks += "," + ind.toFixed((ind-Math.floor(ind)!=0)*3);
    }

    wrldEl.value = "----------------SHADERS----------------"  +s0+
                   "--------------CHECKPOINTS--------------\n"+cks+"\n\n"+
                   "----------------GRAVITY----------------"  +s2;
}
function wrldCompile(rsp)
{
    //extract shader from string
    var s = wrldEl.value;
        s =    s.split("----------------SHADERS----------------"); if(s.length!=2){showAlert("-SHADERS- text data is incorrect"    );return;}
        s = s[1].split("--------------CHECKPOINTS--------------"); if(s.length!=2){showAlert("-CHECKPOINTS- text data is incorrect");return;}
    var s0 = s[0];//shaders
        s = s[1].split("----------------GRAVITY----------------"); if(s.length!=2){showAlert("-GRAVITY- text data is incorrect"    );return;}
    var s1 = s[0];//checkpoints
    var s2 = s[1];//gravity
                   shdCompiN = 0;                                           
    shaderCreator1(shdCompiN, vxSh0, frSh0.replace("FUN",s0));
    shaderCreator1(shdCompiN, vxSh1, frSh1.replace("FUN",s0));
    shaderCreator1(shdCompiN, vxSh2, frSh2.replace("FUN",s0));
    shaderCreator1(shdCompiN, vxSh4, frSh4.replace("FUN",s0));
    shaderCreator1(shdCompiN, vxSh8.replace("FUN",s0), frSh8);
    shaderCreatorLink();
    chckCompile(s1,rsp);
    grvtCompile(s2);
                            shdCompiN = 0;
    var p0 = shaderCreator2(shdCompiN);
    var p1 = shaderCreator2(shdCompiN);
    var p2 = shaderCreator2(shdCompiN);
    var p4 = shaderCreator2(shdCompiN);
    var p8 = shaderCreator2(shdCompiN);
    if(p0!=null && p1!=null && p2!=null && p4!=null)
    {
        //gl.useProgram(null);
        gl.deleteProgram(shaderP0);    shaderP0 = p0;
        gl.deleteProgram(shaderP1);    shaderP1 = p1;
        gl.deleteProgram(shaderP2);    shaderP2 = p2;
        gl.deleteProgram(shaderP4);    shaderP4 = p4;
        gl.deleteProgram(shaderP8);    shaderP8 = p8;
    }else{return;}
    shdVtx0 = gl.getAttribLocation( shaderP0, "vtx");
    shdMtx0 = gl.getUniformLocation(shaderP0, "mtx");
    shdVec0 = gl.getUniformLocation(shaderP0, "vEc");
    shdTex00= gl.getUniformLocation(shaderP0, "tex0");
    shdTex01= gl.getUniformLocation(shaderP0, "tex1");

    shdVtx1 = gl.getAttribLocation( shaderP1, "vtx");
    shdMtx1 = gl.getUniformLocation(shaderP1, "mtx");
    shdVec1 = gl.getUniformLocation(shaderP1, "vEc");
    
    shdVtx2 = gl.getAttribLocation( shaderP2, "vtx");
    shdMtx2 = gl.getUniformLocation(shaderP2, "mtx");
    shdTex2 = gl.getUniformLocation(shaderP2, "tex");
    
    shdVtx4 = gl.getAttribLocation( shaderP4, "vtx");
    shdMtx4 = gl.getUniformLocation(shaderP4, "mtx");
    shdVec4 = gl.getUniformLocation(shaderP4, "vEc");
    shdTex40= gl.getUniformLocation(shaderP4, "tex0");
    shdTex41= gl.getUniformLocation(shaderP4, "tex1");
    shdTex42= gl.getUniformLocation(shaderP4, "tex2");

    shdVtx8 = gl.getAttribLocation( shaderP8, "vtx");
    shdMtx8 = gl.getUniformLocation(shaderP8, "mtx");
    shdVec8 = gl.getUniformLocation(shaderP8, "vEc");
    shdTex80= gl.getUniformLocation(shaderP8, "tex0");
    shdTex81= gl.getUniformLocation(shaderP8, "tex1");
};

//sumu
  var gl = null;
  var cnvs = null;
  var ext0;
  var ext1;
  var ext2;
  var texCreator;
  var tex0 ;
  var tex1 ;
  var tex2 ;
  var tex5 ;
  var tex6 ;
  var tex7 ;
  var tex11;
  var frameBuffCreator;
  var frb0;
  var frb1;
  var meshBuff;
  var shaderP0 ;
  var shaderP1 ;
  var shaderP2 ;
  var shaderP3 ;
  var shaderP4 ;
  var shaderP5 ;
  var shaderP6 ;
  var shaderP7 ;
  var shaderP8 ;
  var shaderP9 ;
  var shaderP10;
  var shaderP11;
  var shaderP12;
  var shaderP13;
  var shaderP14;
  var shaderP15;
  var shaderP16;
  var shaderP17;
  var shaderP18;
  var shdVtx0 ;
  var shdMtx0 ;
  var shdVec0 ;
  var shdTex00;
  var shdTex01;
  var shdVtx1 ;
  var shdMtx1 ;
  var shdVec1 ;
  var shdVtx2 ;
  var shdMtx2 ;
  var shdTex2 ;
  var shdVtx3 ;
  var shdMtx3 ;
  var shdVtx4 ;
  var shdMtx4 ;
  var shdVec4 ;
  var shdTex40;
  var shdTex41;
  var shdTex42;
  var shdVtx5 ;
  var shdMtx5 ;
  var shdVec5 ;
  var shdTex50;
  var shdTex51;
  var shdVtx6 ;
  var shdMtx6 ;
  var shdVec6 ;
  var shdTex60;
  var shdTex61;
  var shdTex62;
  var shdVtx7 ;
  var shdMtx7 ;
  var shdVec7 ;
  var shdTex70;
  var shdTex71;
  var shdVtx8 ;
  var shdMtx8 ;
  var shdVec8 ;
  var shdTex80;
  var shdTex81;
  var shdVtx9 ;
  var shdMtx9 ;
  var shdVec9 ;
  var shdTex90;
  var shdTex91;
  var shdVtx10 ;
  var shdMtx10 ;
  var shdVec10 ;
  var shdTex100;
  var shdTex101;
  var shdVtx11;
  var shdMtx11;
  var shdVec11;
  var shdTex11;
  var shdVtx12;
  var shdMtx12;
  var shdVec12;
  var shdTex12;
  var shdVtx13;
  var shdMtx13;
  var shdVtx14;
  var shdMtx14;
  var shdVtx15;
  var shdMtx15;
  var shdVec15;
  var shdTex15;
  var shdVtx16;
  var shdMtx16;
  var shdTex16;
  var shdVtx17;
  var shdTex17;
  var shdVtx18;
  var shdMtx18;
  var shdVec18;

function start()
{
    document.body.style.touchAction = "none";
    document.body.style.margin = "0px";
    document.body.style.fontFamily = "consolas,monospace";

    cnvs = document.createElement("canvas");
    cnvs.tabIndex = '1';
    //cnvs.style.zIndex = "0";
    cnvs.style.position = "absolute";
    cnvs.style.top    = "0px";
    cnvs.style.left   = "0px";
    cnvs.style.width  = "100%";
    cnvs.style.height = "100%";
    document.body.appendChild(cnvs);

    cnvs.addEventListener("mousedown",    mouseDown,   true);
    cnvs.addEventListener("mouseup",      mouseUp,     true);
    cnvs.addEventListener("mouseout",     mouseUp,     true);
    cnvs.addEventListener("mouseleave",   mouseUp,     true);
    cnvs.addEventListener("mousemove",    mouseMove,   true);
    cnvs.addEventListener("wheel",        mouseWheel,  true);
    cnvs.addEventListener("contextmenu",  event => event.preventDefault());
    cnvs.addEventListener("keydown",      keyDown,     true);
    cnvs.addEventListener("keyup",        keyUp,       true);
    document.addEventListener("pointerlockchange", pntLockChange, true);

    inimyAlert();

    icosaedronGen();
    jointGen();
    rotatorGen();
    checkpointGen();

    startWebGL();
    camRsz();
    window.onresize = camRsz;

    iniWorld();
    htmlConstruct();
    wrldCompile(true);

    spwnCode1();
    machEl2.value = machdef;
    spwnCode1();

    mainMenu();

    render();
}
function startWebGL()
{
    gl = cnvs.getContext("webgl",{ alpha:     false,
                                   antialias: false,
                                   depth:     true,
                                   stencil:   false,
                                   //desynchronized:     true,
                                   premultipliedAlpha: false,
                                   powerPreference: "high-performance",
                                   //preserveDrawingBuffer: false,
                                   //failIfMajorPerformanceCaveat: false
                                   });
    
    //console.log(gl.getSupportedExtensions());
    ext0 = gl.getExtension('OES_texture_float');
    ext1 = gl.getExtension('WEBGL_color_buffer_float');
    ext2 = gl.getExtension('EXT_frag_depth');
                   shdCompiN = 0;
  //shaderCreator1(shdCompiN, vxSh0, frSh0.replace("FUN",s0));
  //shaderCreator1(shdCompiN, vxSh1, frSh1.replace("FUN",s0));
  //shaderCreator1(shdCompiN, vxSh2, frSh2.replace("FUN",s0));
    shaderCreator1(shdCompiN, vxSh3, frSh3);                  
  //shaderCreator1(shdCompiN, vxSh4, frSh4.replace("FUN",s0));
    shaderCreator1(shdCompiN, vxSh5, frSh5);                  
    shaderCreator1(shdCompiN, vxSh6, frSh6);                  
    shaderCreator1(shdCompiN, vxSh7, frSh7);                  
  //shaderCreator1(shdCompiN, vxSh8.replace("FUN",s0), frSh8);                  
    shaderCreator1(shdCompiN, vxSh9, frSh9);                  
    shaderCreator1(shdCompiN, vxSh10,frSh10);
    shaderCreator1(shdCompiN, vxSh11,frSh11);
    shaderCreator1(shdCompiN, vxSh12,frSh12);
    shaderCreator1(shdCompiN, vxSh13,frSh13);
    shaderCreator1(shdCompiN, vxSh14,frSh14);
    shaderCreator1(shdCompiN, vxSh15,frSh15);
    shaderCreator1(shdCompiN, vxSh16,frSh16);
    shaderCreator1(shdCompiN, vxSh17,frSh17);
    shaderCreator1(shdCompiN, vxSh18,frSh18);
    shaderCreatorLink();

    gl.depthMask(true);
    gl.enable(gl.DEPTH_TEST);
  //gl.depthMask(false);
  //gl.disable(gl.DEPTH_TEST);
    gl.depthRange(0,1);
  //gl.depthFunc(gl.GEQUAL);
    gl.clearDepth(0.);
    gl.enable(gl.CULL_FACE);
    gl.cullFace(gl.BACK);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);//gl.ONE, gl.ONE);

    //textures
    texCreator = function(format, x, y, type, txf, data, txId)
    {
        gl.activeTexture(txId);   
        var tx = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, tx);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, txf);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, txf);
        gl.texImage2D(gl.TEXTURE_2D, 0, format, x, y, 0, format, type, data);
      //gl.texImage2D(target, level, internalformat, format, type, HTMLCanvasElement? pixels);
        return tx;
    }
    tex0 = texCreator(gl.RGBA,     bllMx,      1, gl.FLOAT,         gl.NEAREST,   null, gl.TEXTURE0);
    tex1 = texCreator(gl.RGBA,     bllMx,      1, gl.FLOAT,         gl.NEAREST,   null, gl.TEXTURE1);
    tex2 = texCreator(gl.RGBA,   meshXz3, meshYz, gl.FLOAT,         gl.NEAREST, meshXY, gl.TEXTURE2);
    tex5 = texCreator(gl.RGBA,    bJotMx,      1, gl.UNSIGNED_BYTE, gl.NEAREST,   null, gl.TEXTURE3);
    tex6 = texCreator(gl.RGBA, bRotMx<<1,      1, gl.UNSIGNED_BYTE, gl.NEAREST,   null, gl.TEXTURE4);
    tex7 = texCreator(gl.RGBA,  plyMx<<1,      1, gl.FLOAT,         gl.NEAREST,   null, gl.TEXTURE5);
    tex11= texCreator(gl.RGBA,    chckMx,      2, gl.FLOAT,         gl.NEAREST,   null, gl.TEXTURE6);
    
    gl.activeTexture(gl.TEXTURE0);

    //frameBuffers
    frameBuffCreator = function(texture)
    {
        var fb = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
        return fb;
    }
  //frb0 = frameBuffCreator(tex0);
    frb1 = frameBuffCreator(tex1);

    //mesh
    var d = new Float32Array(pxst);
    for(var i = 0; i < pxst; ++i){d[i] = i;}
    meshBuff = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, meshBuff);
    gl.bufferData(gl.ARRAY_BUFFER, d, gl.STATIC_DRAW);

    //end shader copilation
                               shdCompiN = 0;
    shaderP0  = null;//shaderCreator2(shdCompiN);
    shaderP1  = null;//shaderCreator2(shdCompiN);
    shaderP2  = null;//shaderCreator2(shdCompiN);
    shaderP3  =        shaderCreator2(shdCompiN);
    shaderP4  = null;//shaderCreator2(shdCompiN);
    shaderP5  =        shaderCreator2(shdCompiN);
    shaderP6  =        shaderCreator2(shdCompiN);
    shaderP7  =        shaderCreator2(shdCompiN);
    shaderP8  = null;//shaderCreator2(shdCompiN);
    shaderP9  =        shaderCreator2(shdCompiN);
    shaderP10 =        shaderCreator2(shdCompiN);
    shaderP11 =        shaderCreator2(shdCompiN);
    shaderP12 =        shaderCreator2(shdCompiN);
    shaderP13 =        shaderCreator2(shdCompiN);
    shaderP14 =        shaderCreator2(shdCompiN);
    shaderP15 =        shaderCreator2(shdCompiN);
    shaderP16 =        shaderCreator2(shdCompiN);
    shaderP17 =        shaderCreator2(shdCompiN);
    shaderP18 =        shaderCreator2(shdCompiN);

    shdVtx0 = null;//gl.getAttribLocation( shaderP0, "vtx");
    shdMtx0 = null;//gl.getUniformLocation(shaderP0, "mtx");
    shdVec0 = null;//gl.getUniformLocation(shaderP0, "vEc");
    shdTex00= null;//gl.getUniformLocation(shaderP0, "tex0");
    shdTex01= null;//gl.getUniformLocation(shaderP0, "tex1");
    
    shdVtx1 = null;//gl.getAttribLocation( shaderP1, "vtx");
    shdMtx1 = null;//gl.getUniformLocation(shaderP1, "mtx");
    shdVec1 = null;//gl.getUniformLocation(shaderP1, "vEc");
    
    shdVtx2 = null;//gl.getAttribLocation( shaderP2, "vtx");
    shdMtx2 = null;//gl.getUniformLocation(shaderP2, "mtx");
    shdTex2 = null;//gl.getUniformLocation(shaderP2, "tex");
    
    shdVtx3 = gl.getAttribLocation( shaderP3, "vtx");
    shdMtx3 = gl.getUniformLocation(shaderP3, "mtx");
    
    shdVtx4 = null;//gl.getAttribLocation( shaderP4, "vtx");
    shdMtx4 = null;//gl.getUniformLocation(shaderP4, "mtx");
    shdVec4 = null;//gl.getUniformLocation(shaderP4, "vEc");
    shdTex40= null;//gl.getUniformLocation(shaderP4, "tex0");
    shdTex41= null;//gl.getUniformLocation(shaderP4, "tex1");
    shdTex42= null;//gl.getUniformLocation(shaderP4, "tex2");
    
    shdVtx5 = gl.getAttribLocation( shaderP5, "vtx");
    shdMtx5 = gl.getUniformLocation(shaderP5, "mtx");
    shdVec5 = gl.getUniformLocation(shaderP5, "vEc");
    shdTex50= gl.getUniformLocation(shaderP5, "tex0");
    shdTex51= gl.getUniformLocation(shaderP5, "tex1");
    
    shdVtx6 = gl.getAttribLocation( shaderP6, "vtx");
    shdMtx6 = gl.getUniformLocation(shaderP6, "mtx");
    shdVec6 = gl.getUniformLocation(shaderP6, "vEc");
    shdTex60= gl.getUniformLocation(shaderP6, "tex0");
    shdTex61= gl.getUniformLocation(shaderP6, "tex1");
    shdTex62= gl.getUniformLocation(shaderP6, "tex2");
    
    shdVtx7 = gl.getAttribLocation( shaderP7, "vtx");
    shdMtx7 = gl.getUniformLocation(shaderP7, "mtx");
    shdVec7 = gl.getUniformLocation(shaderP7, "vEc");
    shdTex70= gl.getUniformLocation(shaderP7, "tex0");
    shdTex71= gl.getUniformLocation(shaderP7, "tex1");
    
    shdVtx8 = null;//gl.getAttribLocation( shaderP8, "vtx");
    shdMtx8 = null;//gl.getUniformLocation(shaderP8, "mtx");
    shdVec8 = null;//gl.getUniformLocation(shaderP8, "vEc");
    shdTex80= null;//gl.getUniformLocation(shaderP8, "tex0");
    shdTex81= null;//gl.getUniformLocation(shaderP8, "tex1");
    
    shdVtx9 = gl.getAttribLocation( shaderP9, "vtx");
    shdMtx9 = gl.getUniformLocation(shaderP9, "mtx");
    shdVec9 = gl.getUniformLocation(shaderP9, "vEc");
    shdTex90= gl.getUniformLocation(shaderP9, "tex0");
    shdTex91= gl.getUniformLocation(shaderP9, "tex1");

    shdVtx10 = gl.getAttribLocation( shaderP10, "vtx");
    shdMtx10 = gl.getUniformLocation(shaderP10, "mtx");
    shdVec10 = gl.getUniformLocation(shaderP10, "vEc");
    shdTex100= gl.getUniformLocation(shaderP10, "tex0");
    shdTex101= gl.getUniformLocation(shaderP10, "tex1");

    shdVtx11 = gl.getAttribLocation( shaderP11, "vtx");
    shdMtx11 = gl.getUniformLocation(shaderP11, "mtx");
    shdVec11 = gl.getUniformLocation(shaderP11, "vEc");
    shdTex11 = gl.getUniformLocation(shaderP11, "tex");

    shdVtx12 = gl.getAttribLocation( shaderP12, "vtx");
    shdMtx12 = gl.getUniformLocation(shaderP12, "mtx");
    shdVec12 = gl.getUniformLocation(shaderP12, "vEc");
    shdTex12 = gl.getUniformLocation(shaderP12, "tex");

    shdVtx13 = gl.getAttribLocation( shaderP13, "vtx");
    shdMtx13 = gl.getUniformLocation(shaderP13, "mtx");

    shdVtx14 = gl.getAttribLocation( shaderP14, "vtx");
    shdMtx14 = gl.getUniformLocation(shaderP14, "mtx");

    shdVtx15 = gl.getAttribLocation( shaderP15, "vtx");
    shdMtx15 = gl.getUniformLocation(shaderP15, "mtx");
    shdVec15 = gl.getUniformLocation(shaderP15, "vEc");
    shdTex15 = gl.getUniformLocation(shaderP15, "tex");

    shdVtx16 = gl.getAttribLocation( shaderP16, "vtx");
    shdMtx16 = gl.getUniformLocation(shaderP16, "mtx");
    shdTex16 = gl.getUniformLocation(shaderP16, "tex");

    shdVtx17 = gl.getAttribLocation( shaderP17, "vtx");
    shdTex17 = gl.getUniformLocation(shaderP17, "tex");

    shdVtx18 = gl.getAttribLocation( shaderP18, "vtx");
    shdMtx18 = gl.getUniformLocation(shaderP18, "mtx");
    shdVec18 = gl.getUniformLocation(shaderP18, "vEc");
}

var tblMain;
var tblMainB1;
var tblMainB2;
var nxtWB = 0;
function mainMenu()
{
    var tbl = document.createElement("table");  tblMain = tbl;
    //tbl.style.zIndex = "1";
    tbl.style.position = "fixed";
  //tbl.style.marginLeft  = "-50px";
  //tbl.style.marginTop = "-50px";
    tbl.style.top  = "0px";
    tbl.style.right = "0px";
    tbl.style.width  = "80px";
    tbl.style.height = "80px";
    //tbl.style.display = hivi[0];
    document.body.appendChild(tbl);

    var tr = document.createElement("tr");
    //tbl.appendChild(tr);

    var th = document.createElement("th");
    //tr.appendChild(th);

        var p = document.createElement("button");  tblMainB1 = p;
        //p.style.width  = "200px";
        //p.style.height = "200px";
        ////p.style.border = "32px solid "+mcol;
        //p.style.borderRadius = "100px";
        //p.style.background = "linear-gradient(to bottom, rgb(250,255,212) 5%, rgb(45,45,45) 100%)";
        //p.style.fontFamily = "inherit";
        //p.style.fontSize = "50px";
        //p.style.border = "0px";
        //p.style.opacity = "1";
        //p.style.transition = "all 1s ease-out";
        ////p.style.lineHeight = "200px";
        ////p.style.fontWeight = "bold";
        ////p.style.textShadow = "1px 1px #FFFFFF";
        ////p.style.color = "#000000";
        ////p.style.boxShadow = "0px 10px 10px 4px #555555";
        //p.onmouseup = function(e)
        //            {
        //                applyRezOpt();
//
        //                pMenu[plyMe] = 4;
        //                //tblMain.style.display = hivi[0]; done later in cam zoom out animation
        //                tblMainB1.style.opacity = "0";
        //                tblMainB2.style.opacity = "0";
        //                
        //                campainW = 0;
        //                var cmcm = null;
        //                try{cmcm = window.localStorage.getItem("campainWorld");}
        //                catch(errrr){}
        //                if(cmcm){campainW = parseInt(cmcm,10);}
        //                sdfO = campainL[campainW];
        //                wrldEl.value = sdf[sdfO];
//
        //                camWT = 1.999999;
        //                //wrldCompile(true);
        //                //strtrace();
//
        //                nxtWB = -1;
//
        //                cnvs.requestPointerLock();
        //            };
        //p.innerHTML = "&#128042;";
        ////th.appendChild(p);

    tr = document.createElement("tr");
    tbl.appendChild(tr);

    th = document.createElement("th");
    tr.appendChild(th);

        p = document.createElement("button");  tblMainB2 = p;
        p.style.width  = "80px";
        p.style.height = "80px";
        //p.style.border = "32px solid "+mcol;
        p.style.borderRadius = "40px";
        p.style.background = "linear-gradient(to bottom, rgb(180,180,180) 5%, rgb(45,45,45) 100%)";
        p.style.fontFamily = "inherit";
        p.style.fontSize = "40px";
        p.style.border = "0px";
        p.style.opacity = "1";
        p.style.transition = "all 1s ease-out";
        //p.style.lineHeight = "200px";
        //p.style.fontWeight = "bold";
        //p.style.textShadow = "1px 1px #FFFFFF";
        //p.style.color = "#000000";
        p.onmouseup = function()
                    {
                        applyRezOpt();

                        pMenu[plyMe] = 1;
                        tblMain.style.display = hivi[0];
                        tblMenu.style.display = hivi[1];
 
                        sdfO = 18;
                        wrldEl.value = sdf[sdfO];
                        sdfTxtID.value = sdfO;
                        wrldCompile(true);

                        drwOrb = 0;

                        //cnvs.requestPointerLock();
                    };
        p.innerHTML = "&#128296;";
        th.appendChild(p);

    //p = document.createElement("div");    campainEl = p;
    //p.style.position = "absolute";
    //p.style.marginLeft  = "50%";
    //p.style.top  = "-300px";
    //p.style.left  = "-100px";
    //p.style.width  = "200px";
    //p.style.height = "200px";
    ////p.style.border = "32px solid "+mcol;
    //p.style.borderRadius = "100px";
    //p.style.background = "linear-gradient(to bottom, rgb(250,255,212) 5%, rgb(45,45,45) 100%)";
    //p.style.fontFamily = "inherit";
    //p.style.fontSize = "50px";
    //p.style.lineHeight = "200px";
    //p.style.textAlign = "center";
    //p.style.fontWeight = "bold";
    //p.style.transition = "all 2s ease-out";
    ////p.style.transform = "rotate(0.5turn)";
    ////p.style.textShadow = "1px 1px #FFFFFF";
    ////p.style.color = "#000000";
    ////p.style.display = hivi[0];
    //p.onmouseup = function()
    //            {
    //                if(camWT!=0){return;}
    //                campainEl.style.transform = "translateY(0px)";
    //                
    //                ++campainW;  if(campainW==campainL.length){campainW=0;}
    //                if(sdfO==11){machS[plyMe] = 0;}
    //                sdfO = campainL[campainW];
    //                wrldEl.value = sdf[sdfO];
//
    //                camWT = 1.999999;
//
    //                try{window.localStorage.setItem("campainWorld", campainW.toString());}
    //                catch(errrr){}
//
    //                if((plyE&(1<<plyMe))!=0){escPss = kysW; inpKy = inpKy|(1<<7);}//stop posses
//
    //                helpBs = -1;
    //                //wrldCompile(true);
    //                //strtrace();
//
    //                if(sdfO==15){cam[camN*plyMe+8] = 88;}
    //                if(sdfO==13){cam[camN*plyMe+8] = 60;}
    //                if(sdfO==11){machS[plyMe] = 1;}
    //                if(sdfO== 2){machS[plyMe] = 3;}
    //                if(sdfO==12){machS[plyMe] = 3;}
    //                if(sdfO==13){machS[plyMe] = 3;}
//
    //                nxtWB = -1;
    //                
    //                cnvs.requestPointerLock();
    //            };
    //p.innerHTML = "&#128042;";
    ////document.body.appendChild(p);
}

var frstTime = true;
function saveStr1()//transform saveData to string
{
    var a = campainW.toString()+",";
    for(var i = 0; i < campainW; ++i)
    {
        a += lvlTim[i].toString()+",";
        a += lvlDed[i].toString()+",";
    }
    return a;
}
function saveStr2(str)//transform string to saveData
{
    var d = str.replace(/[^0-9-.,]/g, '').split(',');
                                      var r = 0;
         campainW = parseInt(d[r],10);  ++r;
    for(var i = 0; i < campainW; ++i)
    {
        lvlTim[i] = parseInt(d[r],10);  ++r;
        lvlDed[i] = parseInt(d[r],10);  ++r;
    }
}
function clickToNxtWrld()
{
    if(frstTime)
    {
        frstTime = false;

        campainW = 0;
        var cmcm = null;
        try{cmcm = window.localStorage.getItem("campainData");}
        catch(errrr){}
        if(cmcm){saveStr2(cmcm);}

        applyRezOpt();
        pMenu[plyMe] = 4;
        //tblMain.style.display = hivi[0]; done later in cam zoom out animation
        tblMainB1.style.opacity = "0";
        tblMainB2.style.opacity = "0";
    }
    else
    {
        ++campainW;  if(campainW==campainL.length){campainW=0;}
        try{window.localStorage.setItem("campainData", saveStr1());}
        catch(errrr){}

        if((plyE&(1<<plyMe))!=0){escPss = kysW; inpKy = inpKy|(1<<7);}//stop posses
    }

    sdfO = campainL[campainW];
    wrldEl.value = sdf[sdfO];

    if(sdfO==15){cam[camN*plyMe+8] = 88;}
    if(sdfO==13){cam[camN*plyMe+8] = 60;}

    var m = 0;
    if(sdfO==18){m = 0;}//18 learn
    if(sdfO==0 ){m = 0;}//0  galaxy
    if(sdfO==7 ){m = 1;}//7  holes
    if(sdfO==13){m = 3;}//13 bones
    if(sdfO==11){m = 1;}//11 candy
    if(sdfO==17){m = 1;}//17 roses
    if(sdfO==14){m = 2;}//14 trees
    if(sdfO==2 ){m = 3;}//2  fire
    if(sdfO==16){m = 1;}//16 pink
    if(sdfO==10){m = 2;}//10 steel
    if(sdfO==9 ){m = 0;}//9  triangl
    if(sdfO==12){m = 2;}//12 pyramids
    if(sdfO==3 ){m = 0;}//3  grey
    if(sdfO==8 ){m = 2;}//8  desert
    if(sdfO==1 ){m = 0;}//1  circus
    if(sdfO==15){m = 3;}//15 hallowen
    if(sdfO==4 ){m = 0;}//4  stairs
    machS[plyMe] = m;

    camWT = 1.999999;
    helpBs = -1;
}

var tblKey = null;
var thArr = new Array(6);
var thJot = null;
var thRot = null;
var mcol  = "rgb(66,66,77)";
var mcol2 = "rgb(66,66,66)";
var hivi = ["none",""];
var tblMenu = null;
var helpB  = null;
var helpBs = 0;
var helpBs2= 0;//record last helpBs
var changeMenu;
var grvaf;
var screnrsup;
var keyHovEnter;
var keyHovLeave;
var selectMachine;
var saveMachine;
var spwnCode1;
var adjtchcksz;
var strtrace;
var gyck0;
var gyck1;
var gyck2;
var gyck3;
var machEl1;
var machEl2;
function htmlConstruct()
{
    changeMenu = function(e)
    {
        var b = e.target.idi;
        if(b<=3||b==5){bSeln[plyMe] = 0; clearPlySel(plyMe);}
        var bb = pMenu[plyMe];//value before change
        pMenu[plyMe] = b;
        wrldTbl.style.display = hivi[(b==6)|0];
        machTbl.style.display = hivi[(b==5)|0]; if(b==5){rndrAllMch();}
        tblKey.style.display  = hivi[(b<=3)|0];
        for(var i = 0; i < thArr.length; ++i)
        {
            if(i+1==b){thArr[i].style.border = "4px solid white";}
            else      {thArr[i].style.border = "4px solid "+mcol;}
        }
        helpBs =-1;
      //if(b==4 && (chckBo&(1<<plyMe))!=0 && (plyE&(1<<plyMe))==0){helpBs = 1;}
        if(b==4){helpBs = 5;}
        if(b==5){helpBs = 3;}
        //stop posses
      //if(bb==4 && b!=4 && (plyE&(1<<plyMe))!=0){escPss = kysW; inpKy = inpKy|(1<<7);}//inpKy = inpKy&(~(1<<7));
    };

    var w = 0;
    var tbl = null;
    var buI = null;
    tbl = document.createElement("table");  tblMenu = tbl;
    //tbl.style.zIndex = "1";
    tbl.style.position = "relative";
    tbl.style.marginLeft  = "auto";
    tbl.style.marginRight = "auto";
    tbl.style.display = hivi[0];
    document.body.appendChild(tbl);

    var tr = document.createElement("tr");
    tbl.appendChild(tr);

    var th = document.createElement("th");      thArr[w] = th; ++w;
    th.style.width  = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
    th.idi = w;
    th.onclick = changeMenu;
    tr.appendChild(th);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "bar";
        buI.idi = w;
        buI.onclick = changeMenu;
        th.appendChild(buI);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.title = "length of bar";
        buI.innerHTML =              bJotl.toFixed(1);
        buI.idi = w;
        buI.onclick = changeMenu;
        buI.onwheel = function(e){   bJotl += ((e.deltaY<0)*2-1)*.1;
                                  if(bJotl       <  0     ){bJotl = 0;}
                                  if(bJotl/bJotMl>=(1<<16)){bJotl =(1<<16)*bJotMl;}
                                  e.target.innerHTML = bJotl.toFixed(1);};
        th.appendChild(buI);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.title = "force of bar";
        buI.innerHTML =              bJotf.toFixed(1);
        buI.idi = w;
        buI.onclick = changeMenu;
        buI.onwheel = function(e){   bJotf += ((e.deltaY<0)*2-1)*.1;
                                  if(bJotf       <  0     ){bJotf = 0;}
                                  if(bJotf/bJotMf>=(1<<16)){bJotf =(1<<16)*bJotMf;}
                                  e.target.innerHTML = bJotf.toFixed(1);};
        th.appendChild(buI);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.title = "speed of change of length of bar";
        buI.innerHTML =              bJote;
        buI.idi = w;
        buI.onclick = changeMenu;
        buI.onwheel = function(e){   bJote += (e.deltaY<0)*2-1;
                                  if(bJote< 0){bJote = 0;}
                                  if(bJote>15){bJote =15;}
                                  e.target.innerHTML = bJote;
                                 };
        th.appendChild(buI);

    th = document.createElement("th");    thArr[w] = th; ++w;
    th.style.width = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
    th.idi = w;
    th.onclick = changeMenu;
    tr.appendChild(th);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "rotor";
        buI.idi = w;
        buI.onclick = changeMenu;
        th.appendChild(buI);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.title = "force of rotation";
        buI.innerHTML = bRotf.toFixed(1);
        buI.idi = w;
        buI.onclick = changeMenu;
        buI.onwheel = function(e){   bRotf += ((e.deltaY<0)*2-1)*.1;
                                  if(bRotf       <  0     ){bRotf = 0;}
                                  if(bRotf/bRotMf>=(1<<16)){bRotf =(1<<16)*bRotMf;}
                                  e.target.innerHTML = bRotf.toFixed(1);};
        th.appendChild(buI);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.title = "reduce force as the velocity of rotation increases. 0 means no reduction of force";
        buI.innerHTML = bRotf.toFixed(1);
        buI.idi = w;
        buI.onclick = changeMenu;
        buI.onwheel = function(e){   bRott += ((e.deltaY<0)*2-1)*.1;
                                  if(bRott       <  0     ){bRott = 0;}
                                  if(bRott/bRotMt>=(1<<16)){bRott =(1<<16)*bRotMt;}
                                  e.target.innerHTML = bRott.toFixed(1);};
        th.appendChild(buI);
    th = document.createElement("th");    thArr[w] = th; ++w;
    th.style.width = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
    th.idi = w;
    th.onclick = changeMenu;
    tr.appendChild(th);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "sticky";
        buI.idi = w;
        buI.onclick = changeMenu;
        th.appendChild(buI);
    th = document.createElement("th");    thArr[w] = th; ++w;
    th.style.width = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
    th.idi = w;
    th.onclick = changeMenu;
    tr.appendChild(th);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "control";
        buI.idi = w;
        buI.onclick = changeMenu;
        th.appendChild(buI);
    th = document.createElement("th");    thArr[w] = th; ++w;
    th.style.width = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
    th.idi = w;
    th.onclick = changeMenu;
    tr.appendChild(th);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "machines";
        buI.idi = w;
        buI.onclick = changeMenu;
        th.appendChild(buI);
    th = document.createElement("th");    thArr[w] = th; ++w;
    th.style.width = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
    th.idi = w;
    th.onclick = changeMenu;
    tr.appendChild(th);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "worlds";
        buI.idi = w;
        buI.onclick = changeMenu;
        th.appendChild(buI);

    grvaf = function(e)
            {
                var a = 1<<e.target.idi;
                nGair = (nGair & (~a)) | (a*(e.target.checked|0));
                e.target.blur();

                //var a = nGair*255;   nGair = !nGair;
                //e.target.style.color = "rgb("+a+","+a+","+a+")";
            };
    th = document.createElement("th");
    th.style.width = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
  //th.onclick = grvaf;
    tr.appendChild(th);
        buI = document.createElement("p");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "gravity";
        //buI.onclick = grvaf;
        th.appendChild(buI);

        buI = document.createElement("input");
        buI.type = "checkbox";
        buI.checked = (nGair&(1<<0)) != 0;
        buI.idi = 0;
        buI.onchange = grvaf;
        buI.title = "down force";
        th.appendChild(buI);                    gyck0 = buI;

        buI = document.createElement("input");
        buI.type = "checkbox";
        buI.checked = (nGair&(1<<1)) != 0;
        buI.idi = 1;
        buI.onchange = grvaf;
        buI.title = "center force";
        th.appendChild(buI);                    gyck1 = buI;

        buI = document.createElement("input");
        buI.type = "checkbox";
        buI.checked = (nGair&(1<<2)) != 0;
        buI.idi = 2;
        buI.onchange = grvaf;
        buI.title = "signed distace field force";
        th.appendChild(buI);                    gyck2 = buI;

        buI = document.createElement("input");
        buI.type = "checkbox";
        buI.checked = (nGair&(1<<3)) != 0;
        buI.idi = 3;
        buI.onchange = grvaf;
        buI.title = "air friction force";
        th.appendChild(buI);                    gyck3 = buI;

    screnrsup = function(e)
                {
                    if(e.deltaY<0){resO *=   2;  if(resO>1   ){resO = 1   ;}}
                    if(e.deltaY>0){resO *= 1/2;  if(resO<1/32){resO = 1/32;}}
                    e.target.innerHTML = "resolution "+resO;
                    camRsz();

                    try{window.localStorage.setItem("resolution", resO.toFixed(5));}
                    catch(errrr){}
                };
    th = document.createElement("th");
    th.style.width = "100px";
    th.style.border = "4px solid "+mcol;
    th.style.borderRadius = "4px";
    th.style.background = mcol;
    th.onwheel = screnrsup;
    tr.appendChild(th);
        buI = document.createElement("p");   resE = buI;
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.margin = "0px";
        buI.style.width = "100px";
        buI.innerHTML = "resolution "+resO;
        //buI.onwheel = screnrsup;
        th.appendChild(buI);
    
    keyChng = function(e)
    {
        var mr = plyMe<<1;
        if(e != null)
        {
            var id = e.target.idi;
            var w0 = keySln&1;       ++keySln;
            var w1 = keySln&1;
            keySl[mr+w0] = id;
            if(keySl[mr+0] == keySl[mr+1])
            {
                keySl[mr+w1] = (id+1) % keyArZ;
            }
        }
        for(var i = 0; i < keyArZ; ++i)
        {
                 if(i==keySl[mr+0]){keyAr[i].style.border = "4px solid rgb(150,222,150)";}
            else if(i==keySl[mr+1]){keyAr[i].style.border = "4px solid rgb(150,150,222)";}
            else                   {keyAr[i].style.border = "4px solid rgb(150,150,150)";}
        }
    };
    keyHovEnter = function(e)
    {
                      var a = "";
        if((keySln&1)==0){a = "rgba(150,222,150)";}
        else             {a = "rgba(150,150,222)";}
        e.target.style.background = a;
    };
    keyHovLeave = function(e)
    {
        e.target.style.background = mcol2;
    };
    w = 0;

    tbl = document.createElement("table");  tblKey = tbl;
    //tbl.style.zIndex = "1";
    tbl.style.position = "relative";
    tbl.style.marginLeft  = "auto";
    tbl.style.marginRight = "auto";
    tbl.style.width  = "190px";
    tbl.style.display = hivi[0];
    document.body.appendChild(tbl);

    tr = document.createElement("tr");
    tbl.appendChild(tr);
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width  = "50px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "Q";
        th.colSpan = "2";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width = "50px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "W";
        th.colSpan = "2";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width = "50px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "E";
        th.colSpan = "2";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
    tr = document.createElement("tr");
    tbl.appendChild(tr);
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width  = "50px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "A";
        th.colSpan = "2";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width = "50px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "S";
        th.colSpan = "2";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width = "50px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "D";
        th.colSpan = "2";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
    tr = document.createElement("tr");
    
    tbl.appendChild(tr);
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width  = "150px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "SPACE";
        th.colSpan = "6";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
    tr = document.createElement("tr");
    tbl.appendChild(tr);
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width  = "75px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "+mouseX";
        th.colSpan = "3";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width = "75px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "-mouseX";
        th.colSpan = "3";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
    tr = document.createElement("tr");
    tbl.appendChild(tr);
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width  = "75px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "+mouseY";
        th.colSpan = "3";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
        th = document.createElement("th");
        th.style.fontFamily = "inherit";
        th.style.color = "white";
        //th.style.width = "75px";
        th.style.border = "4px solid rgb(100,100,100)";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;          th.idi = w;
        th.innerHTML = "-mouseY";
        th.colSpan = "3";
        th.onclick = keyChng;
        th.onmouseenter = keyHovEnter;
        th.onmouseleave = keyHovLeave;
        tr.appendChild(th);                                 keyAr[w] = th; ++w;
    tr = document.createElement("tr");
    tbl.appendChild(tr);
        th = document.createElement("th");
        th.style.height = "1px";
        th.style.border = "0px";
        th.style.margin = "0px";
        th.colSpan = "1";
        tr.appendChild(th);
        th = document.createElement("th");
        th.style.height = "1px";
        th.style.border = "0px";
        th.style.margin = "0px";
        th.colSpan = "1";
        tr.appendChild(th);
        th = document.createElement("th");
        th.style.height = "1px";
        th.style.border = "0px";
        th.style.margin = "0px";
        th.colSpan = "1";
        tr.appendChild(th);
        th = document.createElement("th");
        th.style.height = "1px";
        th.style.border = "0px";
        th.style.margin = "0px";
        th.colSpan = "1";
        tr.appendChild(th);
        th = document.createElement("th");
        th.style.height = "1px";
        th.style.border = "0px";
        th.style.margin = "0px";
        th.colSpan = "1";
        tr.appendChild(th);
        th = document.createElement("th");
        th.style.height = "1px";
        th.style.border = "0px";
        th.style.margin = "0px";
        th.colSpan = "1";
        tr.appendChild(th);

    keyChng(null);

    selectMachine = function(e)
    {
        machS[plyMe] = e.target.idi;
        for(var i = 0; i < machCnv.length; ++i)
        {
            if(i==machS[plyMe]){machCnv[i].style.border = "4px solid white";}
            else               {machCnv[i].style.border = "4px solid "+mcol2;}
        }
    };
    saveMachine = function(e)
    {
        if(bSeln[plyMe]<=1){return;}

        machS[plyMe] = e.target.idi;
        for(var i = 0; i < machCnv.length; ++i)
        {
            if(i==machS[plyMe]){machCnv[i].style.border = "4px solid white";}
            else               {machCnv[i].style.border = "4px solid "+mcol2;}
        }
        var r  = plyMe*bSelH;
        var wp = machS[plyMe];

        //balls mass center
        var ml0 = 0;
        var ml1 = 0;
        var ml2 = 0;

        var psb = 0;//machine ball to posses

        //save balls
        var w = wp*(mchBMx<<2);
        var wa = 0;
        for(var i = 0; i < bllMx; ++i)
        {
            if((bSel[r+(i>>5)] & (1<<(i&31)))!=0)
            {
                var i4 = i<<2;
                machB[w] = bllP[i4+0];  ++w;  ml0 += bllP[i4+0];
                machB[w] = bllP[i4+1];  ++w;  ml1 += bllP[i4+1];
                machB[w] = bllP[i4+2];  ++w;  ml2 += bllP[i4+2];
                machB[w] = bllP[i4+3];  ++w;
                machBi[i] = wa;
                if(i==camB[plyMe]){psb = wa;}
                ++wa;
            }
        }
        machBn[wp] = wa;

        var di = 1/wa;
        ml0 *= di;
        ml1 *= di;
        ml2 *= di;

        var dl = 0;//length of fardest ball from balls center

        w = wp*mchBMx*4;
        for(var i = 0; i < machBn[wp]; ++i)//center all balls
        {
            var i4 = i<<2;
            machB[w+0] = machB[w+0] - ml0;
            machB[w+1] = machB[w+1] - ml1;
            machB[w+2] = machB[w+2] - ml2;
            machB[w+3] = machB[w+3];        
            var dl2 = +machB[w+0]*machB[w+0] 
                      +machB[w+1]*machB[w+1]
                      +machB[w+2]*machB[w+2];
            if( dl2 >dl){dl = dl2;}     w+=4;
        }
        dl = Math.sqrt(dl);
        machL[wp] = dl;

        //save joints
        w = wp*mchJMx*bJotNe;
        wa = 0;
        for(var i = 0; i < bJotN; ++i)
        {
            var ir = i*bJotNe;
            var j0 = bJot[ir+0];
            var j1 = bJot[ir+1];
            if((bSel[r+(j0>>5)] & (1<<(j0&31)))!=0 &&
               (bSel[r+(j1>>5)] & (1<<(j1&31)))!=0 )
            {
                for(var j = 0; j < bJotNe; ++j)
                {
                        var a = bJot[ir+j];
                    if(j<2){a = machBi[a];}
                    machJ[w] = a;  ++w;
                }
                ++wa; if(wa==mchJMx){break;}
            }
        }
        machJn[wp] = wa;
        //save rotors
        w = wp*mchRMx*bRotNe;
        wa = 0;
        for(var i = 0; i < bRotN; ++i)
        {
            var ir = i*bRotNe;
            var j0 = bRot[ir+0];
            var j1 = bRot[ir+1];
            var j2 = bRot[ir+2];
            if((bSel[r+(j0>>5)] & (1<<(j0&31)))!=0 &&
               (bSel[r+(j1>>5)] & (1<<(j1&31)))!=0 &&
               (bSel[r+(j2>>5)] & (1<<(j2&31)))!=0 )
            {
                for(var j = 0; j < bRotNe; ++j)
                {
                        var a = bRot[ir+j];
                    if(j<3){a = machBi[a];}
                    machR[w] = a;  ++w;
                }
                ++wa; if(wa==mchRMx){break;}
            }
        }
        machRn[wp] = wa;

        machPs[wp] = psb;

        rndrAllMch();
    };
    //text with my machines
    spwnCode1 = function()
    {
        machElV = !machElV;
        machEl1.style.display = hivi[machElV|0];
        machEl2.style.display = hivi[machElV|0];
        if(machElV)//show machines text
        {
            var str = "each line defines one machine\n"+
                      "you can only overwrite your machines\n";

            for(var i = 0; i < plyMx*machMx; ++i)
            {
                if((i&(machMx-1))==0)
                {
                    var p = Math.floor(i/machMx);  //if((plyA&(1<<p))==0){continue;}
                    if(p==plyMe){str += "your"                            ;}
                    else        {str += "player"+String.fromCharCode(65+p);}
                    str += " machines\n";
                }
                //str += "    ";
                str = str+machBn[i] + ","
                         +machJn[i] + ","
                         +machRn[i] + ","
                         +machPs[i] + ",";
                var r = 0;
                r = i * mchBMx*4     ; for(var j = 0; j < machBn[i]*     4; ++j){str += machB[r+j].toFixed(2) + ",";}
                r = i * mchJMx*bJotNe; for(var j = 0; j < machJn[i]*bJotNe; ++j){str += machJ[r+j] + ",";}
                r = i * mchRMx*bRotNe; for(var j = 0; j < machRn[i]*bRotNe; ++j){str += machR[r+j] + ",";}
                str += ",\n";
            }
            machEl2.value = str;
        }
        else//read machines text
        {
            var dno = false; //at leas one machine was read loaded
            var a = machEl2.value.replace(/[^0-9-.,]/g, '').split(',,');
            if(a.length-1 == plyMx*machMx)
            {
            for(var m = 0; m <  plyMx; ++m){  if(m!=plyMe){continue;}
            for(var k = 0; k < machMx; ++k){
            
                var n = a[m*plyMx+k].split(',').map(parseFloat);
                for(var j = 0; j < n.length; ++j)
                {
                    if(!isFinite(n[j])){continue;}
                }
            
                //check machines are legit
                var b  = 0;
                var eB = n[b];  ++b;  if(eB > mchBMx || eB==0){continue;}
                var eJ = n[b];  ++b;  if(eJ > mchJMx         ){continue;}
                var eR = n[b];  ++b;  if(eR > mchRMx         ){continue;}
                var pS = n[b];  ++b;  if(pS < 0 || pS >= eB  ){continue;}
            
                if(4+eB*     4
                    +eJ*bJotNe
                    +eR*bRotNe != n.length){continue;}
            
                var ce0 = 0;
                var ce1 = 0;
                var ce2 = 0;
                var dl  = 0;
                for(var j = 0; j < eB; ++j)
                {
                    var ab0 = n[b+0];
                    var ab1 = n[b+1];
                    var ab2 = n[b+2];  var dl2 = ab0*ab0 + ab1*ab1 + ab2*ab2;
                                        if(dl2 > dl){dl = dl2;}
                    ce0 += ab0;
                    ce1 += ab1;
                    ce2 += ab2; b+=4;
                }
                if(ce0*ce0 + ce1*ce1 + ce2*ce2 > .1){continue;}//machine mass center at 0
                var o = false;
                for(var j = 0; j < eJ; ++j)
                {
                    var j0 = n[b+0];
                    var j1 = n[b+1]; b+=bJotNe;
                    if(j0>=eB ||
                       j1>=eB || j0==j1){o = true; break;}
                }
                if(o){continue;} o = false;
                for(var j = 0; j < eR; ++j)
                {
                    var j0 = n[b+0];
                    var j1 = n[b+1];
                    var j2 = n[b+2]; b+=bRotNe;
                    if(j0>=eB ||
                       j1>=eB ||
                       j2>=eB || j0==j1 || j0==j2 || j1==j2){o = true; break;}
                }
                if(o){continue;} o = false;
            
                dno = true;
                //rewrite my machines
                var rpi = m*machMx + k;    b = 0;
                machBn[rpi] = n[b];        ++b;  
                machJn[rpi] = n[b];        ++b;
                machRn[rpi] = n[b];        ++b;
                machPs[rpi] = n[b];        ++b;
                var r = 0;
                r = rpi * mchBMx*4     ; for(var j = 0; j < eB*     4; ++j){machB[r+j] = n[b]; ++b;}
                r = rpi * mchJMx*bJotNe; for(var j = 0; j < eJ*bJotNe; ++j){machJ[r+j] = n[b]; ++b;}
                r = rpi * mchRMx*bRotNe; for(var j = 0; j < eR*bRotNe; ++j){machR[r+j] = n[b]; ++b;}
                machL[rpi] = Math.sqrt(dl);
            }
            }
            if(dno)
            {
                var e        = new Object();
                    e.target = new Object();
                    e.target.idi = plyMe*machMx;
                selectMachine(e);
                rndrAllMch();
            }
            }


            //var a = machEl2.value.replace(/[^0-9-.,]/g, '').slice(0,-1).split(',').map(parseFloat);
            //var o = a.length == machBn.length+
            //                    machJn.length+
            //                    machRn.length+machB.length
            //                                 +machJ.length
            //                                 +machR.length;
            //for(var i = 0; i < a.length && o; ++i)
            //{
            //    if(isNaN(a[i])){o = false; break;}
            //}
            //if(o)//check machines are legit
            //{
            //    var rp = plyMe*machMx;
            //    var b = 3+mchBMx*     4
            //             +mchJMx*bJotNe
            //             +mchRMx*bRotNe;
            //        b*= rp;
            //    for(var i = 0; i < machMx && o; ++i)
            //    {
            //        var i4 = i<<2;
            //        var eB = a[b]; ++b;  if(eB>=mchBMx){o = false; break;}
            //        var eJ = a[b]; ++b;  if(eJ>=mchJMx){o = false; break;}
            //        var eR = a[b]; ++b;  if(eR>=mchRMx){o = false; break;}
            //        var ce0 = 0;
            //        var ce1 = 0;
            //        var ce2 = 0;
            //        for(var j = 0; j < eB; ++j)
            //        {
            //            ce0 += a[b+0];
            //            ce1 += a[b+1];
            //            ce2 += a[b+2]; b+=4;
            //        }                       b+=4*(mchBMx-eB);
            //        if(ce0*ce0 + ce1*ce1 + ce2*ce2 > .1){o = false; break;}//ball mass center at 0
            //        for(var j = 0; j < eJ; ++j)
            //        {
            //            var j0 = a[b+0];
            //            var j1 = a[b+1]; b+=bJotNe;
            //            if(j0>=eB ||
            //               j1>=eB || j0==j1){o = false; break;}
            //        }                    b+=bJotNe*(mchJMx-eJ);
            //        for(var j = 0; j < eR; ++j)
            //        {
            //            var j0 = a[b+0];
            //            var j1 = a[b+1];
            //            var j2 = a[b+2]; b+=bRotNe;
            //            if(j0>=eB ||
            //               j1>=eB ||
            //               j2>=eB || j0==j1 || j0==j2 || j1==j2){o = false; break;}
            //        }                    b+=bRotNe*(mchRMx-eR);
            //    }
            //}
            //if(o)//rewrite only my machines
            //{
            //    var rp = plyMe*machMx;
            //    var b = 3+mchBMx*     4
            //             +mchJMx*bJotNe
            //             +mchRMx*bRotNe;
            //        b*= rp;
            //    for(var i = 0; i < machMx; ++i)
            //    {
            //        var i4 = i<<2;
            //        var rpi = rp+i;
            //        machBn[rpi] = a[b]; ++b;  var eB = machBn[rpi]; var dl = 0;
            //        machJn[rpi] = a[b]; ++b;
            //        machRn[rpi] = a[b]; ++b;
            //        var r = 0;
            //        r = rpi * mchBMx*4     ; for(var j = 0; j < eB; ++j)
            //                                 {
            //                                     var ab0 = a[b]; ++b;
            //                                     var ab1 = a[b]; ++b;
            //                                     var ab2 = a[b]; ++b;
            //                                     var ab3 = a[b]; ++b;
            //                                     var rj4 = r+(j<<2);
            //                                     machB[rj4+0] = ab0;
            //                                     machB[rj4+1] = ab1;
            //                                     machB[rj4+2] = ab2;
            //                                     machB[rj4+3] = ab3;
            //                                     var dl2 = ab0*ab0 + ab1*ab1 + ab2*ab2;
            //                                     if( dl2 > dl){dl = dl2;}
            //                                 } b+=4*(mchBMx-eB);   machL[rpi] = Math.sqrt(dl);
            //        r = rpi * mchJMx*bJotNe; for(var j = 0; j < mchJMx*bJotNe; ++j){machJ[r+j] = a[b]; ++b;}
            //        r = rpi * mchRMx*bRotNe; for(var j = 0; j < mchRMx*bRotNe; ++j){machR[r+j] = a[b]; ++b;}
            //    }
            //    var e        = new Object();
            //        e.target = new Object();
            //        e.target.idi = rp;
            //    selectMachine(e);
            //    rndrAllMch();
            //}
        }
    };

    //machines table
    tbl = document.createElement("table");                  machTbl = tbl;
    tbl.style.position = "relative";
    tbl.style.marginLeft  = "auto";
    tbl.style.marginRight = "auto";
    tbl.style.display = hivi[0];
    document.body.appendChild(tbl);

        tr = document.createElement("tr");
        tbl.appendChild(tr);

        th = document.createElement("th");
        th.colSpan = machMx+1;
        tr.appendChild(th);

        buI = document.createElement("button");
        buI.style.fontFamily = "inherit";
        buI.style.color = "white";
        buI.style.background = "rgb(100,100,100)";
        buI.style.border = "4px solid rgb(100,100,100)";
        buI.style.margin = "0px";
        buI.style.width = "250px";
        buI.style.borderRadius = "4px";
        buI.innerHTML = "save or load machines from text";
        buI.onclick = spwnCode1;
        th.appendChild(buI);

            buI = document.createElement("div");        machEl1 = buI;
            buI.style.position = "fixed";
            buI.style.left  = "0px";
            buI.style.top   = "0px";
            buI.style.width = "100%";
            buI.style.height = "100%";
            buI.style.background = "rgba(100,100,100,0.5)";
            buI.style.zIndex = "1";
            buI.style.display = hivi[0];
            buI.onclick = spwnCode1;
            document.body.appendChild(buI);

            buI = document.createElement("textarea");   machEl2 = buI;
            buI.style.whiteSpace = "pre";
            buI.style.wordWrap = "normal";
            buI.style.fontFamily = "inherit";
            buI.style.fontSize = "18px";
            buI.style.fontWeight = "bold";
            buI.style.position = "fixed";
            buI.style.left = "5%";
            buI.style.top  = "5%";
            buI.style.width  = "90%";
            buI.style.height = "90%";
            buI.style.resize = "none";
            buI.style.background = "rgb(229,229,229)";
            buI.style.color = "rgb(0,0,0)";
            buI.style.zIndex = "2";
            buI.style.display = hivi[0];
            buI.style.lineHeight = "100%";
            buI.spellcheck = false;
            //buI.oninput = runEqu;
            //buI.value = frSh1fun;
            document.body.appendChild(buI);

    var wr = 0;
    for(var i = 0; i < plyMx; ++i)
    {
    tr = document.createElement("tr");
    tr.style.display = hivi[((plyA&(1<<i))!=0)|0];
    tbl.appendChild(tr);

                 var str  = "";
        if(i==plyMe){str += "your";}
        else        {str += "player"+String.fromCharCode(65+i);}
                     str += " machines";

        th = document.createElement("th");
      //th.style.fontFamily = "inherit";
        th.style.color = "white";
        th.style.width  = "170px";
        th.style.borderRadius = "4px";
        th.style.background = mcol2;
        th.innerHTML = str;
        tr.appendChild(th);

        for(var j = 0; j < machMx; ++j)
        {
        th = document.createElement("th");
      //th.style.fontFamily = "inherit";
      //th.style.color = "white";
        th.style.width  = machRz+8+"px";
      //th.style.borderRadius = "4px";
      //th.innerHTML = "Q";
      //th.colSpan = "2";
      //th.onclick = keyChng;
        tr.appendChild(th);
            machCnv[wr] = document.createElement("canvas");
          //machCnv[wr].style.position = "absolute";
          //machCnv[wr].style.display = "block";
            machCnv[wr].style.border = "4px solid "+mcol2;
            machCnv[wr].style.margin = "0px";
            machCnv[wr].style.width  = machRz+"px";
            machCnv[wr].style.height = machRz+"px";
            machCnv[wr].style.borderRadius = "4px";
            machCnv[wr].idi = wr;
            machCnv[wr].onclick = selectMachine;
            machCnv[wr].width  = machRz;
            machCnv[wr].height = machRz;
            th.appendChild(machCnv[wr]);

            machCnv2[wr] = machCnv[wr].getContext("2d");
            machCnv2[wr].fillStyle = 'rgba(100,100,100,1)';
            machCnv2[wr].fillRect(0,0, machRz,machRz);

            buI = document.createElement("button");
            buI.style.fontFamily = "inherit";
            buI.style.color = "white";
            buI.style.background = "rgb(100,100,100)";
            buI.style.border = "4px solid rgb(100,100,100)";
            buI.style.margin = "0px";
            buI.style.width = machRz+"px";
            buI.style.display = hivi[(i==plyMe)|0];
            buI.style.borderRadius = "4px";
            buI.innerHTML = "save here";
            buI.idi = wr;
            buI.onclick = saveMachine;
            th.appendChild(buI);

            ++wr;
        }
    }

    adjtchcksz = function()//adjust size of checkpoint to size of selected machine
    {
        chckZ = Math.ceil(machL[machS[plyMe]]);
    };
    strtrace = function()//start race
    {
        var mz = machL[machS[plyMe]];
        if(mz > chckZ){showAlert("machine size is bigger than checkpoint"); return;}
        if(chckN <= 1){showAlert("the race needs more checkpoints"       ); return;}

        var cmrr = camN*plyMe;
        camAt = 1;
        camA[0] = cam[cmrr+0];
        camA[1] = cam[cmrr+1];
        camA[2] = cam[cmrr+2];
        camA[3] = cam[cmrr+3];
        camA[4] = cam[cmrr+4];
        camA[5] = cam[cmrr+5];
        camA[6] = shdVec[0];
        camA[7] = shdVec[1];
        camA[8] = shdVec[2];

        for(var i = 0; i < plyMx; ++i){chckP[i]=0;}

        for(var i = 0; i < bllMx4;)
        {
            bllP[i] = (Math.random()*2-1)*2048;    ++i;
            bllP[i] = (Math.random()*2-1)*2048;    ++i;
            bllP[i] = (Math.random()*2-1)*2048;    ++i;
            bllP[i] =                        0;    ++i;
        }
        for(var i = 0; i < bllMx4; ++i){bllV[i] = 0;}

        bJotN = 0;
        bRotN = 0;

        var cd0 = chckL[0];
        var cd1 = chckL[1];
        var cd2 = chckL[2];
        var dd0 = chckL[(chckMx<<2)+0];
        var dd1 = chckL[(chckMx<<2)+1];
        var dd2 = chckL[(chckMx<<2)+2];
        vec3(2*3, dd0,
                  dd1,
                  dd2);
        vec3(0*3, dd2,
                  0,
                 -dd0);
        normalize3(0*3,0*3);
        cros3(1*3, 2*3, 0*3);

        //world up
        var uu0 = 0;
        var uu1 = 1;
        var uu2 = 0;
        if( (nGair&(1<<1))!=0 || (nGair&(1<<2))!=0 )//center gravity
        {
            var l = 1/Math.sqrt(cd0*cd0 + cd1*cd1 + cd2*cd2);
            uu0 = cd0*l;
            uu1 = cd1*l;
            uu2 = cd2*l;
        }

        var mi0 = 0;
        plyE = plyA;
        
        for(var i = 0; i < plyMx; ++i){chckLv[i] = chckLvO;}

        for(var i = 0; i < plyMx; ++i)
        {
            if((plyA&(1<<i))==0){continue;}

            var icb = (i*chckBn+0)*2;
            chckBM[icb+0] = mi0>>2;  var pa0 = mi0>>2;
            chckBM[icb+2] = bJotN;   var ja0 = bJotN*bJotNe; 
            chckBM[icb+4] = bRotN;   var ra0 = bRotN*bRotNe; 
            
            var wp = machS[i];          //selected machine

            var wg = 0;
            var w = wp*mchJMx*bJotNe;
            for(var j = 0; j < machJn[wp]; ++j)//add joints
            {
                var jr = bJotN*bJotNe;
                for(var k = 0; k < bJotNe; ++k)
                {
                        var a = machJ[w]; ++w;
                    if(k<2){a = a+(mi0>>2);}
                    bJot[jr+k] = a;
                }
                bJot[jr+4] = (bJot[jr+4]&(~(15<<8))) | (i<<8);
                ++bJotN;
            }
            wg = 0;
            w = wp*mchRMx*bRotNe;
            for(var j = 0; j < machRn[wp]; ++j)//add rotors
            {
                var jr = bRotN*bRotNe;
                for(var k = 0; k < bRotNe; ++k)
                {
                        var a = machR[w]; ++w;
                    if(k<3){a = a+(mi0>>2);}
                    bRot[jr+k] = a;
                }
                bRot[jr+5] = (bRot[jr+5]&(~(15<<8))) | (i<<8);
                ++bRotN;
            }

            bJotGPUo = true;
            bRotGPUo = true;

            camB[i] = (mi0>>2) + machPs[wp];
            chckBc1[i] = machPs[wp];

            w = wp*mchBMx*4;
            for(var j = 0; j < machBn[wp]; ++j)//add balls
            {
                vec3(9, machB[w+0],
                        machB[w+1],
                        machB[w+2]);
                mul93(9, 0,9);
                bllP[mi0+0] = fmar[9+0]+cd0;                 
                bllP[mi0+1] = fmar[9+1]+cd1;                 
                bllP[mi0+2] = fmar[9+2]+cd2;                 
                bllP[mi0+3] =(machB[w+3]&(~(15<<4))) | (i<<4);
                w  +=4;
                mi0+=4;
            }

            chckBM[icb+1] = (mi0>>2)-chckBM[icb+0];
            chckBM[icb+3] = bJotN   -chckBM[icb+2];  var ja1 = bJotN*bJotNe;
            chckBM[icb+5] = bRotN   -chckBM[icb+4];  var ra1 = bRotN*bRotNe;

            for(var k = ja0; k < ja1; ++k){chckBJ[k] = bJot[k]-pa0*((k%bJotNe)<=1);}
            for(var k = ra0; k < ra1; ++k){chckBR[k] = bRot[k]-pa0*((k%bRotNe)<=2);}

            //move player position and look
            var ud0 = dd0 - uu0*.5;
            var ud1 = dd1 - uu1*.5;
            var ud2 = dd2 - uu2*.5;
            var l = 1/Math.sqrt(ud0*ud0 + ud1*ud1 + ud2*ud2);
            ud0 *= l;
            ud1 *= l;
            ud2 *= l;

            var cmr = camN*i;
            cam[cmr+0] = ud0;
            cam[cmr+1] = ud1;
            cam[cmr+2] = ud2;
            //cam[cmr+3] = cd0-ud0*mz*2.5;
            //cam[cmr+4] = cd1-ud1*mz*2.5;
            //cam[cmr+5] = cd2-ud2*mz*2.5;
            cam[cmr+7] = 1/8;
            
            pMenu[i] = 4;
        }
        if(campainW==0)//add "learn to climb car"
        {
            for(var i = 0; i < 1; ++i)//add joints
            {
                var wp = 0;                        //selected machine
                var wg = 0;
                var w = wp*mchJMx*bJotNe;
                for(var j = 0; j < machJn[wp]; ++j)//add joints
                {
                    var jr = bJotN*bJotNe;
                    for(var k = 0; k < bJotNe; ++k)
                    {
                            var a = machJ[w]; ++w;
                        if(k<2){a = a+(mi0>>2);}
                        bJot[jr+k] = a;
                    }
                    bJot[jr+4] = (bJot[jr+4]&(~(15<<8))) | (0<<8);
                    ++bJotN;
                }
                wg = 0;
                w = wp*mchRMx*bRotNe;
                for(var j = 0; j < machRn[wp]; ++j)//add rotors
                {
                    var jr = bRotN*bRotNe;
                    for(var k = 0; k < bRotNe; ++k)
                    {
                            var a = machR[w]; ++w;
                        if(k<3){a = a+(mi0>>2);}
                        bRot[jr+k] = a;
                    }
                    bRot[jr+5] = (bRot[jr+5]&(~(15<<8))) | (0<<8);
                    var eiky0 = (bRot[jr+5]>>0)&15;
                    var eiky1 = (bRot[jr+5]>>4)&15;
                    if(eiky0== 3 || eiky1== 3 ||
                       eiky0== 5 || eiky1== 5){continue;}  //remove steering rotors
                    ++bRotN;
                }
                w = wp*mchBMx*4;
                for(var j = 0; j < machBn[wp]; ++j)//add balls
                {
                    bllP[mi0+0] = machB[w+0]+110+i*6;             
                    bllP[mi0+1] = machB[w+1]+6;                 
                    bllP[mi0+2] =-machB[w+2]+190+i*80;                 
                    bllP[mi0+3] =((machB[w+3]&(~(15<<4))) | (0<<4))^(1<<8);
                    w  +=4;
                    mi0+=4;
                }
            }
        }

        //fill revive data
        for(var i = 0; i <          mi0; ++i){chckBP[i] = bllP[i];}
      //for(var i = 0; i < bJotN*bJotNe; ++i){chckBJ[i] = bJot[i];}
      //for(var i = 0; i < bRotN*bRotNe; ++i){chckBR[i] = bRot[i];}
        chckBo = plyA;
        chckHk  = 0;
        chckHkJ = 0;
        chckHkR = 0;
        
        chckT2= 99999;
        chckT = (inpPs*kysPs*1.999999)|0;//2 seconds countdown
        //chckE.style.display = hivi[1];
      //chckE.innerHTML = (chckT/(inpPs*kysPs))|0;

        var e        = new Object();
            e.target = new Object();
            e.target.idi = 4;
            changeMenu(e);

        helpBs = -1;

        if(campainW==0){fdag = 1; inpKy = inpKy|(1<<6);}
    };
  //chckToClip = function()
  //{
  //    var cks = "--------------CHECKPOINTS--------------\n"+
  //              Math.ceil(chckZ)+","+chckN;
  //    var cn4 = chckN<<2;
  //    for(var i = 0; i < cn4; ++i)
  //    {
  //        var ind = chckL[i];
  //        cks += "," + ind.toFixed((ind-Math.floor(ind)!=0)*1);
  //    }
  //    for(var i = 0; i < cn4; ++i)
  //    {
  //        var ind = chckL[(chckMx<<2)+i];
  //        cks += "," + ind.toFixed((ind-Math.floor(ind)!=0)*3);
  //    }
  //    cks += "\n";
  //    navigator.clipboard.writeText(cks);
  //};

    //worlds editor
    tbl = document.createElement("table");                  wrldTbl = tbl;
    tbl.style.position = "relative";
    tbl.style.marginLeft  = "auto";
    tbl.style.marginRight = "auto";
    tbl.style.display = hivi[0];
    document.body.appendChild(tbl);

        tr = document.createElement("tr");
        tbl.appendChild(tr);

            th = document.createElement("th");
            tr.appendChild(th);
            buI = document.createElement("button");
            buI.style.fontFamily = "inherit";
            buI.style.color = "white";
            buI.style.background = "rgb(100,100,100)";
            buI.style.border = "4px solid rgb(100,100,100)";
            buI.style.margin = "0px";
            buI.style.width = "30px";
            buI.style.borderRadius = "4px";
            buI.innerHTML = "<";
            buI.onclick = function()
                          {
                              sdfO-=1;  if(sdfO<0){sdfO=0; return;}
                              wrldEl.value = sdf[sdfO];
                              sdfTxtID.value = sdfO;
                              //wrldCompile(true);
                          };
            th.appendChild(buI);

            th = document.createElement("th");
            tr.appendChild(th);
            buI = document.createElement("textarea");   sdfTxtID = buI;
            buI.style.whiteSpace = "pre";
            buI.style.wordWrap = "normal";
            buI.style.fontFamily = "inherit";
            buI.style.fontSize = "18px";
            buI.style.fontWeight = "bold";
            buI.style.width = "30px";
            buI.style.height = "20px";
            buI.style.resize = "none";
            buI.style.background = "rgb(229,229,229)";
            buI.style.color = "rgb(0,0,0)";
            buI.style.lineHeight = "100%";
            buI.spellcheck = false;
            buI.oninput = function(e)
                          {
                              var a = parseInt(e.target.value,10);
                              if(!isFinite(a)){return;}
                              if(a<0){a=0;}
                              if(a>=sdf.length){a=sdf.length-1;}
                              if(a==sdfO){return;}
                              sdfO = a;
                              wrldEl.value = sdf[sdfO];
                              e.target.value = sdfO;
                          };
            buI.value = sdfO;
            th.appendChild(buI);

            th = document.createElement("th");
            tr.appendChild(th);
            buI = document.createElement("button");
            buI.style.fontFamily = "inherit";
            buI.style.color = "white";
            buI.style.background = "rgb(100,100,100)";
            buI.style.border = "4px solid rgb(100,100,100)";
            buI.style.margin = "0px";
            buI.style.width = "30px";
            buI.style.borderRadius = "4px";
            buI.innerHTML = ">";
            buI.onclick = function()
                          {
                              sdfO+=1;  if(sdfO==sdf.length){sdfO=sdf.length-1;return;}
                              wrldEl.value = sdf[sdfO];
                              sdfTxtID.value = sdfO;
                              //wrldCompile(true);
                          };
            th.appendChild(buI);

            th = document.createElement("th");
            tr.appendChild(th);
            buI = document.createElement("button");
            buI.style.fontFamily = "inherit";
            buI.style.color = "white";
            buI.style.background = "rgb(100,100,100)";
            buI.style.border = "4px solid rgb(100,100,100)";
            buI.style.margin = "0px";
            buI.style.width = "120px";
            buI.style.borderRadius = "4px";
            buI.innerHTML = "compile [esc]";
            buI.onclick = function(){wrldCompile(false);};
            th.appendChild(buI);

          //th = document.createElement("th");
          //tr.appendChild(th);
          //buI = document.createElement("button");
          //buI.style.fontFamily = "inherit";
          //buI.style.color = "white";
          //buI.style.background = "rgb(100,100,100)";
          //buI.style.border = "4px solid rgb(100,100,100)";
          //buI.style.margin = "0px";
          //buI.style.width = "200px";
          //buI.style.borderRadius = "4px";
          //buI.innerHTML = "checkpoints to ClipBoard";
          //buI.onclick = chckToClip;
          //th.appendChild(buI);

            th = document.createElement("th");
            tr.appendChild(th);
            buI = document.createElement("button");
            buI.style.fontFamily = "inherit";
            buI.style.color = "white";
            buI.style.background = "rgb(100,100,100)";
            buI.style.border = "4px solid rgb(100,100,100)";
            buI.style.margin = "0px";
            buI.style.width = "110px";
            buI.style.borderRadius = "4px";
            buI.innerHTML = "camera info";
            buI.onclick = function()
                          {
                              var cmr = camN*plyMe;
                              var a = "camera position  "+cam[cmr+3].toFixed(1)+","+cam[cmr+4].toFixed(1)+","+cam[cmr+5].toFixed(1)+"\n"+
                                      "camera direction "+cam[cmr+0].toFixed(3)+","+cam[cmr+1].toFixed(3)+","+cam[cmr+2].toFixed(3);
                              showAlert(a);
                          };
            th.appendChild(buI);
            
            th = document.createElement("th");
            tr.appendChild(th);
            buI = document.createElement("button");
            buI.style.fontFamily = "inherit";
            buI.style.color = "white";
            buI.style.background = "rgb(100,100,100)";
            buI.style.border = "4px solid rgb(100,100,100)";
            buI.style.margin = "0px";
            buI.style.width = "160px";
            buI.style.borderRadius = "4px";
            buI.innerHTML = "resize checkpoints";
            buI.onclick = adjtchcksz;
            th.appendChild(buI);

            th = document.createElement("th");
            tr.appendChild(th);
            buI = document.createElement("button");
            buI.style.fontFamily = "inherit";
            buI.style.color = "white";
            buI.style.background = "rgb(100,100,100)";
            buI.style.border = "4px solid rgb(100,100,100)";
            buI.style.margin = "0px";
            buI.style.width = "100px";
            buI.style.borderRadius = "4px";
            buI.innerHTML = "start race";
            buI.onclick = function()
                          {
                              document.activeElement.blur();
                              cnvs.requestPointerLock();
                              strtrace();
                          };
            th.appendChild(buI);

        tr = document.createElement("tr");
        tbl.appendChild(tr);
        th = document.createElement("th");
        th.colSpan = 7;
        tr.appendChild(th);
            buI = document.createElement("textarea");   wrldEl = buI;
            buI.style.whiteSpace = "pre";
            buI.style.wordWrap = "normal";
            buI.style.fontFamily = "inherit";
            buI.style.fontSize = "18px";
            buI.style.fontWeight = "bold";
            //buI.style.position = "fixed";
            //buI.style.left  = "5%";
            //buI.style.top   = "5%";
            buI.style.width = "880px";
            buI.style.height = (window.innerHeight-200)+"px";
            //buI.style.resize = "none";
            buI.style.background = "rgb(229,229,229)";
            buI.style.color = "rgb(0,0,0)";
            buI.style.lineHeight = "100%";
            buI.spellcheck = false;
            //buI.oninput = runEqu;
            buI.value = sdf[sdfO];
            th.appendChild(buI);

    chckE = document.createElement("div");
    chckE.style.position = "absolute";
    chckE.style.top  = "50%";
    chckE.style.left = "50%";
    chckE.style.transform = "translateX(-50%) translateY(-50%)";
  //chckE.style.width = "160px";
  //chckE.style.borderRadius = "4px";
    chckE.style.border = "0px";
    chckE.style.margin = "0px";
    chckE.style.background = "rgba(0,0,0,0)";
    chckE.style.fontFamily = "inherit";
    chckE.style.color = "white";
    chckE.style.textShadow = "0px 2px #000000";
    chckE.style.fontSize = "128px";
    chckE.style.pointerEvents = "none";
    chckE.style.display = hivi[0];
  //chckE.innerHTML = "5";
    //document.body.appendChild(chckE);

    helpB = document.createElement("div");
    helpB.style.position = "absolute";
    helpB.style.top  = "40%";
    helpB.style.left = "50%";
    helpB.style.transform = "translateX(-50%) translateY(-50%)";
  //helpB.style.width = "160px";
    helpB.style.borderRadius = "4px";
    helpB.style.border = "0px";
    helpB.style.margin = "0px";
    helpB.style.background = "rgba(0,0,0,0)";
    helpB.style.fontFamily = "inherit";
    helpB.style.whiteSpace = "pre";
    helpB.style.wordWrap = "normal";
    helpB.style.fontWeight = "bold";
    helpB.style.color = "white";
    helpB.style.textShadow = "0px 2px #000000";
    helpB.style.fontSize = "22px";
    helpB.style.pointerEvents = "none";
    helpB.style.display = hivi[0];
  //helpB.innerHTML = "5";
    document.body.appendChild(helpB);
}

var inpXd = 0;
var inpYd = 0;
//var inpX  = 0;
//var inpY  = 0;
var inpWeel = 0;
var fucus = 0;
var inpKy = 0;
var escPss = 0;//process of geting out of posses when pressing escape
var pntLockChange = function()
{
    fucus = (document.pointerLockElement === cnvs)*1;
    if(fucus!=0){cnvs.focus();}
    //if(fucus==0 && (plyE&(1<<plyMe))!=0){escPss = kysW; inpKy = inpKy|(1<<7);}//inpKy = inpKy&(~(1<<7));
    if(fucus==0 && campainW>=0 && chckP[plyMe]!=chckN){helpBs = 6;}
    if(fucus!=0 && helpBs2==6){helpBs = -1;}

    var a = ((fucus+1)&1)!=0;
    var b = pMenu[plyMe];
    wrldTbl.style.display = hivi[( b==6             &&a)|0];
    machTbl.style.display = hivi[( b==5             &&a)|0];
    tblKey.style.display  = hivi[((b==1||b==2||b==3)&&a)|0];

    if(b==6&&a){chckOverwrite();}
    if(b==5&&a){   rndrAllMch();}

    if(fucus!=0 && drwOrb!=0){drwOrb = -1;   clickToNxtWrld();}
    if(fucus!=0 && endGe !=0){hideEndGame(); clickToNxtWrld();}
};
var mouseDown = function(e)
{
    e.preventDefault();

    if(fucus==0){cnvs.requestPointerLock(); return;}
    
    var b = e.button;
    if(b==0 && campainW<0){inpKy = inpKy|(1<<7);}
    //if(b==2) mosP[1] = 1;
};
var mouseUp = function(e)
{
    e.preventDefault();
    
    var b = e.button;
    if(b==0){inpKy = inpKy&(~(1<<7));}
    //if(b==2) {mosP[1] = 0; holdI = false;}
};
var mouseMove = function(e)
{
    //var m = Math.min(scrX,scrY)/resO;
    var m = fucus/Math.min(window.innerWidth,
                           window.innerHeight);
    //var x = e.clientX/m;
    //var y = e.clientY/m;
    //var dx = ;//x-inpX;
    //var dy = ;//y-inpY;
    inpXd -= e.movementX*m;
    inpYd -= e.movementY*m;
    //inpX = x;
    //inpY = y;
};
var mouseWheel = function(e)
{
    e.preventDefault();

    if(e.deltaY>0){inpWeel+=1;}
    if(e.deltaY<0){inpWeel-=1;}
};

var keyDown = function(e)
{
    //e.preventDefault();
    var m = pMenu[plyMe];
    var k = inpKy;
    switch(e.code)
    {
        case "KeyQ":       k = k|(1<<0);  break;
        case "KeyW":       k = k|(1<<1);  break;
        case "KeyE":       k = k|(1<<2);  break;
        case "KeyA":       k = k|(1<<3);  break;
        case "KeyS":       k = k|(1<<4);  break;
        case "KeyD":       k = k|(1<<5);  break;
        case "Space":      k = k|(1<<6);  break;

        case "ArrowUp":    k = k|(1<<1);  break;
        case "ArrowLeft":  k = k|(1<<3);  break;
        case "ArrowDown":  k = k|(1<<4);  break;
        case "ArrowRight": k = k|(1<<5);  break;

        case "Numpad7":    k = k|(1<<0);  break;
        case "Numpad8":    k = k|(1<<1);  break;
        case "Numpad9":    k = k|(1<<2);  break;
        case "Numpad4":    k = k|(1<<3);  break;
        case "Numpad5":    k = k|(1<<4);  break;
        case "Numpad6":    k = k|(1<<5);  break;

        case "Enter":      if(m==4){campainRspw = 1;}     break;
        case "Escape":     if(m==6){wrldCompile(false);}  break;

        //case "KeyF":    prntB();               break;
    }

    if(!(fucus==0 && (m==5||m==6))){inpKy = k;}
};
var keyUp   = function(e)
{
    //e.preventDefault();
    var m = pMenu[plyMe];
    var k = inpKy;
    switch(e.code)
    {
        case "KeyQ":       k = k&(~(1<<0));  break;
        case "KeyW":       k = k&(~(1<<1));  break;
        case "KeyE":       k = k&(~(1<<2));  break;
        case "KeyA":       k = k&(~(1<<3));  break;
        case "KeyS":       k = k&(~(1<<4));  break;
        case "KeyD":       k = k&(~(1<<5));  break;
        case "Space":      k = k&(~(1<<6));  break;

        case "ArrowUp":    k = k&(~(1<<1));  break;
        case "ArrowLeft":  k = k&(~(1<<3));  break;
        case "ArrowDown":  k = k&(~(1<<4));  break;
        case "ArrowRight": k = k&(~(1<<5));  break;

        case "Numpad7":    k = k&(~(1<<0));  break;
        case "Numpad8":    k = k&(~(1<<1));  break;
        case "Numpad9":    k = k&(~(1<<2));  break;
        case "Numpad4":    k = k&(~(1<<3));  break;
        case "Numpad5":    k = k&(~(1<<4));  break;
        case "Numpad6":    k = k&(~(1<<5));  break;

        case "Enter":      if(m==4){campainRspw = 0;}  break;
    }
    if(!(fucus==0 && (m==5||m==6))){inpKy = k;}
};

function prntB()
{
    var a = "";
    for(var i = 0; i < 87*4;)
    {
        a += bllP[i].toFixed(1)+","; ++i;
        a += bllP[i].toFixed(1)+","; ++i;
        a += bllP[i].toFixed(1)+","; ++i; ++i;
    }
    console.log(a);
}

var scrX = 1;
var scrY = 1;

var bllMx  = 512;
var bllMx4 = bllMx<<2;
var bll3D = 256;                //side of 3D space, must be power of 2
var bll3D2= bll3D*bll3D;        //size of 3D space slice
var bll3D3= bll3D*bll3D*bll3D;  //size of 3D space 
var bll3Dk= (bll3D-1)|0;        //mask
var bigp  = 1<<16;              //avoid negative float to int error 

var nGair = 1<<0;               //0bit=downGravity 1bit=centerGravity 2bit=sdfGravity 3bit=airfriction
var grty0  = -.0049;            //gravity force
var grty1  = -.0049;
var grty2  = -.0049;
var grty3  = .9;

var resE = 0;                   //html element resolution
var resO = 1;                   //value        resolution
function applyRezOpt()
{
    //console.log(timD2);

    var cmcm = null;
    try{cmcm = window.localStorage.getItem("resolution");}
    catch(errrr){}
    if(cmcm){resO = parseFloat(cmcm);}

    else{if(timD2>34){resO = .5;}}
    resE.innerHTML = "resolution "+resO;
    camRsz();
}

var plyMx = 4;                  //max    players
var plyA = 1;                   //player exist
var plyE = 0;                   //player possess
var plyMe = 0;                  //which player am i

var inpPs = 60;                         //inputs per second
var kysPs = 3;                          //every input is how many phys steps
var kysT = 64*8;                        //keys time buffer size, must be power of 2
var kysW = 0;                           //write location
var kysR = 0;                           //read  location
var kys  = new Uint32Array(plyMx*kysT); //10keyboard 11mouseX 11mouseY = 32bit

var camN = 9;                               //camera variables
var cam   = new Float32Array(plyMx*camN);   //3dir 3pos 1speedRot 1speedMov 1possesDistance = 11float
var camTx = new Float32Array(plyMx<<3);     //3dir 1nothing 3pos 1nothing for uploading texture
var camB  = new Uint16Array(plyMx);         //ballID to possess
var camHl = .2;                             //ratio distance-height of camera when in poses mode
var camA  = new Float32Array(9);            //my camera smooth transition from places 3dir 3pos 3up
var camAt = 0;                              //animation time
var camWT = 0;                              //campaing world transition animation

var prj0 = 1;   //camera projection
var prj1 = 1.4;

var timP =                 0;  //time of physics
var timW = performance.now();  //time in game
var timD = 0;                  //time between frames
var timD2= 0;                  //close to average

var shdMtx = new Float32Array(16);
var shdVec = new Float32Array(16);
var pxst = 1<<20;                       //pixels location  in meshbuffer
var bllP = new Float32Array(bllMx4);    //balls position
var bllV = new Float32Array(bllMx4);    //balls velocity
var bllS = new Uint16Array(bll3D3);     //3D space with balls ID
var bll0 = new Float32Array(bllMx4);    //general calculations
var pi = 3.1415926535897932384626433832795;

var bJotMx = bllMx<<2;
var bJotN  = 0;
var bJotNe = 5;                             //number of variables for each joint 2ballID 1length 1force 1keyactiv
var bJot   = new Uint16Array(bJotMx*bJotNe);//list of joints
var bJotGPU= new Uint8Array( bJotMx<<2);    //used to update gpu
var bJotl  = 4;                             //new joint length
var bJotf  = 2;                             //new joint force
var bJote  = 0;                             //new joint length change sensitivity
var bJotMl = 32/(1<<16);                    //32=max length of joint, use to encode length in 16bits
var bJotMf = 4 /(1<<16);                    // 4=max force  of joint, use to encode force  in 16bits
var bJotD  = new Uint16Array(plyMx*2);      //desintegrate joint, infects neighbor joints by ping-pong
var bJotDN = 0;                             //number of desintegrators, 2per desintegrator
var bJotDe = 65535;                         //desintegrator deleted
var bJotGPUo = false;                       //update joints to GPU

var bRotMx = bllMx;
var bRotN  = 0;
var bRotNe = 6;                             //3ballID 1force 1velozReduce 1key
var bRot   = new Uint16Array(bRotMx*bRotNe);//list of rotors
var bRotS  = new Uint16Array(plyMx*4);      //list of ballsID to construct rotor, 3ballID 1nothing
var bRotGPU= new Uint8Array( bRotMx<<3);    //used to update gpu
var bRotf  = 2;                             //new rotor force
var bRotMf = 8/(1<<16);                     //8=max force, use to encode force in 16bits
var bRott  = 2;                             //new rotor reducter, reduce force as velocity increases
var bRotMt = 9/(1<<16);                     //8=max reducter, use to encode force in 16bits
var bRotGPUo = false;                       //update rotors to GPU

//done in bllP 3rd place
//var bStk = new Uint8Array(bllMx);//list of stiky balls, 6bit=key 1bit=enabledState 1bit=ballHas

var bSelH   = bllMx>>5;                                     //bllMx/8bit
var bSel    = new Uint32Array(plyMx*bSelH);                 //selected balls by bit per player
var bSeln   = new Uint16Array(plyMx);                       //how many selected balls
var bSelMe  = new Uint16Array(4);                           //for rendering only for me
var bSelG   = new Uint16Array(4);                           //for general calculations
var bSelGPU = new Uint8Array(Math.max(bJotMx*4,bRotMx*8));  //for general uploading to GPU
var pMenu   = new Uint8Array(plyMx);                        //menu 0=nothing 1=joint 2=rotor 3=stiky 4=control 5=machine

var keyArZ = 11;
var keyAr = new Array(keyArZ);
var keySl  = new Uint16Array(plyMx<<1);
var keySln = 0;
var keyChng = null;

var bllGi = new Int16Array(plyMx);   //grabbed ball id
var bllGd = new Float32Array(plyMx); //grabbed ball distance

var rndu = 0|0;

var machMx = 4;           //max machines per player
var mchBMx =  bllMx/plyMx;//max balls    per machine
var mchJMx = bJotMx/plyMx;//max joints   per machine
var mchRMx = bRotMx/plyMx;//max rotors   per machine
var machBn = new Uint16Array(plyMx*machMx);//number of balls  of machine
var machJn = new Uint16Array(plyMx*machMx);//number of joints of machine
var machRn = new Uint16Array(plyMx*machMx);//number of rotors of machine
var machPs = new Uint16Array(plyMx*machMx);//machine ball to posses
var machB = new Float32Array(plyMx*machMx * mchBMx *4     );//balls  library
var machJ = new Uint16Array( plyMx*machMx * mchJMx *bJotNe);//joints library
var machR = new Uint16Array( plyMx*machMx * mchRMx *bRotNe);//rotors library
var machL = new Float32Array(plyMx*machMx);//length from camera to machine for library
var machL2= new Float32Array(plyMx);       //length from camera to machine for adding in world by player
var machS = new Uint8Array(plyMx); //selected which player machine
var machTbl = null;//view machines
var machCnv = new Array(plyMx*machMx);
var machCnv2= new Array(plyMx*machMx);
var machRz = 128;
var machBi = new Uint16Array(bllMx);//for selection calculations
var machAdd = new Uint8Array(plyMx);//0=nothing 1=showonly 2=add
var machAd = 0;//which location in bllP to start adding machine
var machElV = false;//visible or hidden my machines in text
var machdef = //my default machines
`
your machines
88,309,8,16,0.30,3.48,-8.84,518.00,-4.55,-0.16,-8.00,0.00,-7.41,3.67,-9.43,774.00,-7.67,-0.70,-4.14,774.00,-7.53,-0.76,-11.95,774.00,0.00,0.72,-1.05,0.00,-1.17,2.58,-1.95,0.00,-1.29,-1.05,0.03,0.00,-1.97,0.17,-2.14,0.00,0.09,0.94,-3.13,0.00,2.15,0.06,-2.02,0.00,1.44,2.53,-1.89,0.00,0.03,-1.36,-2.14,0.00,-2.00,1.33,0.15,0.00,2.05,1.25,0.23,0.00,1.24,-1.11,0.06,0.00,0.06,2.78,0.27,0.00,-0.05,0.46,3.48,0.00,0.03,0.59,1.10,0.00,1.98,1.05,4.54,0.00,1.29,2.24,2.46,0.00,-1.29,2.31,2.38,0.00,-2.13,1.15,4.45,0.00,-2.15,-0.11,2.21,0.00,-0.03,2.58,4.54,0.00,2.04,-0.24,2.35,0.00,-1.41,-1.34,4.37,0.00,-0.13,0.36,5.61,0.00,-0.08,-1.64,2.15,0.00,0.11,1.03,-5.42,0.00,-1.86,0.52,-6.45,0.00,1.15,-1.39,4.43,0.00,1.30,-0.76,-4.30,0.00,0.11,-0.99,-6.53,0.00,0.21,1.25,-7.71,0.00,1.47,2.83,-6.15,0.00,-1.02,2.90,-6.21,0.00,1.86,-0.37,6.64,0.00,2.24,0.42,-6.36,0.00,-0.18,0.29,8.02,0.00,-2.18,-0.27,6.54,0.00,-1.19,-0.77,-4.32,0.00,0.17,3.07,-3.99,0.00,1.13,2.04,6.71,0.00,-0.19,-1.81,6.55,0.00,2.17,1.57,-4.07,0.00,-1.88,1.65,-4.18,0.00,-1.36,2.12,6.67,0.00,7.85,-3.48,-5.06,774.00,7.98,-1.28,-11.57,774.00,10.55,-1.44,8.26,0.00,7.99,3.20,-9.12,774.00,7.88,-4.47,-7.59,774.00,7.93,-3.59,-10.16,774.00,8.00,1.40,-11.16,774.00,4.49,-1.36,8.15,0.00,7.59,2.53,7.80,774.00,7.56,-3.74,5.00,774.00,7.86,-1.10,-3.77,774.00,7.95,3.26,-6.41,774.00,7.90,1.57,-4.30,774.00,7.61,-1.13,4.25,774.00,10.95,-0.53,-7.63,0.00,7.43,-3.02,11.84,774.00,-7.56,1.97,-4.63,774.00,7.53,1.88,10.43,774.00,7.47,-0.31,12.03,774.00,7.44,-4.97,9.95,774.00,4.89,-0.46,-7.73,0.00,7.49,-5.25,7.25,774.00,-7.65,-3.11,-10.58,774.00,-7.47,3.70,-6.72,774.00,7.62,1.35,5.36,774.00,-7.73,-4.02,-8.02,774.00,-7.81,2.66,6.42,774.00,-4.94,-1.15,7.90,0.00,-8.14,-1.72,11.69,774.00,-7.79,0.91,4.34,774.00,-7.85,-1.76,3.88,774.00,-8.16,-4.08,10.34,774.00,-7.91,2.68,9.12,774.00,-11.00,-0.96,7.66,0.00,-7.97,-4.10,5.25,774.00,-8.09,-5.01,7.80,774.00,-8.04,0.94,11.20,774.00,-10.60,0.07,-8.10,0.00,-7.44,1.91,-11.50,774.00,-7.74,-3.06,-5.48,774.00,5,6,5119,32768,83,23,28,5119,32768,83,23,26,5119,32768,83,29,33,5119,32768,83,27,37,5119,32768,83,35,68,10239,32768,32,34,68,10239,32768,32,1,41,10239,32768,32,1,33,10239,32768,83,22,23,5119,32768,83,1,46,10239,32768,32,1,36,10239,32768,32,19,55,10239,32768,32,22,26,5119,32768,83,43,55,10239,32768,32,31,55,10239,32768,32,44,55,10239,32768,83,39,55,10239,32768,32,26,75,10239,32768,32,29,32,5119,32768,83,39,75,10239,32768,32,47,75,10239,32768,32,22,75,10239,32768,32,29,30,5119,32768,83,30,33,5119,32768,83,29,36,5119,32768,83,29,46,5119,32768,83,30,41,5119,32768,83,41,46,5119,32768,83,33,41,5119,32768,83,15,25,5119,32768,83,34,36,5119,32768,83,29,35,5119,32768,83,36,46,5119,32768,83,32,45,5119,32768,83,29,45,5119,32768,83,42,45,5119,32768,83,35,45,5119,32768,83,29,41,5119,32768,83,6,8,5119,32768,83,35,36,5119,32768,83,29,42,5119,32768,83,42,46,5119,32768,83,33,34,5119,32768,83,6,13,5119,32768,83,5,14,5119,32768,83,5,13,5119,32768,83,9,12,5119,32768,83,5,9,5119,32768,83,6,9,5119,32768,83,5,8,5119,32768,83,5,7,5119,32768,83,34,38,5119,32768,83,7,12,5119,32768,83,5,12,5119,32768,83,7,13,5119,32768,83,8,13,5119,32768,83,8,9,5119,32768,83,30,46,5119,32768,83,30,36,5119,32768,83,38,45,5119,32768,83,34,35,5119,32768,83,13,16,5119,32768,83,33,38,5119,32768,83,24,27,5119,32768,83,29,34,5119,32768,83,30,34,5119,32768,83,36,42,5119,32768,83,7,8,5119,32768,83,35,42,5119,32768,83,7,23,5119,32768,83,28,31,5119,32768,83,31,37,5119,32768,83,14,20,5119,32768,83,16,20,5119,32768,83,13,21,5119,32768,83,13,23,5119,32768,83,17,31,5119,32768,83,14,25,5119,32768,83,9,11,5119,32768,83,8,46,5119,32768,83,11,16,5119,32768,83,24,47,5119,32768,83,6,46,5119,32768,83,25,31,5119,32768,83,22,47,5119,32768,83,26,27,5119,32768,83,15,28,5119,32768,83,6,42,5119,32768,83,27,47,5119,32768,83,19,31,5119,32768,83,22,27,5119,32768,83,26,44,5119,32768,83,8,41,5119,32768,83,7,28,5119,32768,83,33,68,10239,32768,83,26,28,5119,32768,83,16,21,5119,32768,83,26,31,5119,32768,83,9,29,5119,32768,83,27,31,5119,32768,83,11,45,5119,32768,83,5,18,5119,32768,83,11,42,5119,32768,83,10,45,5119,32768,83,27,40,5119,32768,83,22,40,5119,32768,83,10,32,5119,32768,83,26,40,5119,32768,83,12,32,5119,32768,83,19,27,5119,32768,83,1,34,10239,32768,32,27,44,5119,32768,83,27,43,5119,32768,83,24,43,5119,32768,83,19,43,5119,32768,83,19,37,5119,32768,83,18,23,5119,32768,83,21,24,5119,32768,83,17,27,5119,32768,83,17,28,5119,32768,83,17,24,5119,32768,83,10,15,5119,32768,83,10,11,5119,32768,83,14,16,5119,32768,83,6,11,5119,32768,83,21,23,5119,32768,83,6,16,5119,32768,83,17,22,5119,32768,83,17,20,5119,32768,83,32,68,10239,32768,32,19,25,5119,32768,83,20,25,5119,32768,83,32,38,5119,32768,83,22,24,5119,32768,83,9,10,5119,32768,83,17,19,5119,32768,83,20,24,5119,32768,83,29,38,5119,32768,83,19,24,5119,32768,83,11,14,5119,32768,83,17,23,5119,32768,83,21,22,5119,32768,83,12,15,5119,32768,83,17,25,5119,32768,83,18,25,5119,32768,83,45,68,10239,32768,32,31,44,5119,32768,83,10,14,5119,32768,83,17,21,5119,32768,83,8,12,5119,32768,83,10,12,5119,32768,83,19,20,5119,32768,83,17,26,5119,32768,83,5,11,5119,32768,83,7,15,5119,32768,83,5,16,5119,32768,83,32,41,5119,32768,83,12,41,5119,32768,83,35,38,5119,32768,83,32,33,5119,32768,83,18,21,5119,32768,83,17,18,5119,32768,83,20,21,5119,32768,83,5,15,5119,32768,83,25,28,5119,32768,83,14,15,5119,32768,83,5,10,5119,32768,83,18,20,5119,32768,83,18,28,5119,32768,83,39,40,5119,32768,83,39,44,5119,32768,83,37,39,5119,32768,83,39,43,5119,32768,83,39,47,5119,32768,83,27,39,5119,32768,83,37,44,5119,32768,83,40,44,5119,32768,83,40,47,5119,32768,83,43,47,5119,32768,83,37,43,5119,32768,83,44,75,10239,32768,83,43,50,20889,32768,65,47,81,20889,32768,65,44,81,22118,32768,83,1,71,10239,32768,83,36,85,20889,32768,65,35,62,20889,32768,65,4,70,5529,32768,83,44,50,22118,32768,83,33,62,22118,32768,83,33,85,22118,32768,83,63,66,5529,32768,83,63,67,5529,32768,83,28,81,25190,32768,83,28,50,25190,32768,83,12,62,25190,32768,83,12,85,25190,32768,83,52,68,10239,32768,83,52,62,10239,32768,83,49,68,10239,32768,83,49,62,10239,32768,83,48,68,10239,32768,83,48,62,10239,32768,83,54,68,10239,32768,83,54,62,10239,32768,83,51,62,10239,32768,83,51,68,10239,32768,83,59,62,10239,32768,83,59,68,10239,32768,83,57,61,5529,32768,83,50,57,10239,32768,83,53,62,10239,32768,83,53,68,10239,32768,83,60,68,10239,32768,83,60,62,10239,32768,83,58,62,10239,32768,83,58,68,10239,32768,83,50,66,10239,32768,83,55,66,10239,32768,83,50,61,10239,32768,83,55,61,10239,32768,83,51,54,5529,32768,83,55,57,10239,32768,83,49,54,5529,32768,83,49,53,5529,32768,83,50,72,10239,32768,83,55,72,10239,32768,83,55,69,10239,32768,83,50,69,10239,32768,83,50,63,10239,32768,83,55,63,10239,32768,83,50,65,10239,32768,83,55,65,10239,32768,83,50,56,10239,32768,83,55,56,10239,32768,83,50,67,10239,32768,83,55,67,10239,32768,83,58,60,5529,32768,83,52,53,5529,32768,83,76,81,10239,32768,83,75,76,10239,32768,83,78,81,10239,32768,83,75,78,10239,32768,83,74,81,10239,32768,83,74,77,5529,32768,83,77,81,10239,32768,83,75,77,10239,32768,83,79,81,10239,32768,83,75,79,10239,32768,83,81,82,10239,32768,83,75,82,10239,32768,83,80,81,10239,32768,83,75,80,10239,32768,83,81,84,10239,32768,83,75,84,10239,32768,83,81,83,10239,32768,83,75,83,10239,32768,83,1,64,10239,32768,83,64,85,10239,32768,83,1,73,10239,32768,83,73,85,10239,32768,83,67,69,5529,32768,83,71,85,10239,32768,83,1,70,10239,32768,83,70,85,10239,32768,83,2,85,10239,32768,83,1,2,10239,32768,83,74,75,10239,32768,83,51,59,5529,32768,83,3,85,10239,32768,83,1,3,10239,32768,83,85,87,10239,32768,83,1,87,10239,32768,83,85,86,10239,32768,83,1,86,10239,32768,83,4,85,10239,32768,83,1,4,10239,32768,83,4,86,5529,32768,83,2,86,5529,32768,83,70,73,5529,32768,83,73,87,5529,32768,83,3,87,5529,32768,83,3,64,5529,32768,83,64,71,5529,32768,83,2,71,5529,32768,83,59,60,5529,32768,83,57,69,5529,32768,83,76,79,5529,32768,83,76,84,5529,32768,83,80,84,5529,32768,83,74,80,5529,32768,83,48,52,5529,32768,83,48,58,5529,32768,83,77,78,5529,32768,83,78,82,5529,32768,83,82,83,5529,32768,83,79,83,5529,32768,83,61,72,5529,32768,83,56,72,5529,32768,83,56,65,5529,32768,83,65,66,5529,32768,83,21,81,23551,32768,83,20,50,23551,32768,83,11,62,23551,32768,83,6,85,23551,32768,83,0,34,5119,32768,83,0,36,6143,32768,83,0,35,6143,32768,83,51,53,58,16384,1747,20,61,65,67,16384,1747,65,52,54,60,16384,1747,83,64,73,86,16384,1747,65,78,79,80,16384,1747,83,2,3,70,16384,1747,53,56,57,63,16384,1747,53,74,76,82,16384,1747,65,,
34,103,5,4,-5.01,-0.20,-7.94,0.00,-7.96,3.04,-9.82,774.00,-7.73,-3.33,-10.10,774.00,-0.25,0.70,10.85,0.00,-0.04,5.16,-0.30,0.00,-8.21,-3.34,-6.37,774.00,-8.04,-0.33,-4.34,774.00,-9.23,-0.19,-8.05,0.00,-8.03,0.01,-11.61,774.00,-8.08,2.84,-6.07,774.00,9.51,-0.13,-7.67,0.00,8.19,3.11,-9.56,774.00,8.12,-3.33,-9.75,774.00,8.43,-3.33,-6.02,774.00,8.18,-0.28,-4.15,774.00,5.28,-0.17,-7.73,0.00,8.46,-0.04,-11.31,774.00,8.60,2.83,-5.81,774.00,-9.48,-0.25,7.01,0.00,-8.21,2.84,5.08,774.00,-8.20,0.08,10.68,774.00,-8.26,-3.33,9.12,774.00,-8.29,-3.34,5.50,774.00,-5.26,-0.23,7.06,0.00,-8.38,3.11,8.64,774.00,-8.48,-0.51,3.42,774.00,9.16,-0.13,7.39,0.00,7.97,-3.33,5.40,774.00,7.65,-0.40,11.17,774.00,8.05,2.87,9.36,774.00,7.93,3.03,5.76,774.00,5.01,-0.17,7.27,0.00,8.12,-3.34,9.02,774.00,8.46,0.07,3.86,774.00,0,5,9215,32768,83,0,2,9215,32768,83,2,7,7168,32768,83,0,8,9215,32768,83,6,7,7168,32768,83,7,8,7168,32768,83,0,9,9215,32768,83,0,1,9215,32768,83,7,9,7168,32768,83,6,9,8192,32768,83,5,6,8192,32768,83,1,8,8192,32768,83,1,7,7168,32768,83,2,8,8192,32768,83,0,6,9215,32768,83,5,7,7168,32768,83,2,5,8192,32768,83,1,9,8192,32768,83,10,13,7168,32768,83,10,12,7168,32768,83,12,15,9215,32768,83,10,16,7168,32768,83,14,15,9215,32768,83,15,16,9215,32768,83,10,17,7168,32768,83,10,11,7168,32768,83,15,17,9215,32768,83,14,17,8192,32768,83,13,14,8192,32768,83,11,16,8192,32768,83,11,15,9215,32768,83,12,16,8192,32768,83,10,14,7168,32768,83,13,15,9215,32768,83,12,13,8192,32768,83,11,17,8192,32768,83,18,21,7168,32768,83,18,20,7168,32768,83,20,23,9215,32768,83,18,24,7168,32768,83,22,23,9215,32768,83,23,24,9215,32768,83,18,25,7168,32768,83,18,19,7168,32768,83,23,25,9215,32768,83,22,25,8192,32768,83,21,22,8192,32768,83,19,24,8192,32768,83,19,23,9215,32768,83,20,24,8192,32768,83,18,22,7168,32768,83,21,23,9215,32768,83,20,21,8192,32768,83,19,25,8192,32768,83,26,29,7168,32768,83,26,28,7168,32768,83,28,31,9215,32768,83,26,32,7168,32768,83,30,31,9215,32768,83,31,32,9215,32768,83,26,33,7168,32768,83,26,27,7168,32768,83,31,33,9215,32768,83,30,33,8192,32768,83,29,30,8192,32768,83,27,32,8192,32768,83,27,31,9215,32768,83,28,32,8192,32768,83,26,30,7168,32768,83,29,31,9215,32768,83,28,29,8192,32768,83,27,33,8192,32768,83,15,31,30719,32768,83,4,7,26623,32768,83,4,10,26623,32768,83,4,18,26623,32768,83,4,26,26623,32768,83,0,23,30719,32768,83,7,18,30719,32768,83,10,26,30719,32768,83,23,31,20479,32768,83,0,15,20479,32768,83,18,26,38912,32768,83,7,10,38912,32768,83,10,18,49152,32768,83,7,26,49152,32768,83,3,10,43008,32768,65,3,7,43008,32768,65,3,4,24575,32768,65,3,26,20479,32768,65,3,18,20479,32768,65,29,33,12697,32768,83,32,33,12697,32768,83,29,32,12697,32768,83,16,17,12697,32768,83,13,17,12697,32768,83,13,16,12697,32768,83,8,9,12697,32768,83,5,8,12697,32768,83,20,22,12697,32768,83,19,22,12697,32768,83,19,20,12697,32768,83,5,9,12697,32768,83,21,24,25,36864,3640,20,27,28,30,36864,3640,20,11,12,14,36864,3640,20,1,2,6,36864,3640,20,3,7,10,32768,7281,83,,
89,338,3,86,-1.19,-0.12,4.19,0.00,-2.11,-1.35,5.92,774.00,0.03,-1.26,2.44,774.00,-2.13,-2.07,3.48,774.00,-3.22,-0.02,4.26,0.00,-2.11,2.02,3.59,774.00,-2.10,1.21,5.98,774.00,-2.13,0.01,2.03,774.00,0.04,-2.05,4.83,774.00,0.05,1.95,4.89,774.00,0.04,1.28,2.46,774.00,0.05,-0.07,6.38,774.00,3.15,0.02,4.19,0.00,1.10,0.04,4.21,0.00,4.31,2.03,4.88,774.00,2.17,1.22,6.00,774.00,2.16,-1.35,5.94,774.00,4.32,-2.07,4.81,774.00,2.16,-2.04,3.50,774.00,4.30,-0.06,6.37,774.00,2.17,2.07,3.53,774.00,4.30,-1.27,2.39,774.00,5.30,-0.04,4.16,0.00,2.16,0.01,2.02,774.00,-5.52,-0.02,4.11,0.00,-6.39,-2.05,3.47,774.00,4.30,1.28,2.45,774.00,-4.24,1.26,2.51,774.00,-6.41,0.01,2.00,774.00,-7.61,-0.05,4.22,0.00,-6.38,1.19,5.98,774.00,-6.37,-1.34,5.92,774.00,6.45,2.04,3.53,774.00,-6.39,2.06,3.58,774.00,7.58,-0.03,4.18,0.00,6.42,-2.05,3.47,774.00,-4.25,-1.26,2.43,774.00,-4.23,-0.07,6.31,774.00,6.42,1.21,5.95,774.00,6.45,0.01,2.00,774.00,-4.23,2.01,4.93,774.00,-4.23,-2.06,4.82,774.00,6.44,-1.34,5.92,774.00,-1.23,-0.10,-3.57,0.00,-2.15,1.07,-1.79,774.00,0.02,-2.06,-3.15,774.00,-2.16,-1.47,-1.94,774.00,-3.27,-0.02,-3.62,0.00,-2.16,0.12,-5.78,774.00,-2.15,2.04,-4.16,774.00,-2.15,-2.05,-4.47,774.00,0.02,-0.19,-1.49,774.00,0.02,1.30,-5.26,774.00,0.02,-1.19,-5.51,774.00,0.02,1.96,-2.83,774.00,3.13,0.00,-3.71,0.00,1.07,-0.01,-3.74,0.00,4.30,1.34,-5.34,774.00,2.14,2.09,-4.19,774.00,2.14,1.11,-1.81,774.00,4.30,-0.20,-1.48,774.00,2.15,-1.41,-2.03,774.00,4.30,1.97,-2.85,774.00,2.15,0.10,-5.87,774.00,4.29,-2.08,-3.15,774.00,5.31,-0.07,-3.65,0.00,2.15,-2.04,-4.49,774.00,-5.56,-0.14,-3.67,0.00,-6.42,-1.48,-2.00,774.00,4.29,-1.19,-5.51,774.00,-4.28,-1.17,-5.47,774.00,-6.44,-2.06,-4.47,774.00,-7.70,-0.09,-3.61,0.00,-6.44,2.02,-4.13,774.00,-6.43,1.07,-1.80,774.00,6.45,0.08,-5.82,774.00,-6.45,0.11,-5.81,774.00,7.62,-0.09,-3.65,0.00,6.41,-1.46,-2.01,774.00,-4.27,-2.07,-3.14,774.00,-4.28,1.88,-2.84,774.00,6.43,2.02,-4.18,774.00,6.44,-2.05,-4.48,774.00,-4.28,1.35,-5.29,774.00,-4.28,-0.22,-1.47,774.00,6.45,1.08,-1.82,774.00,-0.04,4.42,-2.41,0.00,3.36,-0.54,-10.41,0.00,-3.48,-0.56,-10.38,0.00,27,28,5119,32768,83,24,28,5119,32768,83,24,27,5119,32768,83,28,33,5119,32768,83,27,33,5119,32768,83,24,33,5119,32768,83,27,36,5119,32768,83,28,36,5119,32768,83,24,36,5119,32768,83,28,29,5119,32768,83,29,33,5119,32768,83,24,29,5119,32768,83,25,29,5119,32768,83,24,25,5119,32768,83,25,28,5119,32768,83,25,36,5119,32768,83,36,41,5119,32768,83,25,41,5119,32768,83,24,41,5119,32768,83,29,31,5119,32768,83,25,31,5119,32768,83,29,30,5119,32768,83,30,33,5119,32768,83,24,31,5119,32768,83,24,30,5119,32768,83,31,41,5119,32768,83,30,31,5119,32768,83,33,40,5119,32768,83,27,40,5119,32768,83,24,40,5119,32768,83,24,37,5119,32768,83,31,37,5119,32768,83,30,37,5119,32768,83,37,40,5119,32768,83,30,40,5119,32768,83,37,41,5119,32768,83,2,3,5119,32768,83,0,3,5119,32768,83,0,2,5119,32768,83,3,7,5119,32768,83,2,7,5119,32768,83,0,7,5119,32768,83,2,8,5119,32768,83,3,8,5119,32768,83,0,8,5119,32768,83,3,4,5119,32768,83,4,7,5119,32768,83,0,4,5119,32768,83,1,4,5119,32768,83,0,1,5119,32768,83,1,3,5119,32768,83,1,8,5119,32768,83,8,11,5119,32768,83,1,11,5119,32768,83,0,11,5119,32768,83,4,6,5119,32768,83,1,6,5119,32768,83,4,5,5119,32768,83,5,7,5119,32768,83,0,6,5119,32768,83,0,5,5119,32768,83,6,11,5119,32768,83,5,6,5119,32768,83,7,10,5119,32768,83,2,10,5119,32768,83,0,10,5119,32768,83,0,9,5119,32768,83,6,9,5119,32768,83,5,9,5119,32768,83,9,10,5119,32768,83,5,10,5119,32768,83,9,11,5119,32768,83,14,15,5119,32768,83,12,15,5119,32768,83,12,14,5119,32768,83,15,19,5119,32768,83,14,19,5119,32768,83,12,19,5119,32768,83,14,20,5119,32768,83,15,20,5119,32768,83,12,20,5119,32768,83,15,16,5119,32768,83,16,19,5119,32768,83,12,16,5119,32768,83,13,16,5119,32768,83,12,13,5119,32768,83,13,15,5119,32768,83,13,20,5119,32768,83,20,23,5119,32768,83,13,23,5119,32768,83,12,23,5119,32768,83,16,18,5119,32768,83,13,18,5119,32768,83,16,17,5119,32768,83,17,19,5119,32768,83,12,18,5119,32768,83,12,17,5119,32768,83,18,23,5119,32768,83,17,18,5119,32768,83,19,22,5119,32768,83,14,22,5119,32768,83,12,22,5119,32768,83,12,21,5119,32768,83,18,21,5119,32768,83,17,21,5119,32768,83,21,22,5119,32768,83,17,22,5119,32768,83,21,23,5119,32768,83,4,24,5119,32768,83,6,40,5119,32768,83,6,37,5119,32768,83,5,40,5119,32768,83,5,27,5119,32768,83,7,27,5119,32768,83,7,36,5119,32768,83,3,41,5119,32768,83,1,41,5119,32768,83,1,37,5119,32768,83,3,36,5119,32768,83,0,13,5119,32768,83,10,20,5119,32768,83,9,20,5119,32768,83,10,23,5119,32768,83,2,23,5119,32768,83,2,18,5119,32768,83,9,15,5119,32768,83,11,15,5119,32768,83,11,16,5119,32768,83,8,16,5119,32768,83,8,18,5119,32768,83,12,26,5119,32768,83,21,26,5119,32768,83,23,26,5119,32768,83,20,26,5119,32768,83,14,26,5119,32768,83,22,26,5119,32768,83,19,42,5119,32768,83,17,42,5119,32768,83,22,42,5119,32768,83,22,35,5119,32768,83,17,35,5119,32768,83,21,35,5119,32768,83,21,39,5119,32768,83,26,39,5119,32768,83,22,39,5119,32768,83,22,38,5119,32768,83,19,38,5119,32768,83,14,38,5119,32768,83,26,32,5119,32768,83,14,32,5119,32768,83,22,32,5119,32768,83,32,38,5119,32768,83,38,42,5119,32768,83,35,42,5119,32768,83,35,39,5119,32768,83,32,39,5119,32768,83,22,34,5119,32768,83,34,42,5119,32768,83,34,38,5119,32768,83,32,34,5119,32768,83,34,39,5119,32768,83,34,35,5119,32768,83,70,71,5119,32768,83,67,71,5119,32768,83,67,70,5119,32768,83,71,76,5119,32768,83,70,76,5119,32768,83,67,76,5119,32768,83,70,79,5119,32768,83,71,79,5119,32768,83,67,79,5119,32768,83,71,72,5119,32768,83,72,76,5119,32768,83,67,72,5119,32768,83,68,72,5119,32768,83,67,68,5119,32768,83,68,71,5119,32768,83,68,79,5119,32768,83,79,84,5119,32768,83,68,84,5119,32768,83,67,84,5119,32768,83,72,74,5119,32768,83,68,74,5119,32768,83,72,73,5119,32768,83,73,76,5119,32768,83,67,74,5119,32768,83,67,73,5119,32768,83,74,84,5119,32768,83,73,74,5119,32768,83,76,83,5119,32768,83,70,83,5119,32768,83,67,83,5119,32768,83,67,80,5119,32768,83,74,80,5119,32768,83,73,80,5119,32768,83,80,83,5119,32768,83,73,83,5119,32768,83,80,84,5119,32768,83,45,46,5119,32768,83,43,46,5119,32768,83,43,45,5119,32768,83,46,50,5119,32768,83,45,50,5119,32768,83,43,50,5119,32768,83,45,51,5119,32768,83,46,51,5119,32768,83,43,51,5119,32768,83,46,47,5119,32768,83,47,50,5119,32768,83,43,47,5119,32768,83,44,47,5119,32768,83,43,44,5119,32768,83,44,46,5119,32768,83,44,51,5119,32768,83,51,54,5119,32768,83,44,54,5119,32768,83,43,54,5119,32768,83,47,49,5119,32768,83,44,49,5119,32768,83,47,48,5119,32768,83,48,50,5119,32768,83,43,49,5119,32768,83,43,48,5119,32768,83,49,54,5119,32768,83,48,49,5119,32768,83,50,53,5119,32768,83,45,53,5119,32768,83,43,53,5119,32768,83,43,52,5119,32768,83,49,52,5119,32768,83,48,52,5119,32768,83,52,53,5119,32768,83,48,53,5119,32768,83,52,54,5119,32768,83,57,58,5119,32768,83,55,58,5119,32768,83,55,57,5119,32768,83,58,62,5119,32768,83,57,62,5119,32768,83,55,62,5119,32768,83,57,63,5119,32768,83,58,63,5119,32768,83,55,63,5119,32768,83,58,59,5119,32768,83,59,62,5119,32768,83,55,59,5119,32768,83,56,59,5119,32768,83,55,56,5119,32768,83,56,58,5119,32768,83,56,63,5119,32768,83,63,66,5119,32768,83,56,66,5119,32768,83,55,66,5119,32768,83,59,61,5119,32768,83,56,61,5119,32768,83,59,60,5119,32768,83,60,62,5119,32768,83,55,61,5119,32768,83,55,60,5119,32768,83,61,66,5119,32768,83,60,61,5119,32768,83,62,65,5119,32768,83,57,65,5119,32768,83,55,65,5119,32768,83,55,64,5119,32768,83,61,64,5119,32768,83,60,64,5119,32768,83,64,65,5119,32768,83,60,65,5119,32768,83,64,66,5119,32768,83,47,67,5119,32768,83,49,83,5119,32768,83,49,80,5119,32768,83,48,83,5119,32768,83,48,70,5119,32768,83,50,70,5119,32768,83,50,79,5119,32768,83,46,84,5119,32768,83,44,84,5119,32768,83,44,80,5119,32768,83,46,79,5119,32768,83,43,56,5119,32768,83,53,63,5119,32768,83,52,63,5119,32768,83,53,66,5119,32768,83,45,66,5119,32768,83,45,61,5119,32768,83,52,58,5119,32768,83,54,58,5119,32768,83,54,59,5119,32768,83,51,59,5119,32768,83,51,61,5119,32768,83,55,69,5119,32768,83,64,69,5119,32768,83,66,69,5119,32768,83,63,69,5119,32768,83,57,69,5119,32768,83,65,69,5119,32768,83,62,85,5119,32768,83,60,85,5119,32768,83,65,85,5119,32768,83,65,78,5119,32768,83,60,78,5119,32768,83,64,78,5119,32768,83,64,82,5119,32768,83,69,82,5119,32768,83,65,82,5119,32768,83,65,81,5119,32768,83,62,81,5119,32768,83,57,81,5119,32768,83,69,75,5119,32768,83,57,75,5119,32768,83,65,75,5119,32768,83,75,81,5119,32768,83,81,85,5119,32768,83,78,85,5119,32768,83,78,82,5119,32768,83,75,82,5119,32768,83,65,77,5119,32768,83,77,85,5119,32768,83,77,81,5119,32768,83,75,77,5119,32768,83,77,82,5119,32768,83,77,78,5119,32768,83,34,77,16383,32768,6,29,72,16383,32768,6,29,77,34815,32768,65,34,72,34815,32768,65,29,86,22527,32768,6,72,86,18431,32768,6,77,86,18431,32768,6,34,86,22527,32768,6,86,87,20479,32768,6,77,87,16383,32768,6,72,88,16383,32768,6,86,88,20479,32768,6,77,88,26623,32768,6,72,87,26623,32768,6,8,9,10,49152,6553,20,45,53,54,49152,6553,65,29,34,56,49152,6553,53,,
67,252,4,37,9.01,5.83,-1.28,774.00,9.49,4.98,1.55,774.00,9.84,-2.79,3.60,774.00,9.81,2.90,3.60,774.00,9.99,0.05,4.31,774.00,8.17,0.14,-6.87,774.00,9.16,-5.56,-1.32,774.00,8.66,5.02,-4.02,774.00,8.37,-2.68,-6.12,774.00,8.66,-4.79,-4.11,774.00,9.56,-4.81,1.48,774.00,8.38,2.96,-6.08,774.00,-9.52,-4.07,-2.77,774.00,-9.05,-5.56,-0.29,774.00,-8.70,5.46,2.69,774.00,-9.75,1.41,-4.22,774.00,-8.16,-1.58,6.62,774.00,-8.21,1.36,6.64,774.00,-9.24,5.39,-0.20,774.00,-9.67,-1.53,-4.23,774.00,-9.64,3.94,-2.73,774.00,-8.74,-5.56,2.62,774.00,-8.47,3.89,5.17,774.00,-8.37,-4.17,5.12,774.00,1.04,0.04,-0.18,0.00,2.11,2.16,-0.03,0.00,-0.32,-0.43,-2.04,0.00,1.85,0.92,-2.22,0.00,3.37,0.07,-0.39,0.00,2.25,-1.84,0.79,0.00,2.36,0.44,1.83,0.00,1.92,-1.57,-1.70,0.00,-0.19,1.88,-1.02,0.00,0.21,-0.87,1.93,0.00,-0.05,-2.16,-0.21,0.00,0.15,1.60,1.48,0.00,-3.43,-0.02,0.43,0.00,-1.16,-0.01,0.24,0.00,-4.03,-0.93,2.56,0.00,-1.91,0.41,2.45,0.00,-2.18,2.09,0.56,0.00,-4.47,1.91,-0.47,0.00,-2.47,0.91,-1.66,0.00,-4.13,1.58,2.06,0.00,-2.02,-1.91,1.41,0.00,-4.58,-0.45,-1.53,0.00,-5.51,-0.03,0.75,0.00,-2.36,-1.58,-1.10,0.00,5.47,-0.05,-0.79,0.00,6.10,0.89,-2.80,0.00,-4.36,-2.23,0.35,0.00,4.21,-2.10,-0.78,0.00,6.18,-1.62,-2.33,0.00,7.48,0.05,-1.04,0.00,6.64,0.46,1.24,0.00,6.38,2.16,-0.60,0.00,-6.26,-1.98,1.98,0.00,6.51,-1.89,0.24,0.00,-7.50,-0.04,1.01,0.00,-6.68,0.88,-1.13,0.00,3.96,-0.42,-2.63,0.00,4.41,1.56,0.85,0.00,-6.13,0.39,3.02,0.00,-6.60,-1.67,-0.61,0.00,4.50,-0.88,1.42,0.00,4.09,1.90,-1.62,0.00,-6.40,2.17,1.12,0.00,36,37,5119,32768,83,37,40,5119,32768,83,40,42,5119,32768,83,36,47,5119,32768,83,37,47,5119,32768,83,36,40,5119,32768,83,44,47,5119,32768,83,37,44,5119,32768,83,37,39,5119,32768,83,40,43,5119,32768,83,39,40,5119,32768,83,56,63,5119,32768,83,59,63,5119,32768,83,46,50,5119,32768,83,38,50,5119,32768,83,59,66,5119,32768,83,32,42,5119,32768,83,32,40,5119,32768,83,62,66,5119,32768,83,44,50,5119,32768,83,58,59,5119,32768,83,58,63,5119,32768,83,56,58,5119,32768,83,56,62,5119,32768,83,58,62,5119,32768,83,46,66,5119,32768,83,41,66,5119,32768,83,58,66,5119,32768,83,43,66,5119,32768,83,46,56,5119,32768,83,45,59,5119,32768,83,41,59,5119,32768,83,38,56,5119,32768,83,46,58,5119,32768,83,35,40,5119,32768,83,50,56,5119,32768,83,47,50,5119,32768,83,45,50,5119,32768,83,38,62,5119,32768,83,36,50,5119,32768,83,35,39,5119,32768,83,46,59,5119,32768,83,43,62,5119,32768,83,46,62,5119,32768,83,46,63,5119,32768,83,50,63,5119,32768,83,45,63,5119,32768,83,33,39,5119,32768,83,26,42,5119,32768,83,41,45,5119,32768,83,31,60,5119,32768,83,26,47,5119,32768,83,31,51,5119,32768,83,30,64,5119,32768,83,34,47,5119,32768,83,28,48,5119,32768,83,29,51,5119,32768,83,33,44,5119,32768,83,42,47,5119,32768,83,34,44,5119,32768,83,36,41,5119,32768,83,41,43,5119,32768,83,45,47,5119,32768,83,36,46,5119,32768,83,38,46,5119,32768,83,24,37,5119,32768,83,40,41,5119,32768,83,41,46,5119,32768,83,27,60,5119,32768,83,36,42,5119,32768,83,29,64,5119,32768,83,25,61,5119,32768,83,30,61,5119,32768,83,42,45,5119,32768,83,25,65,5119,32768,83,5,28,16383,32768,70,43,46,5119,32768,83,41,42,5119,32768,83,27,65,5119,32768,83,45,46,5119,32768,83,36,45,5119,32768,83,37,42,5119,32768,83,5,53,12287,32768,20,51,52,5119,32768,83,48,52,5119,32768,83,48,51,5119,32768,83,52,57,5119,32768,83,51,57,5119,32768,83,48,57,5119,32768,83,51,60,5119,32768,83,52,60,5119,32768,83,48,60,5119,32768,83,52,53,5119,32768,83,53,57,5119,32768,83,48,53,5119,32768,83,49,53,5119,32768,83,48,49,5119,32768,83,49,52,5119,32768,83,49,60,5119,32768,83,60,65,5119,32768,83,49,65,5119,32768,83,48,65,5119,32768,83,53,55,5119,32768,83,49,55,5119,32768,83,53,54,5119,32768,83,54,57,5119,32768,83,48,55,5119,32768,83,48,54,5119,32768,83,55,65,5119,32768,83,54,55,5119,32768,83,57,64,5119,32768,83,51,64,5119,32768,83,48,64,5119,32768,83,48,61,5119,32768,83,55,61,5119,32768,83,54,61,5119,32768,83,61,64,5119,32768,83,54,64,5119,32768,83,61,65,5119,32768,83,26,27,5119,32768,83,24,27,5119,32768,83,24,26,5119,32768,83,27,31,5119,32768,83,26,31,5119,32768,83,24,31,5119,32768,83,26,32,5119,32768,83,27,32,5119,32768,83,24,32,5119,32768,83,27,28,5119,32768,83,28,31,5119,32768,83,24,28,5119,32768,83,25,28,5119,32768,83,24,25,5119,32768,83,25,27,5119,32768,83,25,32,5119,32768,83,32,35,5119,32768,83,25,35,5119,32768,83,24,35,5119,32768,83,28,30,5119,32768,83,25,30,5119,32768,83,28,29,5119,32768,83,29,31,5119,32768,83,24,30,5119,32768,83,24,29,5119,32768,83,30,35,5119,32768,83,29,30,5119,32768,83,31,34,5119,32768,83,26,34,5119,32768,83,24,34,5119,32768,83,24,33,5119,32768,83,30,33,5119,32768,83,29,33,5119,32768,83,33,34,5119,32768,83,29,34,5119,32768,83,33,35,5119,32768,83,38,39,5119,32768,83,36,39,5119,32768,83,36,38,5119,32768,83,39,43,5119,32768,83,38,43,5119,32768,83,36,43,5119,32768,83,38,44,5119,32768,83,39,44,5119,32768,83,36,44,5119,32768,83,9,53,12287,32768,20,9,28,16383,32768,70,8,53,12287,32768,20,8,28,16383,32768,70,2,28,16383,32768,70,2,53,12287,32768,20,10,53,12287,32768,20,10,28,16383,32768,70,0,28,16383,32768,70,0,53,12287,32768,20,3,53,12287,32768,20,3,28,16383,32768,70,1,53,12287,32768,20,1,28,16383,32768,70,6,53,12287,32768,20,6,28,16383,32768,70,7,53,12287,32768,20,7,28,16383,32768,70,11,53,12287,32768,20,11,28,16383,32768,70,4,53,12287,32768,20,4,28,16383,32768,70,13,58,12287,32768,20,13,36,16383,32768,70,14,58,12287,32768,20,14,36,16383,32768,70,18,58,12287,32768,20,0,1,5734,32768,20,19,58,12287,32768,20,19,36,16383,32768,70,16,58,12287,32768,20,16,36,16383,32768,70,17,58,12287,32768,20,17,36,16383,32768,70,22,58,12287,32768,20,22,36,16383,32768,70,20,58,12287,32768,20,18,36,16383,32768,70,23,58,12287,32768,20,23,36,16383,32768,70,21,58,12287,32768,20,21,36,16383,32768,70,15,58,12287,32768,20,15,36,16383,32768,70,12,58,12287,32768,20,12,36,16383,32768,70,16,23,5734,32768,20,16,17,5734,32768,20,17,22,5734,32768,20,14,22,5734,32768,20,14,18,5734,32768,20,18,20,5734,32768,20,15,20,5734,32768,20,15,19,5734,32768,20,12,19,5734,32768,20,12,13,5734,32768,20,13,21,5734,32768,20,21,23,5734,32768,20,1,3,5734,32768,20,3,4,5734,32768,20,2,4,5734,32768,20,2,10,5734,32768,20,6,10,5734,32768,20,6,9,5734,32768,20,8,9,5734,32768,20,5,8,5734,32768,20,5,11,5734,32768,20,7,11,5734,32768,20,0,7,5734,32768,20,20,36,16383,32768,70,21,22,20070,32768,6,15,22,20070,32768,6,15,21,20070,32768,6,1,10,20070,32768,6,5,10,20070,32768,6,1,5,20070,32768,6,4,7,20070,32768,6,4,9,20070,32768,6,7,9,20070,32768,6,12,16,20070,32768,6,16,18,20070,32768,6,12,18,20070,32768,6,53,58,30924,32768,6,52,63,26419,32768,6,49,59,26419,32768,6,55,66,26419,32768,6,56,57,26419,32768,6,54,62,26419,32768,6,12,16,18,24576,5097,83,1,5,10,24576,5097,53,4,7,9,40959,5097,20,15,21,22,40959,5097,20,,
playerB machines
0,0,0,,
0,0,0,,
0,0,0,,
0,0,0,,
playerC machines
0,0,0,,
0,0,0,,
0,0,0,,
0,0,0,,
playerD machines
0,0,0,,
0,0,0,,
0,0,0,,
0,0,0,,
`;

var wrldTbl = null;//view worlds
var wrldEl  = null;

var fdag = 0;//disable wheel grip in first world campaing

var sdf = [
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
float sdf(vec3 p, float time)                                   //signed distance field
{
    vec2 r = cos(1.+vec2(.0,-.5)*pi);
    mat3 m = mat3(r.x,0,-r.y,
                  0,1,0,
                  r.y,0,r.x);
    float a = p.y+655.;
          a = min(a,length(p-vec3(4345,0,-1960))-22.);
          a = min(a,length(vec2(max(length((p-vec3(3083,0,-1790)).xz)-470.,0.),p.y+2.))-4.);
          a = min(a,length(max(abs((p-vec3(3330,50,-1940)))-vec3(22,0,90),0.))-4.);
          a = min(a,length(p-vec3(3330,-50,-1860))-100.);
          a = min(a,length(max(abs((p-vec3(3370,0,-1650)))-vec3(8,12,130),0.))-4.);
          a = min(a,length(max(abs((p-vec3(3250,0,-1520)))-vec3(80,16,8),0.))-4.);
    float b = 2048.;
    for(float i = 0.; i < 11.; ++i)
    {
        a = min(a,length(p)-b*.5);
        p = abs(p*m)-vec3(.707107,0,.707107)*b*2.;
        b*=.5;
    }
    m = mat3(0.98773, 0.0493865, 0.148159,
             0.0488401, -0.99878, 0.00732599,
             -0.14834, 0, 0.988936);
    return min(a,length(max(abs(p*m)-vec3(8,0,2),0.))-1.);
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    vec2 r = cos(1.+vec2(.0,-.5)*pi);
    mat3 m = mat3(r.x,0,-r.y,
                  0,1,0,
                  r.y,0,r.x);

    float b = 2048.;
    vec4 col = vec4(1,3,2,0)*1.25/(length(max(abs((p-vec3(3330,50,-1940)))-vec3(22,0,90),vec3(-999,-999,0))));
         col+= vec4(2,1.2,1,0)/(p.y+656.2);
    for(float i = 0.; i < 11.; ++i)
    {
        float a = 4.-float(i)*.38;
        col += (cos(-2.+vec4(1,2,3,4)-i*vec4(.1,.2,.3,.4)*3.1)*.5+.5)/(length(p)-b*.5+a)*a;
        p = abs(p*m)-vec3(.707107,0,.707107)*b*2.;
        b*=.5;
    }
    return col;
}

--------------CHECKPOINTS--------------
15,16,3329.9,62.8,-2018.5,0,3329.6,54.1,-1834.3,0,3313.6,9.9,-1681.5,0,3231.9,4.9,-1601.1,0,3122.3,10.9,-1544.3,0,3021.9,6.3,-1463.2,0,3093.7,7.8,-1405.1,0,3275.4,6.6,-1408.2,0,3433.1,27.9,-1527.5,0,3526.8,21.5,-1572.2,0,3570.3,8.8,-1540.2,0,3763.3,5.6,-1515.6,0,3874.2,42.1,-1492.8,0,3927.2,7.3,-1753.9,0,4317.7,7.6,-1929.7,0,4373.6,73.2,-1991.9,0,0.029,0.099,0.995,0,0,0,1,0,0,0,1,0,0,0,1,0,-0.024,-0.006,1,0,-0.035,0,0.999,0,-0.012,0,1,0,-0.012,0,1,0,-0.006,-0.006,1,0,0,-0.006,1.000,0,0,0.012,1,0,0,0,1,0,0.006,0.006,1.000,0,-0.006,0,1.000,0,0.006,0,1,0,0,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`, 
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
vec2 r = cos(35.*.015+vec2(.0,-.5)*pi);
vec2 s = cos(35.*.015+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = p.y+1024.;
    float b = 512.;
    for(float i = 0.; i < 11.; ++i)
    {
        a = min(a,length(p)-b-i*.2);
        p = vec3( p.x*r.x - p.z*r.y, p.y,
                  p.x*r.y + p.z*r.x );
        p = abs(p)-vec3(.7071,0.,.7071)*b*1.8; b*=.56;
        p = vec3( p.x*s.x - p.y*s.y,
                  p.x*s.y + p.y*s.x, p.z );
    }
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float b = 512.;
    vec4 col = vec4(0);
    for(float i = 0.; i < 9.; ++i)
    {
        col += (cos(.559*8.+i*.176*8.+vec4(1,2,3,4)*2.)*.5+.5)/abs(length(p)-b+4.*.384)*4.*.467;
        p = vec3( p.x*r.x - p.z*r.y, p.y,
                  p.x*r.y + p.z*r.x );
        p = abs(p)-vec3(.7071,0.,.7071)*b*1.8; b*=.557;
        p = vec3( p.x*s.x - p.y*s.y,
                  p.x*s.y + p.y*s.x, p.z );
    }
    return col;
}
--------------CHECKPOINTS--------------
15,10,-173.6,47.3,-1659.0,0,-45.1,91.3,-1573.9,0,190.7,191.1,-1242.3,0,417.8,79.7,-1224.0,0,461.6,167.7,-981.6,0,448.3,237.2,-639.9,0,108.0,483.9,-155.0,0,73.6,411.1,589.7,0,127.8,222.0,1319.9,0,182.5,31.4,1680.6,0,0.561,0.198,0.804,0,0.012,0,1.000,0,0.012,0,1.000,0,0.006,0,1.000,0,0,0,1,0,0.006,0,1.000,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 512.
mat3 m = mat3(.9492354,.098952,.2985981, 
              0,.9492354,-.314567,
              -.314567,.2985981,.90104784);
mat3 m1 = mat3(1,0,0,
               0,-.64018,.76822,
               0,.76822,.64018);
mat3 m2 = mat3(.76822,-.64018,0,
               .64018,.76822,0,
               0,0,1);
vec3 u = normalize(vec3(1,1,1));
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = p.y+1024.;
          a = min(a,length(p-vec3(-444,888,-444))-111.);
          a = min(a,length(p-vec3(-530,888,-500))-88.);
          a = min(a,length(p-vec3(-666,910,-550))-77.);
          a = min(a,length(max(abs((p-vec3(-900,764,-570))*m2)-vec3(0,88,9),0.))-3.);
    float s = 1.;
    for(float i = .5; i < 9.; ++i)
    {
        a = min(a,(length(vec2(length(p.xz)-G*2.,p.y))-G)/s);
        p = p*m;
        p = abs(p)-u*G*2.;
        p*=2.;
        s*=2.;
    }
    return min(a,(length(vec2(length(p.xz)-G*1.9,p.y))-G*2.)/s);
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(.3/G))+.4;
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 9.; ++i)
    {
        col += (cos(-1.+.1046*8.*i+px+vec4(1,2,3,4)*16.*.84)*.5+.5)*
               min(length(vec2(length(p.xz)-G*2.,p.y))-G,G*5.);
        p = p*m;
        p = abs(p)-u*G*2.;
        p*=1.998;
        s*=1.998;
    }
    col += (cos(-1.+.1046*8.+px+vec4(1,2,3,4)*16.*.84)*.5+.5)*
           min(length(vec2(length(p.xz)-G*1.9,p.y))-G*2.,G*5.);
    return col/G*.06;
}
--------------CHECKPOINTS--------------
15,10,-1233.7,1419.5,60.3,0,-1130.3,1366.7,52.1,0,-952.4,1156.7,-94.6,0,-686.1,1008.1,-420.1,0,-456.6,1006.8,-444.5,0,-547.3,977.9,-521.9,0,-687.2,987.7,-566.3,0,-858.8,832.0,-574.4,0,-1039.1,677.2,-588.8,0,-1181.6,619.5,-661.3,0,0.903,-0.175,0.393,0,0,0,1,0,0,0,1,0,0,0,1,0,0.006,-0.006,1,0,-0.006,0,1.000,0,-0.006,0,1.000,0,0,0,1,0,0,0,1,0,0.006,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 1024.
mat3 m = mat3(.901047,.2985981,.314567, 
              -.314567,.9492354,0,
              -.2985981,-.0989523,.9492354);
vec3 u = normalize(vec3(1,1,1));
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = p.y+1024.;
          a = min(a,length(max(abs(p-vec3(690,1730,-190))-vec3(290,0,16),0.))-4.);
    float s = 1.;
    for(float i = .5; i < 9.; ++i)
    {
        p = m*p;
        p = abs(p)-u*G*2.;
        p*=2.;
        s*=2.;
        if(i>2.){a = min(a,(length(vec2(length(p.xz)-G*2.,p.y))-G)/s);}
        if(i==3.5)
        {a = min(a,(length(max(abs(p-vec3(-2.6,8,0)*.31*G)-vec3(.2,0,8)*G,0.))-.1*G)/s);}
    }
    return min(a,(length(vec2(length(p.xz)-G*2.,p.y))-G*2.)/s);
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(.1/G))+.4;
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 9.; ++i)
    {
        if(i>1.){col += abs(cos(-1.+.84*8.*i+px+vec4(1,3,2,4)*16.*.122))*
                        (length(vec2(length(p.xz)-G*2.,p.y))-G*.3*2.);}
        p = m*p;
        p = abs(p)-u*G*2.;
        p*=2.01;
        s*=2.01;
    }
    col += abs(cos(-1.+.84*8.+px+vec4(1,2,3,4)*16.*.122))*
           min(length(vec2(length(p.xz)-G*2.,p.y))-G*1.7*2.,G*8.);
    return col/G*.03;
}
--------------CHECKPOINTS--------------
15,12,578.7,2142.9,2438.7,0,392.6,2135.6,2097.5,0,257.9,2140.5,1903.5,0,239.5,2121.3,1774.2,0,218.6,2020.4,1143.3,0,226.4,2023.5,780.2,0,288.3,2003.3,604.8,0,469.6,1946.5,346.8,0,602.8,1913.7,167.2,0,814.1,1839.1,128.5,0,988.7,1741.4,-171.3,0,420.8,1745.2,-189.4,0,-0.536,-0.099,-0.838,0,0,0,1,0,0,0,1,0,0,0,1,0,0.018,-0.012,1,0,0,0,1,0,0,0,1,0,-0.006,0,1,0,-0.006,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define gu 55.
vec2 rand(vec3 a)
{
    return fract(sin(dot(a,vec3(22.89284388,78.268323,218.268323))) * 
                 vec2(43758.754623953, 22495.460491263));
}
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = 999999.;

    mat3 mt = mat3(1,0,0,
                   0,-0.857493, 0.514496,
                   0,0.857493, 0.514496);
    
    vec2 rnd = vec2(0);
    vec3 q = vec3(0);
    vec2 s = vec2(0);

    q = p;   rnd = rand(floor(q/(gu*4.)));
    q = mod(q,gu*4.)-gu*2.; if(rnd.x>=.5){q.y = -q.y;} if(rnd.y>=.5){q.xz = q.zx;}
    q = q*mt;
    a = min(a,length(max(abs(q)-vec3(gu*.2,0,gu*1.7),0.))-gu*.02);
    
    q = p+gu*2.;   rnd = rand(floor(q/(gu*4.)));
    q = mod(q,gu*4.)-gu*2.; if(rnd.x>=.5){q.y = -q.y;} if(rnd.y>=.5){q.xz = q.zx;}
    q = q*mt; 
    a = min(a,length(max(abs(q)-vec3(gu*.2,0,gu*1.7),0.))-gu*.02);
    
    rnd = rand(floor(p/(gu*2.)));
    q = mod(p,gu*2.)-gu;
    if(rnd.x>=.5){q = q*vec3(-1,1,1);}
    
    a = min(a,length(max(abs(abs(q)-vec3(gu,0,gu))-vec3(gu,0,gu)*.29,0.))-gu*.02);
    q = q*mat3(.707107,0,.707107,
               0,1,0,
               .707107,0,-.707107);
    float b = min(a,length(max(abs(q)-vec3(gu*.2,0,gu*1.5),0.))-gu*.02);
    if(rnd.y>=.5){a = b;}
    
    a = max(a,length(max(abs(p)-16.*gu,0.)));
    a = min(a,p.y);
        
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    vec3 q = mod(p,gu*2.)-gu;

    vec4 col = vec4(0);
         col += (cos(-0.+vec4(1,2,3,4)-p.y*vec4(.1,.2,.3,.4)*.1)*.5+.5)/
                (length(max(abs(abs(q)-vec3(gu,0,gu))-vec3(gu,0,gu)*.29,0.))-gu*.02+8.)*9.;
    return col+max(.2-p.y*.1,0.);
}
--------------CHECKPOINTS--------------
15,7,120.3,11.9,-1432.2,0,1.3,11.0,-658.8,0,43.8,293.1,-330.3,0,188.6,395.8,-361.5,0,-144.7,613.2,-627.7,0,-220.3,654.2,-413.3,0,-219.6,886.7,-647.3,0,0,0,1,0,-0.006,0,1.000,0,0,0,1,0,0,0,1,0,0.006,0,1.000,0,-0.006,0,1.000,0,-0.000,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define gu 888.
#define fa 3.35
#define rz 1.6
float sdf(vec3 p, float time)                                   //signed distance field
{
    p.z = mod(p.z,gu*fa)-gu*fa*.5;
    float a = 999999.;
    float s = 1.;
    mat3 m = mat3(-0.811093*0.969804,-0.811093*0.243886,-0.584917,
                  -0.243886,0.969804,0,
                  0.584917*0.969804,0.584917*0.243886,-0.811093);
    for(float i=0.; i<11.; i++)
    {
        p = abs(p)-.5*gu;
        p = m*p;
        p *= rz;
        s *= rz;
        a = min(a,(length(max(abs(p)-1.*gu,0.))-.2*gu)/s);
    }
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float z = p.z*.001+1.;
    p.z = mod(p.z,gu*fa)-gu*fa*.5;
    vec4 col = vec4(0);
    float s = 1.;
    mat3 m = mat3(-0.811093*0.969804,-0.811093*0.243886,-0.584917,
                  -0.243886,0.969804,0,
                  0.584917*0.969804,0.584917*0.243886,-0.811093);
    for(float i=0.5; i<6.; i++)
    {
        p = abs(p)-.5*gu;
        p = m*p;
        p *= rz;
        s *= rz;
        col += (cos(z+i*.2*pi*2.+vec4(1,2,3,4)*1.5)*.5+.5)/
               ((length(max(abs(p)-1.*gu,0.))-.2*gu)/s+1.);
    }
    return col;
}
--------------CHECKPOINTS--------------
8,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 2222.
vec2 rt = cos(-47.35*.5*.3+vec2(.0,-.5)*pi);
vec2 st = cos(-47.35*.7*.3+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = 999999.;
    float s = 1.;
    for(float i=.5; i<15.; i++)
    {
        p = abs(p)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.5;
        s *= 1.5;
    }
    return (length(p)-1.*G)/s;
  //return (length(vec2(length(p.yz)-G*2.,p.xz))-G)/s;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    vec4 col = vec4(0);
    float s = 1.;
    for(float i=.5; i<15.; i++)
    {
        p = abs(p)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.503;
        s *= 1.503;
        col += (cos(i*.2*pi*2.+vec4(1,2,3,4)*1.25)*.5+.5)*
               min(length(p)-G,G*1.1);
    }
    return col/G*.15;
}
--------------CHECKPOINTS--------------
15,5,-527.3,2810,1095.8,0,-474.6,2445.5,797.5,0,-186.1,2250,438.4,0,-16.3,2306.6,110.3,0,-146.3,2361.8,0.1,0,0.967,-0.192,0.167,0,0.006,0.006,1.000,0,0,0,1,0,0,0,1,0,-0.006,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 2222.
vec2 rt = cos(-29.2*.5*.3+vec2(.0,-.5)*pi);
vec2 st = cos(-29.2*.7*.3+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = p.y+5000.;
    float s = 1.;
    for(int i=0; i<11; i++)
    {
        p = abs(p)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.9;
        s *= 1.9;
        if(i>6)a = min(a,(length(p)-1.2*G)/s);
    }
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 6.; ++i)
    {
        p = abs(p)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.9;
        s *= 1.9;
        col += (cos(i*1.5-vec4(3,5,7,4)+4.)*.5+.5)/
               (abs(length(p)-G)/s+3.);
    }
    return col*2.;
}
--------------CHECKPOINTS--------------
15,8,-2058.2,2520.3,1586.1,0,-2024.4,2473.5,1468.4,0,-1120.5,2279.9,940.2,0,-932.7,2245.0,793.1,0,-618.4,2170.3,134.1,0,-271.1,2213.2,80.8,0,-319.6,2230.8,-43.7,0,-383.9,2009.7,2.4,0,-0.228,0.023,-0.973,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0.006,0,1,0,0.006,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 2000.
float sdf(vec3 p, float time)                                   //signed distance field
{
    vec2 rt = cos(-1.6*.5*.3+vec2(.0,-.5)*pi);
    vec2 st = cos(-1.6*.7*.3+vec2(.0,-.5)*pi);
    float a = p.y+2048.;
    float s = 1.;
    for(float i=0.; i<11.; ++i)
    {
        p.xz = abs(p.xz)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.8;
        s *= 1.8;
        rt*=vec2(-1,1);
        st*=vec2(1,-1);
        a = min(a,(length(p+vec3(0,1.1,0)*G)-1.*G)/s);
    }
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(2./G));
    vec2 rt = cos(-1.6*.5*.3+vec2(.0,-.5)*pi);
    vec2 st = cos(-1.6*.7*.3+vec2(.0,-.5)*pi);
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 7.; ++i)
    {
        p.xz = abs(p.xz)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.8;
        s *= 1.8;
        rt*=vec2(-1,1);
        st*=vec2(1,-1);
        col += (cos(px+.3+i*1.2-vec4(1,2,3,4))*.5+.9)/
               (abs((p.y+1.1*G)-1.*G)/s+4.)*1.;
    }
    return col;
}
--------------CHECKPOINTS--------------
15,16,-360.3,-235.7,-2140.4,0,-237.2,-288.0,-1862.7,0,-74.7,-265.5,-1649.9,0,128.7,-252.8,-1498.6,0,427.4,-179.2,-1171.4,0,646.6,-217.6,-971.9,0,921.9,-162.7,-853.1,0,1117.7,-108.1,-602.5,0,1191.7,-108.5,-491.5,0,1423.3,-88.3,-259.1,0,1558.7,-17.4,-157.7,0,1733.4,33.9,-1.6,0,1918.8,118.6,32.2,0,1998.9,229.6,176.5,0,2102.8,382.2,229.1,0,2149.4,422.7,17.8,0,0,0.023,1.000,0,0,0,1,0,0,0,1,0,0,0,1,0,0.006,0,1.000,0,0,0,1,0,-0.006,0,1.000,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0.006,0,1.000,0,-0.006,-0.006,1.000,0,0,0,1,0,-0.006,0,1.000,0,0,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 2048.
float sdf(vec3 p, float time)                                   //signed distance field
{
    vec2 rt = cos(-22.*.5*.3+vec2(.0,-.5)*pi);
    vec2 st = sin(-22.*.7*.3+vec2(.0,-.5)*pi);

    float a = p.y+2048.;
          a = min(a,length(p-vec3(-619,1970,-1202))-33.);
    float s = 1.;
    for(float i=.5; i<10.; ++i)
    {
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = p-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.8;
        s *= 1.8;
        rt*=vec2(-1,1);
        st*=vec2(-1,1);
        if(i>6.)a = min(a,(length(p)-1.*G)/s);
    }
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    vec2 rt = cos(-22.*.5*.3+vec2(.0,-.5)*pi);
    vec2 st = sin(-22.*.7*.3+vec2(.0,-.5)*pi);

    float px = dot(p,vec3(1./G));
    float s = 1.;
    vec4 col = vec4(0);
         col+= 2./length(p-vec3(-619,2000,-1202));
    for(float i = .5; i < 7.; ++i)
    {
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = p-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.8;
        s *= 1.8;
        rt*=vec2(-1,1);
        st*=vec2(-1,1);
        if(i>6.)col += (cos(px+6.+i*1.2-vec4(1,2,3,4))*.5+.9)/
                       ((length(p)-1.*G)/s+1.);
    }
    return col;
}
--------------CHECKPOINTS--------------
15,9,-2494.7,2364.2,-1894,0,-2276.7,2378.7,-1785.4,0,-1978.8,2422.9,-1506.9,0,-1600.7,2418.2,-1345.6,0,-1173,2328.2,-1069.3,0,-882.9,2194,-1090.5,0,-669.1,2030.3,-1197.3,0,-465.4,1918.8,-950.3,0,-487.2,1832.9,-878.6,0,0.884,0.099,0.458,0,0,0,1,0,0,0,1,0,0,0,1,0,0.006,0,1,0,-0.006,0,1,0,0.006,0,1,0,0,0,1,0,-0.006,-0.006,1.000,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 4096.
vec2 rt = cos(-42.*.5*.3+vec2(.0,-.5)*pi);
vec2 st = sin( 42.*.7*.3+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    vec3 q = p;
    float a = 999999.;
    float s = 1.;
    for(float i=0.; i<8.; ++i)
    {
        p = abs(p)-.5*G;
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = p-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 2.;
        s *= 2.;
        rt*=vec2(-1,1);
        a = min(a,(length(max(abs(p)-vec3(0,.6,4)*G,0.))-.2*G)/s);
    }
    a = max(a,-length(max(abs(q-vec3(0,0,-5640))-vec3(0,9999,0),0.))+28.);
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(1./G));
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 8.; ++i)
    {
        p = abs(p)-.5*G;
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = p-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.9+.5416*.2;
        s *= 1.9+.5416*.2;
        rt*=vec2(-1,1);
        col += abs(cos(+i*32.*.4776+vec4(1,2,3,4)*pi*2./3.))*
               ((length(max(abs(p)-vec3(0,.6,4)*G,0.))-.4416*2.*G));
    }
    return col/G*.11;
}
--------------CHECKPOINTS--------------
15,16,-1448.3,6221.3,-8124.7,0,-1462.4,6205.3,-7856.2,0,-1465.3,6337.9,-7635.0,0,-1283.7,6351.8,-7607.7,0,-1201.1,6357.9,-7506.2,0,-1147.8,6344.7,-7190.2,0,-1024.5,6428.6,-7164.4,0,-930.9,6529.5,-7074.5,0,-696.8,6664.3,-6980.0,0,-371.9,6913.0,-6883.3,0,-175.2,6959.1,-6766.4,0,-102.2,6977.6,-6695.1,0,-105.9,6980.1,-6441.3,0,-0.2,6939.4,-6392.8,0,-0.6,6918.8,-5597.4,0,0,6837.3,-5633.1,0,-0.006,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,-0.006,0,1.000,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,-0.012,0,1.000,0,0.006,0,1.000,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 2048.
vec2 rt = cos(45.9*.25*.5+vec2(.0,-.5)*pi);
vec2 st = sin(45.9*1. *.5+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float b = length(max(abs(vec2(length(p*vec3(1,0,1))-.327*G,p.y-.860*G))-vec2(.011,0)*G,vec2(0)));
    float a = 999999.;
    float s = 1.;
    for(float i=0.; i<12.; ++i)
    {
        p = abs(p)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.7;
        s *= 1.7;    
        a = min(a,(length(vec2(max(length(p*vec3(1,0,1))-1.5*G,0.),p.y+.1*G))-.1*G)/s);
        //a = min(a,(length(p)-.83*G)/s);
    }
    a = max(a,-b+24.);
    a = min(a,b-4.);
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(2./G));
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 12.; ++i)
    {
        p = abs(p)-.5*G;
        p = vec3( p.x*rt.x - p.z*rt.y, p.y,
                  p.x*rt.y + p.z*rt.x );
        p = vec3( p.x*st.x - p.y*st.y,
                  p.x*st.y + p.y*st.x, p.z );
        p *= 1.5+.4083*.5;
        s *= 1.5+.4083*.5;   
        if(i>3.)col += (cos(i*64.*.1546+vec4(1,2,3,4)*pi*2./3.)*.5+.4)*
                       min(length(vec2(max(length(p*vec3(1,0,1))-1.*G,0.),p.y))-.6*G,G*.8);
    }
    return col/G*.32;
}
--------------CHECKPOINTS--------------
15,9,42.9,1776.2,-668.4,0,-446.1,1773.9,-498.0,0,-664.3,1775.0,-5.9,0,-595.6,1774.9,297.7,0,-338.5,1775.1,576.6,0,175.4,1776.4,643.4,0,622.7,1775.5,238.0,0,621.2,1775.7,-240.5,0,404.3,1773.8,-535.2,0,-0.995,0.064,-0.081,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,-0.006,-0.006,1.000,0,0,0,1,0,0,0,1,0,0,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 1024.
vec2 rt = cos(.25*pi*2.+vec2(.0,-.5)*pi);
vec2 st = sin(.42*pi*2.+vec2(.0,-.5)*pi);
mat3 m2 = mat3(.98058,.19611,0,
               .19611,-.98058,0,
               0,0,1);
float sdf(vec3 p, float time)                                   //signed distance field
{
    vec3 q = p;
    float a = p.y+2048.;
    float s = 1.;
    for(float i=.5; i<9.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        p+=min(dot(p,vec3(1,-1,0)),0.)*vec3(-1, 1,0);
        p+=min(dot(p,vec3(1,0,-1)),0.)*vec3(-1, 0,1);
        p+=min(dot(p,vec3(0,1,-1)),0.)*vec3( 0,-1,1);
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.92;
        s *= 1.92;
        p+=vec3(-3.44,-.69,-1.14)*G;
        if(i==7.5)a = min(a,(length(p)-1.*G)/s);
        a = min(a,(length(max(abs(p+vec3(0,.1,1.3)*G)-vec3(8,0,0)*G,0.))-.1*G)/s);
    }
    a = min(a,(length(p)-2.5*G)/s);
    a = max(a,-length(max(abs((q-vec3(-78,378,-2080)))-vec3(9,4,40),0.))+8.);
    a = max(a,-length(q-vec3(196,446,-2224))+36.);
    a = min(a,length(max(abs((q-vec3(-300,360,-1836)))-vec3(200,0,32),0.))-3.);
    a = min(a,length(max(abs((q-vec3(88,390,-2208))*m2)-vec3(144,0,16),0.))-3.);
    a = min(a,length(q-vec3(-266,313,-3288))-8.);
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(2./G));
    float s = 1.;
    vec4 col = vec4(0);
         //col+= vec4(4./length(p-vec3(-450,358,-1834)));
         //col+= vec4(4./length(p-vec3(-60,360,-2199)));
    for(float i = .5; i < 9.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        p+=min(dot(p,vec3(1,-1,0)),0.)*vec3(-1, 1,0);
        p+=min(dot(p,vec3(1,0,-1)),0.)*vec3(-1, 0,1);
        p+=min(dot(p,vec3(0,1,-1)),0.)*vec3( 0,-1,1);
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.85+.7088*.1;
        s *= 1.85+.7088*.1;
        p+=vec3(-3.44,-.69,-1.14)*G;
        col += (cos(+i*16.*.7015+vec4(1,2,3,4)*pi*16.*.4657)*.5+.5)*
        min(length(max(abs(p+vec3(0,.1,1.3)*G)-vec3(8,0,0)*G,0.))-.3611*2.*G,G*.9);
    }
    return col/G*.25;
}
--------------CHECKPOINTS--------------
15,11,-255.2,318.3,-3806.6,0,-241.7,320,-3344,0,-394.4,393.2,-3205.1,0,-812.3,394.9,-2787.7,0,-753.9,229.7,-2381.8,0,-730.6,245.2,-1875.9,0,-467.7,370.5,-1833.9,0,-74.9,375.9,-1838.6,0,-73.4,376.2,-2210.2,0,254.3,437.6,-2225.1,0,0.2,585.0,-2184.1,0,0,0.006,1,0,0,0,1,0,0,0,1,0,0.018,0.006,1,0,0,0,1,0,0,0,1,0,0,0,1,0,-0.006,0,1,0,0,0,1,0,0.006,0,1.000,0,-0.006,0,1.000,0

----------------GRAVITY----------------
1,0,0,0,-.006,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 99.
vec2 rt = cos(.939*pi*2.+vec2(.0,-.5)*pi);
vec2 st = cos(.129*pi*2.+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = 999999.;
    float s = 1.;
    for(float i=.5; i<10.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        p+=min(dot(p,vec3(1,-1,0)),0.)*vec3(-1, 1,0);
        p+=min(dot(p,vec3(1,0,-1)),0.)*vec3(-1, 0,1);
        p+=min(dot(p,vec3(0,1,-1)),0.)*vec3( 0,-1,1);
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.312;
        s *= 1.312;
        p+=vec3(-.8,-1.7,-.6)*G;
    }
    return (length(p)-4.*G)/s;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(2./G));
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 10.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        p+=min(dot(p,vec3(1,-1,0)),0.)*vec3(-1, 1,0);
        p+=min(dot(p,vec3(1,0,-1)),0.)*vec3(-1, 0,1);
        p+=min(dot(p,vec3(0,1,-1)),0.)*vec3( 0,-1,1);
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.3;
        s *= 1.3;
        p+=vec3(-.8,-1.7,-.6)*G;
        col += (cos(.888*7.+i*7.*.268+vec4(1,2,3,4))*.5+.5)/
               (abs(length(p)-4.*G)/s+.928);
    }
    return col*.928;
}
--------------CHECKPOINTS--------------
15,8,59.3,351.2,-73.0,0,34.8,363.3,1.4,0,168.3,324.4,127.8,0,312.2,103.9,151.5,0,318.2,8.7,0.7,0,292.3,-35.3,-0.7,0,124.0,-205.9,0.1,0,104.0,-244.0,188.0,0,-0.006,0,1.000,0,0,0,1,0,0,0,1,0,-0.018,-0.006,1.000,0,-0.006,0,1.000,0,-0.006,0,1.000,0,0,0,1,0,0,0,1,0

----------------GRAVITY----------------
0,0,1,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 64.
    vec2 rt = cos(.141*pi*1.+vec2(.0,-.5)*pi);
    vec2 st = cos(.171*pi*1.+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = 999999.;
    float s = 1.;
    for(float i=0.; i<10.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        p+=min(dot(p,vec3(1,-1,0)),0.)*vec3(-1, 1,0);
        p+=min(dot(p,vec3(1,0,-1)),0.)*vec3(-1, 0,1);
        p+=min(dot(p,vec3(0,1,-1)),0.)*vec3( 0,-1,1);
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.312;
        s *= 1.312;
        p+=vec3(-.8,-2.,-.6)*G;
        if(i>8.)a = min(a,(length(p)-4.*G)/s);
    }
    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(.2/G));
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = 0.5; i < 9.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        p+=min(dot(p,vec3(1,-1,0)),0.)*vec3(-1, 1,0);
        p+=min(dot(p,vec3(1,0,-1)),0.)*vec3(-1, 0,1);
        p+=min(dot(p,vec3(0,1,-1)),0.)*vec3( 0,-1,1);
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.+.637*.5;
        s *= 1.+.637*.5;
        p+=vec3(-.8,-2.,-.6)*G;
        if(i>3.)col += (cos(.391*pi*2.-vec4(1,2,3,4)*i*1.*.316)*.5+.8)/
               (abs(length(p)-.654*7.*G)/s+2.);
    }
    return col*.5;
}
--------------CHECKPOINTS--------------
15,2,-0.0,197.0,-29.3,0,74.3,-212.5,-99.0,0,0.006,0,1.000,0,0,0,1,0

----------------GRAVITY----------------
0,1,0,0,-.004,-.004,-.004,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 1024.
    vec2 rt = cos(.375*pi+pi+vec2(.0,-.5)*pi);
    vec2 st = cos(.716*pi+pi+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = length(p-vec3(404,3560,1283))-40.;
          a = min(length(p-vec3(622,3470,1664))-100.,a);
    float s = 1.;
    for(float i=0.; i<11.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.3;
        s *= 1.3;
        p+=vec3(-.8,-1.7,-.6)*G;
    }
    return min(a,(length(p)-4.1*G)/s);
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(.2/G));
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 9.; ++i)
    {
        p = abs(p);
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.25+.468*.1;
        s *= 1.25+.468*.1;
        p+=vec3(-.8,-1.7,-.6)*G;
        vec4 a = cos(.509*pi*2.+.134*i*4.+vec4(1,2,3,4))*.5+.5;
        if(i<4.)col += a*max(((length(p)-2.*G))/G*-.7,0.);
        if(i>4.)col += a/(abs(length(p)-(.184*1.+3.5)*G)/s+9.)*7.;
    }
    return col;
}
--------------CHECKPOINTS--------------
15,11,0.2,3945.1,59.2,0,192.3,3943.9,270.9,0,180.1,3880.5,472.1,0,-0.6,3768.9,648.9,0,0.0,3655.7,975.5,0,178.5,3629.4,1188.4,0,382.0,3619.0,1243.3,0,485.0,3602.1,1540.9,0,683.5,3596.6,1715.2,0,886.6,3598.9,1737.8,0,1049.9,3530.5,1671.6,0,0,-0.249,0.968,0,0.006,0,1.000,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,-0.006,1.000,0,-0.006,0,1.000,0,0,0,1,0,0.006,0,1.000,0

----------------GRAVITY----------------
0,1,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 32.
    vec2 rt = cos(.690*pi*2.+vec2(.0,-.5)*pi);
    vec2 st = cos(.974*pi*2.+vec2(.0,-.5)*pi);
float sdf(vec3 p, float time)                                   //signed distance field
{
    float a = 999999.;
    float s = 1.;
    for(float i=0.; i<11.; ++i)
    {
        p = abs(p)-vec3(.61,.8,1.7)*.5*G;
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.3;
        s *= 1.3;
        p-=vec3(.8,1.7,.61)*G;
    }
    return (length(p)-4.*G)/s;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float px = dot(p,vec3(.2/G));
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 9.; ++i)
    {
        p = abs(p)-vec3(.61,.8,1.7)*.5*G;
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.+.612*.5;
        s *= 1.+.612*.5;
        p-=vec3(.8,1.7,.61)*G;
        col += (cos(.365*pi*2.-vec4(1,2,3,4)*i*1.*.437)*.5+.8)/
               (abs(length(p)-.649*5.*G)/s+.3)*.3;
    }
    return col;
}
--------------CHECKPOINTS--------------
15,5,1.8,26.9,-202.2,0,-0.1,127.0,4.6,0,-101.8,-46.5,2.6,0,-29.5,-41.5,156.4,0,135.0,3.5,90.1,0,0.009,0.998,0.066,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0

----------------GRAVITY----------------
0,1,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
#define G 512.
vec2 rt = cos(.404*pi*2.+vec2(.0,-.5)*pi);
vec2 st = cos(.974*pi*2.+vec2(.0,-.5)*pi);
mat3 m = mat3(.7071,.7071,0,
              -.7071,.7071,0,
              0,0,1);
float sdf(vec3 p, float time)                                   //signed distance field
{
    p.y=abs(p.y)-G*3.41;
    p = m*p;
    float a = 999999.;
    float s = 1.;
    for(float i=0.; i<11.; ++i)
    {
        p = abs(p)-vec3(.61,.8,1.7)*.5*G;
        p = vec3( p.x*rt.x - p.y*rt.y, 
                  p.x*rt.y + p.y*rt.x, p.z );
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.75;
        s *= 1.75;
        p-=vec3(.8,1.7,.61)*G;
    }
    return (length(p)-4.*G)/s;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    p.y=abs(p.y)-G*3.41;
    p = m*p;
    float px = dot(p,vec3(.2/G));
    float s = 1.;
    vec4 col = vec4(0);
    for(float i = .5; i < 9.; ++i)
    {
        p = abs(p)-vec3(.61,.8,1.7)*.5*G;
        p = vec3( p.x*rt.x - p.y*rt.y,
                  p.x*rt.y + p.y*rt.x, p.z );
        if(dot(p,vec3(1,0,1))<0.){p = p.zyx*vec3(-1, 1,-1);}
        if(dot(p,vec3(1,1,0))<0.){p = p.yxz*vec3(-1,-1, 1);}
        if(dot(p,vec3(0,1,1))<0.){p = p.xzy*vec3( 1,-1,-1);}
        p = vec3( p.x,
                  p.y*st.x - p.z*st.y,
                  p.y*st.y + p.z*st.x);
        p *= 1.752;
        s *= 1.752;
        p-=vec3(.8,1.7,.61)*G;
        if(i>5.)col += max(cos(.4*pi*2.+.4*i*4.+vec4(1,3,2,4)),0.)*
                       min(length(p)-4.*G,G*6.-dot(p,vec3(.9)));
    }
    return col/G*.4+.3;
}
--------------CHECKPOINTS--------------
15,14,-148.7,-149.1,-1300.3,0,-111.0,-323.0,-896.9,0,17.0,-401.4,-541.6,0,153,-428.5,-368.1,0,498.6,-459.7,-202.6,0,887.4,-428.3,-0.6,0,613.5,-454.2,153.2,0,254.2,-451.6,292.5,0,10.1,-404.5,526.5,0,-67.7,-362.8,754.1,0,-148.2,-300.5,992.5,0,-287.0,-229.7,1089.8,0,-484.3,-129.6,1092.3,0,-567.4,-0.8,1207.7,0,0.151,-0.105,0.983,0,-0.018,0.006,1.000,0,0.000,0,1,0,-0.018,-0.012,1,0,0,0,1,0,0,0,1,0,-0.006,-0.006,1.000,0,0,0,1,0,-0.006,-0.012,1.000,0,0.006,0,1.000,0,0,0.006,1.000,0,0,0,1,0,0,0,1,0,-0.012,-0.006,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`,
`
----------------SHADERS----------------
#define pi 3.1415926535897932384626433832795
mat3 m1 = mat3(1,0,0,
               0, .7071,.7071,
               0,-.7071,.7071);
float sdf(vec3 p, float time)                                   //signed distance field
{
    vec3 q = vec3(p.x,p.y,abs(p.z+88.)-88.);
    float a = p.y;
          a = min(a,length(vec2(length(q.xy           )-24.,q.z))-2.);

    float b = min(length(vec2(length(p.xz-vec2(54,0))-30.,p.y))-2.,
                  length(vec2(length(p.xz-vec2(54,0))-78.,p.y))-2.);
    if(p.z<0.)b = length(vec3(abs(abs(p.x-54.)-54.)-24.,p.y,p.z))-2.;
          a = min(a,b);

    a = min(a,length(max(abs((p-vec3(108,50,-140))   )-vec3(22,0,90),0.))-2.);
    a = min(a,length(max(abs((p-vec3(108,0,    0))*m1)-vec3(22,0,70),0.))-2.);

    return a;
}
vec4 sdfCol(vec3 p, float time)                                 //signed distance field color
{
    float b = 512.;
    vec3 q = vec3(abs(p.x)-24.,p.y,max(abs(p.z+132.)-44.,0.));
    vec4 col = vec4(1)/(length(q)+1.);

    float c = min(length(vec2(length(p.xz-vec2(54,0))-30.,p.y))-2.,
                  length(vec2(length(p.xz-vec2(54,0))-78.,p.y))-2.);
    if(p.z<0.)c = length(vec3(abs(abs(p.x-54.)-54.)-24.,p.y,p.z))-2.;
    col+= vec4(1./(c+1.));

    q = p-vec3(108,50,-140);
    q = vec3(abs(q.x)-22.,q.y,max(abs(q.z)-90.,0.));
    col+= (cos(p.z*.04+vec4(2,3,4,5))*.5+.5)/(length(q)-1.);

    for(float i = 0.; i < 4.; ++i)
    {
        col += (cos(5.+i*vec4(1,2,3,4)*.3)*.5+.5)/(length(p)*.1+1.);
        p = abs(p)-vec3(.7,0,.7)*b;
        b*=.5;
    }
    return col;
}

--------------CHECKPOINTS--------------
15,5,0.8,11.5,-200.3,0,-1.2,13.5,-73.9,0,54.5,8.6,52.8,0,106.7,50,-28.2,0,108.1,64.2,-215.2,0,-0.001,-0.018,1,0,0,0,1,0,0,0.006,1.000,0,0,0,1,0,0,0,1,0

----------------GRAVITY----------------
1,0,0,0,-.0049,-.0049,-.0049,.2
`
];
var sdfO = 6;//which world to load
var sdfTxtID = 0;

//18 learn
//0  galaxy
//7  holes
//13 bones
//11 candy
//17 roses
//14 trees
//2  fire
//16 pink
//10 steel
//9  triangl
//12 pyramids
//3  grey
//8  desert
//1  circus
//15 hallowen
//4  stairs

var campainW = -1;
var campainL = [18,0,7,13,11,17,14,2,16,10,9,12,3,8,1,15];//,4];
var campainL2 = campainL.length-1;
//var campainNxt = false;
var campainEl = null;
var campainRspw  = 0;
var campainRspwT = 0; //time for respawn after hold key

var lvlTim = new Uint32Array(campainL.length);
var lvlDed = new Uint32Array(campainL.length);

var chckMx = 64;
var chckN = 0;
var chckL = new Float32Array(chckMx<<3);    //list of checkpoints
var chckP = new Uint8Array(plyMx);          //player currently in
var chckG = new Float32Array(plyMx<<1);     //grabed which and distance, 0 distance means nothing grabbed
var chckTim = new Uint32Array(plyMx);       //time to finish race
var chckZm= 8;                              //minimum size of checkpoints
var chckZ = chckZm;                         //size of all checkpoints
var chckT = 0;                              //race countdown
var chckT2= 0;                              //to change chckE text
var chckE = null;                           //html showing countdown
var chckA = 0;                              //explode animation
var chckGPUo = false;                       //update GPU texture
var chckAP = new Float32Array(plyMx);       //player checkpoint grab animation

var chckLvO= 3;                                 //default lives
var chckLv = new Uint8Array(plyMx);             //players current lives left til revive from previous check
var chckBn = 4;                                 //how many revive properties(ballposition,joints,rotor...)
var chckBP = new Float32Array(bllMx4);          //for revive  position
var chckBP2= new Float32Array(bllMx4);          //for revive  position previous chck
var chckBJ = new Uint16Array(bJotMx*bJotNe);    //for revive  joints
var chckBJ2= new Uint16Array(bJotMx*bJotNe);    //for revive  joints   previous chck
var chckBR = new Uint16Array(bRotMx*bRotNe);    //for revive  rototrs
var chckBR2= new Uint16Array(bRotMx*bRotNe);    //for revive  rototrs  previous chck
var chckBM = new Uint16Array(plyMx*chckBn*2);   //each machine property location in revive list
var chckBo = 0;                                 //if there is revive data
var chckBc1= new Uint16Array(plyMx);            //for revive  which ball posessed
var chckBc2= new Float32Array(plyMx*4);         //for revive  camera direction distance
var chckToClip;

//breaks multiplayer while fixing revive without deleting previous dead bodies
var chckHk  = 0;//number of revives modulo plyMx
var chckHkJ = 0;//location of machine in bJot
var chckHkR = 0;//location of machine in bRot

var icoMshZ = 1920;//960 1920
var icoMsh3 = (icoMshZ>>2);             //points in mesh
function icosaedronGen()
{
    var ow = meshXz*meshW;  ++meshW;

    var x=.525731112119;
    var z=.850650808352;
    var y=0;
    var p = [-x,y,z, x,y,z, -x,y,-z, x,y,-z,
             y,z,x, y,z,-x, y,-z,x, y,-z,-x,
             z,x,y, -z,x,y, z,-x,y, -z,-x,y];
    var n = [0,4,1,0,9,4,9,5,4,4,5,8,4,8,1,
             8,10,1,8,3,10,5,3,8,5,2,3,2,7,3,
             7,10,3,7,6,10,7,11,6,11,0,6,0,1,6,
             6,1,10,9,0,11,9,11,2,9,2,5,7,2,11];
    
    var n3 = n.length/3;
    var w  = 0;
    for(var i = 0; i < n3; ++i)//icosaedron
    {
        var i3 = i*3;
        var a = n[i3+0]*3;
        var b = n[i3+1]*3;
        var c = n[i3+2]*3;

        var a0 = p[a+0];
        var a1 = p[a+1];
        var a2 = p[a+2];

        var b0 = p[b+0];
        var b1 = p[b+1];
        var b2 = p[b+2];

        var c0 = p[c+0];
        var c1 = p[c+1];
        var c2 = p[c+2];

        var l = 0;
        var ab0 = a0+b0;
        var ab1 = a1+b1;
        var ab2 = a2+b2;  l = Math.sqrt(ab0*ab0 + ab1*ab1 + ab2*ab2);
                          ab0 /= l;
                          ab1 /= l;
                          ab2 /= l;
        var bc0 = b0+c0;
        var bc1 = b1+c1;
        var bc2 = b2+c2;  l = Math.sqrt(bc0*bc0 + bc1*bc1 + bc2*bc2);
                          bc0 /= l;
                          bc1 /= l;
                          bc2 /= l;
        var ca0 = c0+a0;
        var ca1 = c1+a1;
        var ca2 = c2+a2;  l = Math.sqrt(ca0*ca0 + ca1*ca1 + ca2*ca2);
                          ca0 /= l;
                          ca1 /= l;
                          ca2 /= l;
        meshXY[ow+w] =  a0;    ++w;
        meshXY[ow+w] =  a1;    ++w;
        meshXY[ow+w] =  a2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ab0;    ++w;
        meshXY[ow+w] = ab1;    ++w;
        meshXY[ow+w] = ab2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ca0;    ++w;
        meshXY[ow+w] = ca1;    ++w;
        meshXY[ow+w] = ca2;    ++w;
        meshXY[ow+w] =   0;    ++w;

        meshXY[ow+w] =  b0;    ++w;
        meshXY[ow+w] =  b1;    ++w;
        meshXY[ow+w] =  b2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = bc0;    ++w;
        meshXY[ow+w] = bc1;    ++w;
        meshXY[ow+w] = bc2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ab0;    ++w;
        meshXY[ow+w] = ab1;    ++w;
        meshXY[ow+w] = ab2;    ++w;
        meshXY[ow+w] =   0;    ++w;

        meshXY[ow+w] =  c0;    ++w;
        meshXY[ow+w] =  c1;    ++w;
        meshXY[ow+w] =  c2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ca0;    ++w;
        meshXY[ow+w] = ca1;    ++w;
        meshXY[ow+w] = ca2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = bc0;    ++w;
        meshXY[ow+w] = bc1;    ++w;
        meshXY[ow+w] = bc2;    ++w;
        meshXY[ow+w] =   0;    ++w;

        meshXY[ow+w] = ab0;    ++w;
        meshXY[ow+w] = ab1;    ++w;
        meshXY[ow+w] = ab2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = bc0;    ++w;
        meshXY[ow+w] = bc1;    ++w;
        meshXY[ow+w] = bc2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ca0;    ++w;
        meshXY[ow+w] = ca1;    ++w;
        meshXY[ow+w] = ca2;    ++w;
        meshXY[ow+w] =   0;    ++w;
    }
    for(var i = 0; i < n3; ++i)//stiky
    {
        var i3 = i*3;
        vec3(0, p[i3+0]*.4,
                p[i3+1]*.4,
                p[i3+2]*.4);
        normalize3(3,0);
        vec3(6, 0,1,0);
        cros3(6,3,6);
        normalize3(6,6);
        cros3(9,3,6);

        var ro = 4;
        for(var j = 0; j < ro; ++j)
        {
            vec3(12+j*3,                      0,
                         Math.cos(j*pi*2/ro)*.2,
                         Math.sin(j*pi*2/ro)*.2);
            mul93(12+j*3, 3,12+j*3);
        }
        for(var j = 0; j < ro; ++j)
        {
            var j0 = 12+( j+0    )*3;
            var j1 = 12+((j+1)%ro)*3;
            meshXY[ow+w] = fmar[0] + fmar[  +0];    ++w;
            meshXY[ow+w] = fmar[1] + fmar[  +1];    ++w;
            meshXY[ow+w] = fmar[2] + fmar[  +2];    ++w;
            meshXY[ow+w] =                    0;    ++w;
            meshXY[ow+w] = fmar[0] + fmar[j1+0];    ++w;
            meshXY[ow+w] = fmar[1] + fmar[j1+1];    ++w;
            meshXY[ow+w] = fmar[2] + fmar[j1+2];    ++w;
            meshXY[ow+w] =                    0;    ++w;
            meshXY[ow+w] = fmar[0] + fmar[j0+0];    ++w;
            meshXY[ow+w] = fmar[1] + fmar[j0+1];    ++w;
            meshXY[ow+w] = fmar[2] + fmar[j0+2];    ++w;
            meshXY[ow+w] =                    0;    ++w;
        }
    }

    w = w;
}
var jotMshZ = 960;
var jotMsh3 = (jotMshZ>>2);             //triangles in mesh
function jointGen()
{
    var ow = meshXz*meshW;  ++meshW;

    var w  = 0;
    //var arr = [  0,  0,-.3,   var jotMshZ = 192;
    //            .3,  0,  1,
    //             0, .3,  1,

    //            .3,  0,  1,
    //             0,  0,  1,
    //             0, .3,  1
    //          ];
    var arr = [ 0.00,0.50,1.0,
                0.35,0.35,1.0,
                0.00,0.00,1.0,
                0.35,0.35,1.0,
                0.50,0.00,1.0,
                0.00,0.00,1.0,
                0.30,0.00,0.0,
                0.24,0.24,0.5,
                0.21,0.21,0.0,
                0.21,0.21,0.0,
                0.00,0.35,0.5,
                0.00,0.30,0.0,
                0.35,0.00,0.5,
                0.35,0.35,1.0,
                0.24,0.24,0.5,
                0.24,0.24,0.5,
                0.00,0.50,1.0,
                0.00,0.35,0.5,
                0.30,0.00,0.0,
                0.35,0.00,0.5,
                0.24,0.24,0.5,
                0.21,0.21,0.0,
                0.24,0.24,0.5,
                0.00,0.35,0.5,
                0.35,0.00,0.5,
                0.50,0.00,1.0,
                0.35,0.35,1.0,
                0.24,0.24,0.5,
                0.35,0.35,1.0,
                0.00,0.50,1.0];

    for(var j = 0; j < arr.length; ++j)
    {
                     meshXY[ow+w] = arr[j];    ++w;
        if((w&3)==3){meshXY[ow+w] =      0;    ++w;}
    }

    var xyz = new Float32Array(4);
    for(var j = 0; j < 3; ++j)//reflect mesh in xyz
    {
        xyz[0] = 1;
        xyz[1] = 1;
        xyz[2] = 1;
        xyz[3] = 1;
        xyz[j] =-1;
        var cnt = (w>>2)/3;
        for(var i = 0; i < cnt; ++i)
        {
            var i4 = (i*3)<<2;
            meshXY[ow+w] = xyz[0]*meshXY[ow+i4+ 0];    ++w;
            meshXY[ow+w] = xyz[1]*meshXY[ow+i4+ 1];    ++w;
            meshXY[ow+w] = xyz[2]*meshXY[ow+i4+ 2];    ++w;
            meshXY[ow+w] = xyz[3]*meshXY[ow+i4+ 3];    ++w;

            meshXY[ow+w] = xyz[0]*meshXY[ow+i4+ 8];    ++w;
            meshXY[ow+w] = xyz[1]*meshXY[ow+i4+ 9];    ++w;
            meshXY[ow+w] = xyz[2]*meshXY[ow+i4+10];    ++w;
            meshXY[ow+w] = xyz[3]*meshXY[ow+i4+11];    ++w;

            meshXY[ow+w] = xyz[0]*meshXY[ow+i4+ 4];    ++w;
            meshXY[ow+w] = xyz[1]*meshXY[ow+i4+ 5];    ++w;
            meshXY[ow+w] = xyz[2]*meshXY[ow+i4+ 6];    ++w;
            meshXY[ow+w] = xyz[3]*meshXY[ow+i4+ 7];    ++w;
        }
    }
    w = w;
}
var rotMshZ = 672;
var rotMsh3 = (rotMshZ>>2);             //triangles in mesh
function rotatorGen()
{
    //only one of three legs of rotator data
    var ow = meshXz*meshW;  ++meshW;

    var w  = 0;
    var arr = [
     1.14,0.79,1.27,
     0.00,0.00,1.78,
     0.00,1.00,1.43,
     0.00,1.00,1.43,
     0.00,0.00,1.06,
     1.14,0.79,1.27,
     2.60,0.00,0.66,
     1.56,0.00,1.40,
     1.14,0.79,1.27,
     1.14,0.79,1.27,
     1.20,0.00,1.00,
     2.60,0.00,0.66,
     0.70,0.70,3.00,
     0.00,0.00,4.00,
     0.00,1.00,3.00,
     0.00,1.00,3.00,
    -0.02,0.00,2.67,
     0.70,0.70,3.00,
     0.00,1.00,5.00,
    -0.02,0.00,4.67,
     0.70,0.70,5.00,
     0.70,0.70,5.00,
     0.00,0.00,6.00,
     0.00,1.00,5.00,
     0.00,0.00,1.78,
     1.14,0.79,1.27,
     1.56,0.00,1.40,
     1.14,0.79,1.27,
     0.00,0.00,1.06,
     1.20,0.00,1.00,
     0.70,0.70,3.00,
     1.00,0.00,3.00,
     0.00,0.00,4.00,
     1.00,0.00,3.00,
     0.70,0.70,3.00,
    -0.02,0.00,2.67,
     0.70,0.70,5.00,
     1.00,0.00,5.00,
     0.00,0.00,6.00,
     1.00,0.00,5.00,
     0.70,0.70,5.00,
    -0.02,0.00,4.67];
    for(var j = 0; j < arr.length; ++j)
    {
                     meshXY[ow+w] = arr[j];    ++w;
        if((w&3)==3){meshXY[ow+w] = 0;         ++w;}
    }
    for(var j = 0; j < w; ++j){meshXY[ow+j] *= 1/6;}//resize

    var xyz = new Float32Array(4);
    for(var j = 0; j < 2; ++j)//reflect mesh in xy
    {
        xyz[0] = 1;
        xyz[1] = 1;
        xyz[2] = 1;
        xyz[3] = 1;
        xyz[j] =-1;
        var cnt = (w>>2)/3;
        for(var i = 0; i < cnt; ++i)
        {
            var i4 = (i*3)<<2;
            meshXY[ow+w] = xyz[0]*meshXY[ow+i4+ 0];    ++w;
            meshXY[ow+w] = xyz[1]*meshXY[ow+i4+ 1];    ++w;
            meshXY[ow+w] = xyz[2]*meshXY[ow+i4+ 2];    ++w;
            meshXY[ow+w] = xyz[3]*meshXY[ow+i4+ 3];    ++w;

            meshXY[ow+w] = xyz[0]*meshXY[ow+i4+ 8];    ++w;
            meshXY[ow+w] = xyz[1]*meshXY[ow+i4+ 9];    ++w;
            meshXY[ow+w] = xyz[2]*meshXY[ow+i4+10];    ++w;
            meshXY[ow+w] = xyz[3]*meshXY[ow+i4+11];    ++w;

            meshXY[ow+w] = xyz[0]*meshXY[ow+i4+ 4];    ++w;
            meshXY[ow+w] = xyz[1]*meshXY[ow+i4+ 5];    ++w;
            meshXY[ow+w] = xyz[2]*meshXY[ow+i4+ 6];    ++w;
            meshXY[ow+w] = xyz[3]*meshXY[ow+i4+ 7];    ++w;
        }
    }
    w = w;
}
var chkMshZ = 1344;//960 1008 1344
var chkMsh3 = (chkMshZ>>2);             //points in mesh
function checkpointGen()
{
    var ow = meshXz*meshW;  ++meshW;

    var x=.525731112119;
    var z=.850650808352;
    var y=0;
    var p = [-x,y,z, x,y,z, -x,y,-z, x,y,-z,
             y,z,x, y,z,-x, y,-z,x, y,-z,-x,
             z,x,y, -z,x,y, z,-x,y, -z,-x,y];
    var n = [0,4,1,0,9,4,9,5,4,4,5,8,4,8,1,
             8,10,1,8,3,10,5,3,8,5,2,3,2,7,3,
             7,10,3,7,6,10,7,11,6,11,0,6,0,1,6,
             6,1,10,9,0,11,9,11,2,9,2,5,7,2,11];
    
    var n3 = n.length/3;
    var w  = 0;
    for(var i = 0; i < n3; ++i)//icosaedron
    {
        var i3 = i*3;
        var a = n[i3+0]*3;
        var b = n[i3+1]*3;
        var c = n[i3+2]*3;

        var a0 = p[a+0];
        var a1 = p[a+1];
        var a2 = p[a+2];

        var b0 = p[b+0];
        var b1 = p[b+1];
        var b2 = p[b+2];

        var c0 = p[c+0];
        var c1 = p[c+1];
        var c2 = p[c+2];

        var l = 0;
        var ab0 = a0+b0;
        var ab1 = a1+b1;
        var ab2 = a2+b2;  l = Math.sqrt(ab0*ab0 + ab1*ab1 + ab2*ab2);
                          ab0 /= l;
                          ab1 /= l;
                          ab2 /= l;
        var bc0 = b0+c0;
        var bc1 = b1+c1;
        var bc2 = b2+c2;  l = Math.sqrt(bc0*bc0 + bc1*bc1 + bc2*bc2);
                          bc0 /= l;
                          bc1 /= l;
                          bc2 /= l;
        var ca0 = c0+a0;
        var ca1 = c1+a1;
        var ca2 = c2+a2;  l = Math.sqrt(ca0*ca0 + ca1*ca1 + ca2*ca2);
                          ca0 /= l;
                          ca1 /= l;
                          ca2 /= l;
        meshXY[ow+w] =  a0;    ++w;
        meshXY[ow+w] =  a1;    ++w;
        meshXY[ow+w] =  a2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ab0;    ++w;
        meshXY[ow+w] = ab1;    ++w;
        meshXY[ow+w] = ab2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ca0;    ++w;
        meshXY[ow+w] = ca1;    ++w;
        meshXY[ow+w] = ca2;    ++w;
        meshXY[ow+w] =   0;    ++w;

        meshXY[ow+w] =  b0;    ++w;
        meshXY[ow+w] =  b1;    ++w;
        meshXY[ow+w] =  b2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = bc0;    ++w;
        meshXY[ow+w] = bc1;    ++w;
        meshXY[ow+w] = bc2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ab0;    ++w;
        meshXY[ow+w] = ab1;    ++w;
        meshXY[ow+w] = ab2;    ++w;
        meshXY[ow+w] =   0;    ++w;

        meshXY[ow+w] =  c0;    ++w;
        meshXY[ow+w] =  c1;    ++w;
        meshXY[ow+w] =  c2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ca0;    ++w;
        meshXY[ow+w] = ca1;    ++w;
        meshXY[ow+w] = ca2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = bc0;    ++w;
        meshXY[ow+w] = bc1;    ++w;
        meshXY[ow+w] = bc2;    ++w;
        meshXY[ow+w] =   0;    ++w;

        meshXY[ow+w] = ab0;    ++w;
        meshXY[ow+w] = ab1;    ++w;
        meshXY[ow+w] = ab2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = bc0;    ++w;
        meshXY[ow+w] = bc1;    ++w;
        meshXY[ow+w] = bc2;    ++w;
        meshXY[ow+w] =   0;    ++w;
        meshXY[ow+w] = ca0;    ++w;
        meshXY[ow+w] = ca1;    ++w;
        meshXY[ow+w] = ca2;    ++w;
        meshXY[ow+w] =   0;    ++w;
    }

    //arrow and line for drawing checkpoint
    var a = 1/1024;
    var b = .6;
    var c = 1/16;
    var d = .2;
    var e = .4;
    //var arr = [b,0,0, 0,0,b, -b,0,0,    b,0,-b, 0,0,0, -b,0,-b,     //arrow
    //           0,b,0, 0,0,b, 0,-b,0,    0,b,-b, 0,0,0, 0,-b,-b,     //arrow
    //           c,0,-a, 0,0,a, -c,0,-a,                              //line
    //           0,c,-a, 0,0,a, 0,-c,-a];                             //line
    var arr = [d,d,-e, 0,0,b, -d,d,-e,    -d,-d,-e, 0,0,b, d,-d,-e,   //arrow
               d,-d,-e, 0,0,b, d,d,-e,    -d,d,-e, 0,0,b, -d,-d,-e];
    for(var j = 0; j < arr.length; ++j)
    {
                     meshXY[ow+w] = arr[j];    ++w;
        if((w&3)==3){meshXY[ow+w] =      0;    ++w;}
    }

    a = .073;
    var xi = 5;
    var yj = 3;
    arr = [-a,a,0,   a,-a,0,  -a,-a,0,     //square to that direction
           -a,a,0,   a, a,0,   a,-a,0];

    for(var i = 0; i < xi; ++i){
    for(var j = 0; j < yj; ++j){    if((j&1)!=0 && i==xi-1){continue;}
        for(var k = 0; k < arr.length; ++k)
        {
                         meshXY[ow+w] = arr[k];     
            if((w&3)==0){meshXY[ow+w]+= i*a*4 - (xi-1)*.5*a*4 + (j&1)*a*2;}
            if((w&3)==1){meshXY[ow+w]+= j*a*2 - (yj-1)*.5*a*2;} ++w;
            if((w&3)==3){meshXY[ow+w] =      0;                 ++w;}
        }
    }}

    w = w;
}

var meshXz  = Math.max(Math.max(Math.max(icoMshZ,jotMshZ),rotMshZ),chkMshZ);//each mesh for each row in texture
var meshYz  = 4;//how many meshes
var meshXz3 = meshXz>>2;
var meshXY  = new Float32Array(meshXz*meshYz);//3position 1nothing then other half 3normal 1nothing
var meshW   = 0;//write location Y axis

var drwOrb = .001;

function camRsz()
{
    //var pxrt = 1;//devicePixelRatio*2;
    var rect = cnvs.getBoundingClientRect();
    scrX = Math.floor(rect.width *resO);//*pxrt;
    scrY = Math.floor(rect.height*resO);//*pxrt;
    cnvs.width  = scrX;
    cnvs.height = scrY;
    prj0 = prj1 * scrY/scrX;
}
function iniWorld()
{
    timP = performance.now();
    timW = timP;             

    kysW = 0;
    kysR = 0;
    
    for(var i = 0; i < plyMx*camN;)
    {
        cam[i] = 0;       ++i;
        cam[i] = 0;       ++i;
        cam[i] = 1;       ++i;
        cam[i] = 0;       ++i;
        cam[i] = 4;       ++i;
        cam[i] = 0;       ++i;
        cam[i] = 3;       ++i;
        cam[i] = 1/8;     ++i;
        cam[i] = 32;      ++i;
    }
    for(var i = 0; i < plyMx; ++i){  kys[i] = 0;}
    for(var i = 0; i < plyMx; ++i){bllGi[i] = 0;}
    for(var i = 0; i < plyMx; ++i){bllGd[i] = 0;}

    for(var i = 0; i < plyMx*bSelH; ++i){bSel[i] = 0;}
    for(var i = 0; i < plyMx; ++i){bSeln[i] = 0;}
    for(var i = 0; i < plyMx; ++i){pMenu[i] = 0;}
    
    for(var i = 0; i < bllMx4;)
    {
        bllP[i] = (Math.random()*2-1)*2048;    ++i;
        bllP[i] = (Math.random()*2-0)*2048;    ++i;
        bllP[i] = (Math.random()*2-1)*2048;    ++i;
        bllP[i] =                        0;    ++i;
    }
    for(var i = 0; i < bllMx4; ++i){bllV[i] = 0;}
    for(var i = 0; i < bll3D3; ++i){bllS[i] = bllMx;}

    for(var i = 0; i < plyMx; ++i){keySl[(i<<1)+0] = 3;
                                   keySl[(i<<1)+1] = 5;}

    for(var i = 0; i < plyMx; ++i){chckG[(i<<1)+0] = 0;
                                   chckG[(i<<1)+1] = 0;}

    //for(var i = 0; i < bllMx; ++i){bStk[i]=0;}

    bJotN = 0;  bJotDN = 0;
    bRotN = 0;
    

    //gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bllMx,1, gl.RGBA, gl.FLOAT, bllP);

    bJotGPUo = true;
    bRotGPUo = true;
    chckGPUo = true;

    rndu = 127|0;
}
function clearPlySel(p)
{
    var w = p*bSelH;
    for(var i = 0; i < bSelH; ++i){bSel[w+i] = 0;}
}
function phyStep()
{
    var ttii = performance.now();
    timD = ttii-timW;  timD2 += (timD-timD2)*.1;
    timW = ttii;
    
    if(timW-timP>5000){timP = timW;}
    while(timP < timW)//add input
    {
        timP += 1000/inpPs;
        if(escPss+1==kysW){escPss = -2; inpKy = inpKy&(~(1<<7));}
        if(inpWeel> 0){inpKy = inpKy|  (1<<8) ;}
        if(inpWeel< 0){inpKy = inpKy|  (1<<9) ;}
        if(inpWeel==0){inpKy = inpKy&(~(3<<8));} inpWeel = 0;
        kys[kysW&(kysT-1)] = inpKy | (Math.min(Math.max(inpXd*1024+1024.5,0),2047)<<10)| 
                                     (Math.min(Math.max(inpYd*1024+1024.5,0),2047)<<21);    ++kysW;
        inpXd = 0;
        inpYd = 0;
    }
    while(kysR!=kysW)
    {
      for(var ii = 0; ii < kysPs; ++ii)
      {
        //players inputs
        for(var i = 0; i < plyMx; ++i)
        {
            if((plyA&(1<<i))==0){continue;}

            var r = i*kysT;
            var ky  = kys[r+( kysR   &(kysT-1))];
            var ky2 = kys[r+((kysR-1)&(kysT-1))];

            var iono = chckG[(i<<1)+1]!=0 && (ky&(1<<7))!=0 && pMenu[i]==6;

            var cmr = camN*i;
            //camMove
            var fb = (((ky&(1<<1))!=0)|0) - (((ky&(1<<4))!=0)|0);
            var lr = (((ky&(1<<3))!=0)|0) - (((ky&(1<<5))!=0)|0);
            var ud = (((ky&(1<<0))!=0)|0) - (((ky&(1<<2))!=0)|0);
            if(fb!=0)
            {
                fb *= cam[cmr+7];
                cam[cmr+3] += cam[cmr+0]*fb;
                cam[cmr+4] += cam[cmr+1]*fb;
                cam[cmr+5] += cam[cmr+2]*fb;
            }
            if(lr!=0)
            {
                lr *= cam[cmr+7]/Math.sqrt(cam[cmr+0]*cam[cmr+0] + cam[cmr+2]*cam[cmr+2]);
                cam[cmr+3] += - cam[cmr+2]*lr;
                cam[cmr+5] += + cam[cmr+0]*lr;
            }
            if(ud!=0)
            {
                ud *= cam[cmr+7];
                var a = 1/Math.sqrt(cam[cmr+0]*cam[cmr+0] + cam[cmr+2]*cam[cmr+2]);
                var crv0 = - cam[cmr+2]*a;
                var crv2 = + cam[cmr+0]*a;
                var cup0 =-crv2*cam[cmr+1];
                var cup1 = crv2*cam[cmr+0] - crv0*cam[cmr+2];
                var cup2 = crv0*cam[cmr+1];
                cam[cmr+3] += cup0*ud;
                cam[cmr+4] += cup1*ud;
                cam[cmr+5] += cup2*ud;
            }
            //camRotate
            var kyX2 = (((ky>>10)&2047)-1024)/1024*cam[cmr+6]/kysPs;
            var kyY2 = (((ky>>21)&2047)-1024)/1024*cam[cmr+6]/kysPs;
            var kyX = -kyX2;
            var kyY = -kyY2;
            if(iono){kyX = 0;
                     kyY = 0;}
            var upv0 = 0;
            var upv1 = 1;
            var upv2 = 0;
            if((plyE&(1<<i))!=0 && ((nGair&(1<<1))!=0 || (nGair&(1<<2))!=0))//center gravity
            {
                var b  = camB[i]<<2;
                var a0 = bllP[b+0];
                var a1 = bllP[b+1];
                var a2 = bllP[b+2];
                var l  = 1/Math.sqrt(a0*a0 + a1*a1 + a2*a2);
                upv0 = a0*l;
                upv1 = a1*l;
                upv2 = a2*l;
            }
            //rotate mouseX
            var r1 = Math.cos(kyX);
            var r2 = Math.sin(kyX);
            var crv0 = upv1*cam[cmr+2] - upv2*cam[cmr+1];
            var crv1 = upv2*cam[cmr+0] - upv0*cam[cmr+2];
            var crv2 = upv0*cam[cmr+1] - upv1*cam[cmr+0];
            var crv3 = (upv0*cam[cmr+0] + upv1*cam[cmr+1] + upv2*cam[cmr+2])*(1-r1);
            cam[cmr+0] = cam[cmr+0]*r1 + crv0*r2 + upv0*crv3;
            cam[cmr+1] = cam[cmr+1]*r1 + crv1*r2 + upv1*crv3;
            cam[cmr+2] = cam[cmr+2]*r1 + crv2*r2 + upv2*crv3;
            //rotate mouseY
            var r3 = Math.asin(upv0*cam[cmr+0] + upv1*cam[cmr+1] + upv2*cam[cmr+2]) - kyY;
            if(r3 >  pi*.49 ||
               r3 < -pi*.49 ){kyY = 0;}
                r1 = Math.cos(kyY);
                r2 = Math.sin(kyY);
                crv0 = upv1*cam[cmr+2] - upv2*cam[cmr+1];
                crv1 = upv2*cam[cmr+0] - upv0*cam[cmr+2];
                crv2 = upv0*cam[cmr+1] - upv1*cam[cmr+0];
            var cup0 = crv1*cam[cmr+2] - crv2*cam[cmr+1];
            var cup1 = crv2*cam[cmr+0] - crv0*cam[cmr+2];
            var cup2 = crv0*cam[cmr+1] - crv1*cam[cmr+0];
            var llll = 1/Math.sqrt(cup0*cup0 + cup1*cup1 + cup2*cup2);
                cup0 *= llll;
                cup1 *= llll;
                cup2 *= llll;
            cam[cmr+0] = cam[cmr+0]*r1 + cup0*r2;
            cam[cmr+1] = cam[cmr+1]*r1 + cup1*r2;
            cam[cmr+2] = cam[cmr+2]*r1 + cup2*r2;
            
            if(pMenu[i]==5 && machAdd[i]==1 && ii==0)    //before adding machine
            {
                //var m = 1;
                //if((ky&(1<<8))!=0){m*=1/1.25;}
                //if((ky&(1<<9))!=0){m*=  1.25;}
                //machL2[i] *= m;                 //change distance of add machine
                if((ky&(1<<6))!=0)              //cancel add machine
                {
                    machAdd[i] = 0;
                    helpBs = -1;
                }
            }

            var pss = (plyE&(1<<i))!=0;//posses mode
            if(!pss && ii==0)//camera speed
            {
                var m = 1;
                if((ky&(1<<8))!=0){m*=1/1.25;}
                if((ky&(1<<9))!=0){m*=  1.25;}
                cam[cmr+7] *= m;
            }
            if(pss && ii==0)//camera distance in possess mode
            {
                var m = 1;
                if((ky&(1<<8))!=0){m*=  1.125;}
                if((ky&(1<<9))!=0){m*=1/1.125;}
                cam[cmr+8] *= m;
            }
            if(pss && ii==0 && (((ky &(1<<7))!=0 && //get out of possess mode
                                 (ky2&(1<<7))==0 ) || pMenu[i]!=4))
            {
                plyE = plyE & (~(1<<i));
                var l = cam[cmr+8];
                var b = camB[i]<<2;
                cam[cmr+3] = bllP[b+0]-cam[cmr+0]*l+shdVec[0]*l*camHl;
                cam[cmr+4] = bllP[b+1]-cam[cmr+1]*l+shdVec[1]*l*camHl;
                cam[cmr+5] = bllP[b+2]-cam[cmr+2]*l+shdVec[2]*l*camHl;
                if(i==plyMe)
                {
                    camAt = 1;
                    camA[0] = cam[cmr+0];
                    camA[1] = cam[cmr+1];
                    camA[2] = cam[cmr+2];
                    camA[3] = cam[cmr+3];
                    camA[4] = cam[cmr+4];
                    camA[5] = cam[cmr+5];
                    camA[6] = shdVec[0];
                    camA[7] = shdVec[1];
                    camA[8] = shdVec[2];
                }
            }
            if(pss){continue;}//in possess mode
            if((ky &(1<<7))!=0 && 
               (ky2&(1<<7))==0 && ii==0)//grab
            {
                var bi = -1;
                var bd = 99999;
                for(var j = 0; j < bllMx; ++j)
                {
                    var j4 = j<<2;
                    var l0 = bllP[j4+0]-cam[cmr+3];
                    var l1 = bllP[j4+1]-cam[cmr+4];
                    var l2 = bllP[j4+2]-cam[cmr+5];
                    var d  = +cam[cmr+0]*l0
                             +cam[cmr+1]*l1
                             +cam[cmr+2]*l2;
                    var a = +l0*l0
                            +l1*l1
                            +l2*l2-d*d;
                    if(a<1 && d>0 && d<bd){bd = d;
                                           bi = j;}
                }
                bllGd[i] = bd;
                bllGi[i] = bi;

                if(bi>=0 && pMenu[i]!=4 && !(pMenu[i]==5 && machAdd[i]==1))//set bit of selected ball
                {
                    if(i==plyMe)//for rendering my selection
                    {
                        bSelMe[bSeln[i]] = bi;
                        if(pMenu[i]==5){helpBs = 4;}
                    }
                    if(pMenu[i]==2){bRotS[(i<<2)+bSeln[i]] = bi;}
                    var rd = i*bSelH + (bi>>5);
                    var vw = 1<<(bi&31);
                    var ae = (bSel[rd] & vw)==0;
                    if( ae && bSeln[i]<mchBMx){++bSeln[i];  bSel[rd] = bSel[rd] |   vw ;}
                    if(!ae                   ){--bSeln[i];  bSel[rd] = bSel[rd] & (~vw);}
                }
                if(bi>=0 && pMenu[i]==1 && bSeln[i]==2 && bJotN != bJotMx)//add joint
                {
                    var rd = i*bSelH;
                    var wt = 0;
                    for(var j = 0; j < bllMx; ++j){if((bSel[rd+(j>>5)] & (1<<(j&31)))!=0){bSelG[wt]=j; ++wt;}}

                    var mi = bSelG[0];
                    var ma = bSelG[1];
                    var j = 0;
                    var ja = bJotN*bJotNe;
                    var jl = (bJotl/bJotMl)|0;  if(jl>=(1<<16)){jl = (1<<16)-1;}
                    var jf = (bJotf/bJotMf)|0;  if(jf>=(1<<16)){jf = (1<<16)-1;}
                    var jk = (keySl[(i<<1)+0]<< 0)|
                             (keySl[(i<<1)+1]<< 4)|
                             (i       << 8)|
                             (bJote   <<12);
                    while(j < ja && !(bJot[j+0]  == mi &&
                                      bJot[j+1]  == ma ) ){j+=bJotNe;}

                         if(j == ja)         {++bJotN;}                         //add    joint
                    else if(bJot[j+2] == jl &&
                            bJot[j+3] == jf &&
                            bJot[j+4] == jk ){--bJotN;        var re = bJotN*bJotNe;
                                                        mi = bJot[re+0];        //delete joint
                                                        ma = bJot[re+1];
                                                        jl = bJot[re+2]; 
                                                        jf = bJot[re+3];
                                                        jk = bJot[re+4];}
                  //else       {}                                               //replace joint
                    bJot[j+0] = mi;
                    bJot[j+1] = ma;
                    bJot[j+2] = jl;
                    bJot[j+3] = jf;
                    bJot[j+4] = jk;

                    bJotGPUo = true;

                    bSeln[i] = 0;
                    clearPlySel(i);
                }
                if(bi>=0 && pMenu[i]==2 && bSeln[i]==3 && bRotN != bRotMx)//add rotor
                {
                    //because ballsID get sorted then rotation dir is lost
                    //if rotation dir is fliped by sort then apply swap
                    var ro0 = keySl[(i<<1)+0];
                    var ro1 = keySl[(i<<1)+1];
                    var e0 = bRotS[(i<<2)+0];
                    var e1 = bRotS[(i<<2)+1];
                    var e2 = bRotS[(i<<2)+2];
                    var rr = +(e0>e1)*1
                             +(e0>e2)*2
                             +(e1>e2)*4;
                    if(rr==1 || rr==4 || rr==7)//swap
                    {
                        var tmp = ro0;
                            ro0 = ro1;
                            ro1 = tmp;
                    }
                    var rd = i*bSelH;
                    var wt = 0;
                    for(var j = 0; j < bllMx; ++j){if((bSel[rd+(j>>5)] & (1<<(j&31)))!=0){bSelG[wt]=j; ++wt;}}
                    
                    var j = 0;
                    var ja = bRotN*bRotNe;
                    var jf = (bRotf/bRotMf)|0;  if(jf>=(1<<16)){jf = (1<<16)-1;}
                    var jt = (bRott/bRotMt)|0;  if(jt>=(1<<16)){jt = (1<<16)-1;}
                    var jk = (ro0<< 0)|
                             (ro1<< 4)|
                             (i  << 8);
                    while(j < ja && !(bRot[j+0] == bSelG[0] &&
                                      bRot[j+1] == bSelG[1] &&
                                      bRot[j+2] == bSelG[2] )){j+=bRotNe;}
                                     
                         if(j == ja)        {++bRotN;}                          //add     rotor
                    else if(bRot[j+3] == jf &&
                            bRot[j+4] == jt &&
                            bRot[j+5] == jk){--bRotN;            var re = bRotN*bRotNe;
                                                      bSelG[0] = bRot[re+0];    //delete  rotor
                                                      bSelG[1] = bRot[re+1];
                                                      bSelG[2] = bRot[re+2]; 
                                                      jf       = bRot[re+3];
                                                      jt       = bRot[re+4];
                                                      jk       = bRot[re+5];}
                  //else       {}                                               //replace rotor
                    bRot[j+0] = bSelG[0];
                    bRot[j+1] = bSelG[1];
                    bRot[j+2] = bSelG[2];
                    bRot[j+3] = jf      ;
                    bRot[j+4] = jt      ;
                    bRot[j+5] = jk      ;
   
                    bRotGPUo = true;

                    bSeln[i] = 0;
                    clearPlySel(i);
                }
                if(bi>=0 && pMenu[i]==3 && bSeln[i]==1                   )//add stiky
                {
                    var rd = i*bSelH;
                    var wt = 0;
                    for(var j = 0; j < bllMx; ++j){if((bSel[rd+(j>>5)] & (1<<(j&31)))!=0){bSelG[wt]=j; ++wt;}}
                    var jk = (keySl[(i<<1)+0]<<0)|//keys to enable
                             (i              <<4)|//player
                             (1              <<8)|//sticky is enabled
                             (1              <<9);//ball has sticky
                    wt = (bSelG[0]<<2)+3;
                    if(bllP[wt]==0){bllP[wt] = jk;}
                    else           {bllP[wt] =  0;}

                    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bllMx,1, gl.RGBA, gl.FLOAT, bllP);

                    bSeln[i] = 0;
                    clearPlySel(i);
                }
                if(bi< 0 &&(pMenu[i]==1 || pMenu[i]==2))
                {
                    bSeln[i] = 0;
                    clearPlySel(i);
                }
                if(bi>=0 && pMenu[i]==4)//possess ball
                {
                    camB[i] = bi;
                    plyE = plyE|(1<<i);
                    helpBs = -1;
                    if(i==plyMe)
                    {
                        camAt = 1;
                        camA[0] = cam[cmr+0];
                        camA[1] = cam[cmr+1];
                        camA[2] = cam[cmr+2];
                        camA[3] = cam[cmr+3];
                        camA[4] = cam[cmr+4];
                        camA[5] = cam[cmr+5];
                        camA[6] = shdVec[0];
                        camA[7] = shdVec[1];
                        camA[8] = shdVec[2];
                    }
                }
                if(bi<0 && pMenu[i]==5 && machAdd[i]==0)//show machine to add
                {
                    ++machAdd[i];
                    machL2[i] = machL[machS[i]]*2.5;
                    helpBs = 2;
                }
                else if(pMenu[i]==5 && machAdd[i]==1)//add machine
                    {
                        machAdd[i] = 0;
                        helpBs = -1;

                        var w = 0;

                        var wp = machS[i];          //selected machine

                        var mi0 = machAd>>2;        //lower range of ballID added
                        var ma0 = mi0+machBn[wp];   //upper range of ballID added
                        var mi1 = 0;                //lower range of ballID added
                        var ma1 = 0;                //upper range of ballID added
                        if(ma0>bllMx)
                        {
                            ma1 = ma0 & (bllMx-1);
                            ma0 = bllMx;
                        }

                        for(var j = 0; j < bJotN; ++j)  //delete joints in new balls range
                        {
                            var jr = j*bJotNe;
                            var j0 = bJot[jr+0];
                            var j1 = bJot[jr+1];
                            if((j0>=mi0 && j0<ma0) ||
                               (j0>=mi1 && j0<ma1) ||
                               (j1>=mi0 && j1<ma0) ||
                               (j1>=mi1 && j1<ma1) )
                            {
                                --bJotN;
                                var kr = bJotN*bJotNe;
                                for(var k = 0; k < bJotNe; ++k)
                                {
                                    bJot[jr+k] = bJot[kr+k];
                                }
                            }
                        }
                        for(var j = 0; j < bRotN; ++j)  //delete rotors in new balls range
                        {
                            var jr = j*bRotNe;
                            var j0 = bRot[jr+0];
                            var j1 = bRot[jr+1];
                            var j2 = bRot[jr+2];
                            if((j0>=mi0 && j0<ma0) ||
                               (j0>=mi1 && j0<ma1) ||
                               (j1>=mi0 && j1<ma0) ||
                               (j1>=mi1 && j1<ma1) ||
                               (j2>=mi0 && j2<ma0) ||
                               (j2>=mi1 && j2<ma1) )
                            {
                                --bRotN;
                                var kr = bRotN*bRotNe;
                                for(var k = 0; k < bRotNe; ++k)
                                {
                                    bRot[jr+k] = bRot[kr+k];
                                }
                            }
                        }
                        
                        var wg = 0;
                        w = wp*mchJMx*bJotNe;
                        for(var j = 0; j < machJn[wp] && bJotN<bJotMx; ++j)//add joints
                        {
                            var jr = bJotN*bJotNe;
                            for(var k = 0; k < bJotNe; ++k)
                            {
                                    var a = machJ[w]; ++w;
                                if(k<2){a = (a+mi0)&(bllMx-1);}
                                bJot[jr+k] = a;
                            }
                            bJot[jr+4] = (bJot[jr+4]&(~(15<<8))) | (i<<8);
                            ++bJotN;
                        }
                        wg = 0;
                        w = wp*mchRMx*bRotNe;
                        for(var j = 0; j < machRn[wp] && bRotN<bRotMx; ++j)//add rotors
                        {
                            var jr = bRotN*bRotNe;
                            for(var k = 0; k < bRotNe; ++k)
                            {
                                    var a = machR[w]; ++w;
                                if(k<3){a = (a+mi0)&(bllMx-1);}
                                bRot[jr+k] = a;
                            }
                            bRot[jr+5] = (bRot[jr+5]&(~(15<<8))) | (i<<8);
                            ++bRotN;
                        }

                        bJotGPUo = true;
                        bRotGPUo = true;

                        var prea = machAd;
                        w = wp*mchBMx*4;
                        var cd0 = cam[i*camN+0]*machL2[i] + cam[i*camN+3];
                        var cd1 = cam[i*camN+1]*machL2[i] + cam[i*camN+4];
                        var cd2 = cam[i*camN+2]*machL2[i] + cam[i*camN+5];
                        for(var j = 0; j < machBn[wp]; ++j)//add balls
                        {
                            bllP[machAd] = machB[w]+cd0;                    ++w; ++machAd;
                            bllP[machAd] = machB[w]+cd1;                    ++w; ++machAd;
                            bllP[machAd] = machB[w]+cd2;                    ++w; ++machAd;
                            bllP[machAd] =(machB[w]&(~(15<<4))) | (i<<4);   ++w; ++machAd; if(machAd==bllMx4){machAd=0;}
                        }
                        machAd = prea;
                        for(var j = 0; j < machBn[wp]; ++j)
                        {
                            bllV[machAd] = 0;            ++w; ++machAd;
                            bllV[machAd] = 0;            ++w; ++machAd;
                            bllV[machAd] = 0;            ++w; ++machAd;
                            bllV[machAd] = 0;            ++w; ++machAd; if(machAd==bllMx4){machAd=0;}
                        }
                    }
            }
            //move selected ball
            if((ky&(1<<7))!=0 && bllGi[i]>=0 && (pMenu[i]<=3 || pMenu[i]==5))
            {
                var j4 = bllGi[i]<<2;
                ///bllP[j4+0] += (cam[cmr+0]*bllGd[i] + cam[cmr+3] - bllP[j4+0])*.25;
                ///bllP[j4+1] += (cam[cmr+1]*bllGd[i] + cam[cmr+4] - bllP[j4+1])*.25;
                ///bllP[j4+2] += (cam[cmr+2]*bllGd[i] + cam[cmr+5] - bllP[j4+2])*.25;
                bllV[j4+0] = (cam[cmr+0]*bllGd[i] + cam[cmr+3] - bllP[j4+0])*.2 - bllV[j4+0]*.1;
                bllV[j4+1] = (cam[cmr+1]*bllGd[i] + cam[cmr+4] - bllP[j4+1])*.2 - bllV[j4+1]*.1;
                bllV[j4+2] = (cam[cmr+2]*bllGd[i] + cam[cmr+5] - bllP[j4+2])*.2 - bllV[j4+2]*.1;
            }
            //delete selected ball joints-rotors
            if((ky &(1<<6))!=0 && 
               (ky2&(1<<6))==0 &&  bllGi[i]>=0 && pMenu[i]<=3 && ii==0)
            {
                var b = bllGi[i];
                for(var j = 0; j < bJotN; ++j)//joints
                {
                    var jr = j*bJotNe;
                    var j0 = bJot[jr+0];
                    var j1 = bJot[jr+1];
                    if(b==j0 || b==j1)
                    {
                        --bJotN;
                        var kr = bJotN*bJotNe;
                        for(var k = 0; k < bJotNe; ++k)
                        {
                            bJot[jr+k] = bJot[kr+k];
                        }
                        --j;
                    }
                }
                for(var j = 0; j < bRotN; ++j)//rotors
                {
                    var jr = j*bRotNe;
                    var j0 = bRot[jr+0];
                    var j1 = bRot[jr+1];
                    var j2 = bRot[jr+2];
                    if(b==j0 || b==j1 || b==j2)
                    {
                        --bRotN;
                        var kr = bRotN*bRotNe;
                        for(var k = 0; k < bRotNe; ++k)
                        {
                            bRot[jr+k] = bRot[kr+k];
                        }
                        --j;
                    }
                }
                bJotGPUo = true;
                bRotGPUo = true;
            }
            //spread ball selection to neighbors
            if((ky &(1<<6))!=0 && 
               (ky2&(1<<6))==0 && pMenu[i]==5 && ii==0)
            {
                var ibSelH = i*bSelH;
                for(var j = 0; j < bJotN; ++j)//joints
                {
                    if(bSeln[i]==mchBMx){break;}

                    var jr = j*bJotNe;
                    var j0 = bJot[jr+0];
                    var j1 = bJot[jr+1];

                    var rd0 = ibSelH + (j0>>5);
                    var vw0 = 1<<(j0&31);
                    var ae0 = (bSel[rd0] & vw0)==0;

                    var rd1 = ibSelH + (j1>>5);
                    var vw1 = 1<<(j1&31);
                    var ae1 = (bSel[rd1] & vw1)==0;

                    if(ae0==ae1){continue;}
                    if(ae0){bSel[rd0] = bSel[rd0] | vw0;}
                    if(ae1){bSel[rd1] = bSel[rd1] | vw1;}

                    ++bSeln[i];
                }
            }
            if(pMenu[i]==6)//world editor
            {
                if((ky &(1<<7))==0 && 
                   (ky2&(1<<7))!=0 && ii==0)
                {
                    if(chckG[(i<<1)+1]!= 0)//ungrab checkpoint
                    {
                       chckG[(i<<1)+1] = 0;
                    }
                    else
                    {
                        var bi = -1;
                        var bd = 999999;
                        for(var j = 0; j < chckN; ++j)
                        {
                            var j4 = j<<2;
                            var l0 = chckL[j4+0]-cam[cmr+3];
                            var l1 = chckL[j4+1]-cam[cmr+4];
                            var l2 = chckL[j4+2]-cam[cmr+5];
                            var d  = +cam[cmr+0]*l0
                                     +cam[cmr+1]*l1
                                     +cam[cmr+2]*l2;
                            var a = +l0*l0
                                    +l1*l1
                                    +l2*l2-d*d;
                            if(a<chckZ*chckZ && d>1 && d<bd){bi = j;
                                                             bd = d;}
                        }
                        if(bi<0 && chckN == chckMx){showAlert("too many checkpoints");}
                        if(bi<0 && chckN <  chckMx)//add checkpoint
                        {

                            ++chckG[(i<<1)+0];    
                              chckG[(i<<1)+1] = chckZ*3;
                            var l  = chckZ*3;
                            var ll = chckG[(i<<1)+0];

                                      ++chckN;
                            for(var j = chckN-1; j > ll; --j)
                            {
                                var j4 = j<<2;
                                chckL[j4+0] = chckL[j4+0-4];
                                chckL[j4+1] = chckL[j4+1-4];
                                chckL[j4+2] = chckL[j4+2-4];  
                                chckL[j4+3] = chckL[j4+3-4];  j4+=chckMx<<2;
                                
                                chckL[j4+0] = chckL[j4+0-4];
                                chckL[j4+1] = chckL[j4+1-4];
                                chckL[j4+2] = chckL[j4+2-4];
                                chckL[j4+3] = chckL[j4+3-4];
                            }
                            
                            var j4 = chckG[(i<<1)+0]<<2;
                            chckL[j4+0] = cam[cmr+3] + cam[cmr+0]*l;
                            chckL[j4+1] = cam[cmr+4] + cam[cmr+1]*l;
                            chckL[j4+2] = cam[cmr+5] + cam[cmr+2]*l;  j4+=chckMx<<2;
                            chckL[j4+0] = 0;
                            chckL[j4+1] = 0;
                            chckL[j4+2] = 1;
                            chckGPUo = true;
                        }
                        if(bi>=0)//grab checkpoint
                        {
                            chckG[(i<<1)+0] = bi;
                            chckG[(i<<1)+1] = bd;
                        }
                    }
                }
                if(chckG[(i<<1)+1]!=0)//move checkpoint
                {
                    var j4 = chckG[(i<<1)+0]<<2;
                    var l  = chckG[(i<<1)+1];
                    chckL[j4+0] += (cam[cmr+3] + cam[cmr+0]*l - chckL[j4+0])*.3;
                    chckL[j4+1] += (cam[cmr+4] + cam[cmr+1]*l - chckL[j4+1])*.3;
                    chckL[j4+2] += (cam[cmr+5] + cam[cmr+2]*l - chckL[j4+2])*.3;
                    chckGPUo = true;
                }
                if(iono)//change checkpoint spawn direction
                {
                    var j4 = (chckMx + chckG[(i<<1)+0])<<2;
                        kyX = kyX2;
                        kyY = kyY2;
                        r1 = Math.cos(kyX);
                        r2 = Math.sin(kyX);                           
                        r3 = chckL[j4+0]*r1 - chckL[j4+2]*r2;
                    var r4 = chckL[j4+0]*r2 + chckL[j4+2]*r1;
                    chckL[j4+0] = r3;
                    chckL[j4+2] = r4;
                    var r5 = Math.sqrt(chckL[j4+0]*chckL[j4+0] + chckL[j4+2]*chckL[j4+2]);
                        r1 = Math.atan2(chckL[j4+1],r5) + kyY;             
                     if(r1> pi*.49){r1 = pi*.49;}
                     if(r1<-pi*.49){r1 =-pi*.49;}
                        r3 = Math.cos(r1);
                        r4 = Math.sin(r1);
                    chckL[j4+0] *= r3/r5;
                    chckL[j4+1]  = r4;
                    chckL[j4+2] *= r3/r5;
                }
                if((ky &(1<<6))!=0 && 
                   (ky2&(1<<6))==0 && chckG[(i<<1)+1]!=0 && ii==0)//delete checkpoint
                {
                    var b = chckMx<<2;
                    --chckN;
                    for(var j = chckG[(i<<1)+0]; j < chckN; ++j)
                    {
                        var j4 = j<<2;
                        chckL[j4+0] = chckL[j4+4];
                        chckL[j4+1] = chckL[j4+5];
                        chckL[j4+2] = chckL[j4+6];
                        chckL[j4+3] = chckL[j4+7];
                        chckL[b+j4+0] = chckL[b+j4+4];
                        chckL[b+j4+1] = chckL[b+j4+5];
                        chckL[b+j4+2] = chckL[b+j4+6];
                        chckL[b+j4+3] = chckL[b+j4+7];
                    }
                    chckG[(i<<1)+1] = 0;
                    chckGPUo = true;
                }
            }
            if((ky &(1<<6))!=0 && 
               (ky2&(1<<6))==0 && pMenu[i]==4 && (chckBo&(1<<i))!=0 && ii==0)//revive in race
            {
                if(i==plyMe)
                {
                    camAt = 1;
                    camA[0] = cam[cmr+0];
                    camA[1] = cam[cmr+1];
                    camA[2] = cam[cmr+2];
                    camA[3] = cam[cmr+3];
                    camA[4] = cam[cmr+4];
                    camA[5] = cam[cmr+5];
                    camA[6] = shdVec[0];
                    camA[7] = shdVec[1];
                    camA[8] = shdVec[2];

                    inpKy = 0;
                }

                if(chckLv[i]!=255 && chckP[i]>=2){--chckLv[i];}//lose one live
                if(chckLv[i]==0)//replace revive location to previous checkpoint
                {
                    --chckP[i];
                    var icb = (i*chckBn+0)*2;
                    var pa0 = chckBM[icb+0]*4           ;
                    var pa1 = chckBM[icb+1]*4      + pa0;
                    var ja0 = chckBM[icb+2]*bJotNe      ;
                    var ja1 = chckBM[icb+3]*bJotNe + ja0;
                    var ra0 = chckBM[icb+4]*bRotNe      ;
                    var ra1 = chckBM[icb+5]*bRotNe + ra0;
                    for(var k = pa0; k < pa1; ++k){chckBP[k] = chckBP2[k];}
                    for(var k = ja0; k < ja1; ++k){chckBJ[k] = chckBJ2[k];}
                    for(var k = ra0; k < ra1; ++k){chckBR[k] = chckBR2[k];}
                }

                var icb = i*chckBn*2;
                var pa0 = chckBM[icb+0];  var pa04 = pa0<<2;
                var pa1 = chckBM[icb+1];  var pa14 = pa1<<2;
                var ja0 = chckBM[icb+2];  var ja04 = ja0*bJotNe;
                var ja1 = chckBM[icb+3];  var ja14 = ja1*bJotNe;
                var ra0 = chckBM[icb+4];  var ra04 = ra0*bRotNe;
                var ra1 = chckBM[icb+5];  var ra14 = ra1*bRotNe;

                //hack variables
                chckHk = (chckHk+1)&(plyMx-1);
                var pb0 = pa1*chckHk;
                var pb1 = pa1+pb0;
                var pb04= pb0<<2;
                
                //delete machines in location before adding new machine
                for(var j = 0; j < bJotN; ++j)//joints
                {
                    var jr = j*bJotNe;
                    var j0 = bJot[jr+0];
                    var j1 = bJot[jr+1];
                    if((j0>=pb0 && j0<pb1) || 
                       (j1>=pb0 && j1<pb1))
                    {
                        --bJotN;
                        var kr = bJotN*bJotNe;
                        for(var k = 0; k < bJotNe; ++k)
                        {
                            bJot[jr+k] = bJot[kr+k];
                        }
                        --j;
                    }
                }
                for(var j = 0; j < bRotN; ++j)//rotors
                {
                    var jr = j*bRotNe;
                    var j0 = bRot[jr+0];
                    var j1 = bRot[jr+1];
                    var j2 = bRot[jr+2];
                    if((j0>=pb0 && j0<pb1) || 
                       (j1>=pb0 && j1<pb1) ||
                       (j2>=pb0 && j2<pb1))
                    {
                        --bRotN;
                        var kr = bRotN*bRotNe;
                        for(var k = 0; k < bRotNe; ++k)
                        {
                            bRot[jr+k] = bRot[kr+k];
                        }
                        --j;
                    }
                }

                chckHkJ = bJotN; var jaw = bJotN*bJotNe;  bJotN += ja1;
                chckHkR = bRotN; var raw = bRotN*bRotNe;  bRotN += ra1;
                for(var k = 0; k < pa14; ++k){bllP[k+pb04] = chckBP[k+pa04];}
                for(var k = 0; k < pa14; ++k){bllV[k+pb04] =              0;}
                for(var k = 0; k < ja14; ++k){bJot[k+jaw ] = chckBJ[k+ja04]+pb0*((k%bJotNe)<=1);}
                for(var k = 0; k < ra14; ++k){bRot[k+raw ] = chckBR[k+ra04]+pb0*((k%bRotNe)<=2);}
                camB[i] = chckBc1[i]+pb0;
                var i4 = i<<2;
                cam[cmr+ 0] = chckBc2[i4+0];
                cam[cmr+ 1] = chckBc2[i4+1];
                cam[cmr+ 2] = chckBc2[i4+2];
                cam[cmr+ 8] = chckBc2[i4+3];
                plyE = plyE|(1<<i);
              //kys[r+( kysR   &(kysT-1))] &= (~(1<<6));
                kys[r+((kysR-1)&(kysT-1))] |= 1<<6;
                helpBs = -1;
                bJotGPUo = true;
                bRotGPUo = true;
            }
        }

        //gravity air friction
        for(var j = 0; j < bllMx4; j+=4)
        {
            if((nGair&(1<<0))!=0)   //down gravity
            {
                bllV[j+1] += grty0;
            }
            if((nGair&(1<<1))!=0)   //center gravity
            {
                var x = bllP[j+0];
                var y = bllP[j+1];
                var z = bllP[j+2];
                var a = grty1/Math.sqrt(x*x + y*y + z*z);
                bllV[j+0] += x*a;
                bllV[j+1] += y*a;
                bllV[j+2] += z*a;
            }
            //if((nGair&(1<<2))!=0) //sdf gravity
            //{
                //moved to sdf collision
            //}
            if((nGair&(1<<3))!=0)   //air friction
            {
                bllV[j+0] *= grty3;
                bllV[j+1] *= grty3;
                bllV[j+2] *= grty3;
            }
        }

        var mbr = 2+((rndu>>16)&7);  rndu = (((rndu*214013)|0) + 2531011)|0;//random max joints that can desitegrate per step
        //joint forces
        for(var j = 0; j < bJotN; ++j)
        {
            var jr = j*bJotNe;
            var j0 = bJot[jr+0];
            var j1 = bJot[jr+1];
            var jl = bJot[jr+2]*bJotMl;      var jl2 = Math.min(Math.max(jl,2.1),32);
            var jf = bJot[jr+3]*bJotMf*.23;
            var jk = bJot[jr+4];

            var dlj = false;//joint deleted by desintegrator
            for(var k = 0; k < bJotDN && mbr!=0; k+=2)//desintegrator
            {
                var jd1 = bJotD[k+0];
                var jd2 = bJotD[k+1];
                var b0 = jd1 == j0;
                var b1 = jd1 == j1;
                if(b0){bJotD[k+1] = j1;}
                if(b1){bJotD[k+1] = j0;}
                if(b0 || b1)
                {
                    --mbr;
                    --bJotN;    var jr2 = bJotN*bJotNe;
                    for(var h = 0; h < bJotNe; ++h)
                    {
                        bJot[jr+h] = bJot[jr2+h];
                    }
                    --j;    dlj = true;    break;
                }
            }
            if(dlj){continue;}

            j0 = j0<<2;
            j1 = j1<<2;

            var a0 = bllP[j0+0]; 
            var a1 = bllP[j0+1];
            var a2 = bllP[j0+2];
            
            var b0 = bllP[j1+0]; 
            var b1 = bllP[j1+1];
            var b2 = bllP[j1+2];

            var c0 = bllV[j0+0]; 
            var c1 = bllV[j0+1];
            var c2 = bllV[j0+2];
            
            var d0 = bllV[j1+0]; 
            var d1 = bllV[j1+1];
            var d2 = bllV[j1+2];

            var v0 = (c0 - d0)*.5; 
            var v1 = (c1 - d1)*.5;
            var v2 = (c2 - d2)*.5;

            var l0 = a0 - b0; 
            var l1 = a1 - b1;
            var l2 = a2 - b2;

            var l = l0*l0 + l1*l1 + l2*l2;  if(l<.0001){continue;}
                l = Math.sqrt(l);
            var lf = jl2-l;                 if(Math.abs(lf)>2){continue;}
                lf*= jf;

            l0 /= l; 
            l1 /= l;
            l2 /= l;

            var lv = l0*v0 + l1*v1 + l2*v2;
                lv*=.6;//joint friction

            v0 = l0*lv; 
            v1 = l1*lv;
            v2 = l2*lv;

            l0 = l0*lf - v0; 
            l1 = l1*lf - v1;
            l2 = l2*lf - v2;

            bllV[j0+0] += l0;
            bllV[j0+1] += l1;
            bllV[j0+2] += l2;

            bllV[j1+0] -= l0;
            bllV[j1+1] -= l1;
            bllV[j1+2] -= l2;

            //change joint length using players input
            var ky0 = (jk>> 0)&15;//key one
            var ky1 = (jk>> 4)&15;//key two
            var kyp = (jk>> 8)&(plyMx-1);//player
            var kye = (jk>>12)&15;//sensitivity

            if((plyA&(1<<kyp))==0 || (plyE&(1<<kyp))==0 || kye==0){continue;}

            var ky  = kys[kyp*kysT+(kysR&(kysT-1))];
            var km0 = 0;
            var km1 = 0;
            if(ky0< 7){km0 = ((ky&(1<<ky0))!=0)|0;}
            if(ky1< 7){km1 = ((ky&(1<<ky1))!=0)|0;}
            if(ky0>=7){km0 = (((ky>>((ky0>=9)*11+10))&2047)-1024)/1024*(((ky0 & 1)<<1)-1)*64;}
            if(ky1>=7){km1 = (((ky>>((ky1>=9)*11+10))&2047)-1024)/1024*(((ky1 & 1)<<1)-1)*64;}

            //   jl += (km0-km1)*kye*(1/128);
            //if(jl <  2.5){jl =  2.5;}
            //if(jl > 31.5){jl = 31.5;}
            //bJot[jr+2] = jl*(1/bJotMl);

            var se = (km0-km1)*kye*(1/1024);
            if(se>=0){se =    1+se ;}
            else     {se = 1/(1-se);}
            bJot[jr+2] = jl*se*(1/bJotMl);
        }

        //rotor forces
        for(var j = 0; j < bRotN; ++j)
        {
            var jr = j*bRotNe;
            var j0 = bRot[jr+0];
            var j1 = bRot[jr+1];
            var j2 = bRot[jr+2];
            var jf = bRot[jr+3]*bRotMf*(1/44);
            var jt = bRot[jr+4]*bRotMt*(1/2);
            var jk = bRot[jr+5];

            var dlj = false;//rotor deleted by desintegrator
            for(var k = 0; k < bJotDN; k+=2)//desintegrator
            {
                var jd1 = bJotD[k+0];
              //var jd2 = bJotD[k+1];
                if(jd1 == j0 || 
                   jd1 == j1 ||
                   jd1 == j2 )
                {
                    --bRotN;    var jr2 = bRotN*bRotNe;
                    for(var h = 0; h < bRotNe; ++h)
                    {
                        bRot[jr+h] = bRot[jr2+h];
                    }
                    --j;    dlj = true;    break;
                }
            }
            if(dlj){continue;}

            j0 = j0<<2;
            j1 = j1<<2;
            j2 = j2<<2;

            var ky0 = (jk >> 0) & 15;//key one
            var ky1 = (jk >> 4) & 15;//key two
            var kyp = (jk >> 8) & (plyMx-1);//player

            if((plyA&(1<<kyp))==0 || (plyE&(1<<kyp))==0){continue;}

            var ky  = kys[kyp*kysT+(kysR&(kysT-1))];
            var km0 = 0;
            var km1 = 0;
            if(ky0< 7){km0 = ((ky&(1<<ky0))!=0)|0;}
            if(ky1< 7){km1 = ((ky&(1<<ky1))!=0)|0;}
            if(ky0>=7){km0 = (((ky>>((ky0>=9)*11+10))&2047)-1024)/1024*(((ky0 & 1)<<1)-1)*64;}
            if(ky1>=7){km1 = (((ky>>((ky1>=9)*11+10))&2047)-1024)/1024*(((ky1 & 1)<<1)-1)*64;}
            km0-=km1;

            var a0 = bllP[j0+0];
            var a1 = bllP[j0+1];
            var a2 = bllP[j0+2];
            
            var b0 = bllP[j1+0];
            var b1 = bllP[j1+1];
            var b2 = bllP[j1+2];

            var c0 = bllP[j2+0];
            var c1 = bllP[j2+1];
            var c2 = bllP[j2+2];

            var cen0 = (a0 + b0 + c0)*(1/3);
            var cen1 = (a1 + b1 + c1)*(1/3);
            var cen2 = (a2 + b2 + c2)*(1/3);

            var cra0 = a0 - b0; 
            var cra1 = a1 - b1;
            var cra2 = a2 - b2;

            var crb0 = c0 - b0; 
            var crb1 = c1 - b1;
            var crb2 = c2 - b2;

            var cro0 = cra1*crb2 - cra2*crb1; 
            var cro1 = cra2*crb0 - cra0*crb2;
            var cro2 = cra0*crb1 - cra1*crb0;

            var cna0 = a0 - cen0;    
            var cna1 = a1 - cen1;    
            var cna2 = a2 - cen2;    a0 = cna1*cro2 - cna2*cro1;
                                     a1 = cna2*cro0 - cna0*cro2;
                                     a2 = cna0*cro1 - cna1*cro0;
            var cnb0 = b0 - cen0;    
            var cnb1 = b1 - cen1;    
            var cnb2 = b2 - cen2;    b0 = cnb1*cro2 - cnb2*cro1;
                                     b1 = cnb2*cro0 - cnb0*cro2;
                                     b2 = cnb0*cro1 - cnb1*cro0;
            var cnc0 = c0 - cen0;    
            var cnc1 = c1 - cen1;    
            var cnc2 = c2 - cen2;    c0 = cnc1*cro2 - cnc2*cro1;
                                     c1 = cnc2*cro0 - cnc0*cro2;
                                     c2 = cnc0*cro1 - cnc1*cro0;
                                                    var big=false;
            cra0 = Math.sqrt(a0*a0 + a1*a1 + a2*a2);    big=     cra0<.0001;    cra0=1/cra0;
            cra1 = Math.sqrt(b0*b0 + b1*b1 + b2*b2);    big=big||cra1<.0001;    cra1=1/cra1;
            cra2 = Math.sqrt(c0*c0 + c1*c1 + c2*c2);    big=big||cra2<.0001;    cra2=1/cra2;
            if(big){cra0=0;
                    cra1=0;
                    cra2=0;}

            cen0 = bllV[j0+0]-(bllV[j0+0] + bllV[j1+0] + bllV[j2+0])*(1/3);
            cen1 = bllV[j0+1]-(bllV[j0+1] + bllV[j1+1] + bllV[j2+1])*(1/3);
            cen2 = bllV[j0+2]-(bllV[j0+2] + bllV[j1+2] + bllV[j2+2])*(1/3);

            var l = +cen0*a0*cra0
                    +cen1*a1*cra0
                    +cen2*a2*cra0;    
                l*= km0;              if(l<0){l=0;}
                l = jf-l*jt;          if(l<0){l=0;}  //rotor force decreases as velocity increases
                l*= km0;
            cra0 *= l;
            cra1 *= l;
            cra2 *= l;

            bllV[j0+0] += a0*cra0;
            bllV[j0+1] += a1*cra0;
            bllV[j0+2] += a2*cra0;

            bllV[j1+0] += b0*cra1;
            bllV[j1+1] += b1*cra1;
            bllV[j1+2] += b2*cra1;

            bllV[j2+0] += c0*cra2;
            bllV[j2+1] += c1*cra2;
            bllV[j2+2] += c2*cra2;
        }

        //sticky enable-disable
        for(var j = 3; j < bllMx4 && ii==0; j+=4)
        {
            var a = bllP[j];    if(a==0){continue;}
            var b = a|0;
            var ky0 = (b>>0)&15;//key
            var kyp = (b>>4)&(plyMx-1);//player

            if((plyA&(1<<kyp))==0 || (plyE&(1<<kyp))==0){continue;}

            var ky  = kys[kyp*kysT+( kysR   &(kysT-1))];
            var ky2 = kys[kyp*kysT+((kysR-1)&(kysT-1))];
            if((ky &(1<<ky0))!=0 && 
               (ky2&(1<<ky0))==0 )
            {
                b = b ^ (1<<8);
            }
            bllP[j] = b;
        }

        //swap-delete desintegrator
        for(var j = 0; j < bJotDN; j+=2)
        {
            var jd1 = bJotD[j+0];
            var jd2 = bJotD[j+1];
            var a = jd2 == bJotDe;
            if(a)
            {
                bJotDN-=2;
                jd1 = bJotD[bJotDN+0];
                jd2 = bJotD[bJotDN+1];    bJotGPUo = true; bRotGPUo = true;
            }
            else
            {
                jd1 = jd2;
                jd2 = bJotDe;
            }
            bJotD[j+0] = jd1;
            bJotD[j+1] = jd2;

            if(a){j-=2;}
        }

        //balls sdf collision
        shdMtx[ 7] = timW*.001;
        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bllMx,1, gl.RGBA, gl.FLOAT, bllP);
        gl.viewport(0,0, bllMx,1);
        gl.bindFramebuffer(gl.FRAMEBUFFER, frb1);
        gl.useProgram(shaderP2);
        gl.uniform1i(shdTex2, 0);
        gl.uniformMatrix4fv(shdMtx2, false, shdMtx);
        gl.vertexAttribPointer(shdVtx2, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx2);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
        gl.readPixels(0, 0, bllMx,1, gl.RGBA, gl.FLOAT, bll0);
        for(var j = 0; j < bllMx4; j+=4)
        {
            //var l = bll0[j+3];
            //if(l>=1){continue;}
            //l = 1-l;

            var n0 = bll0[j+0];
            var n1 = bll0[j+1];
            var n2 = bll0[j+2];

            if((nGair&(1<<2))!=0)               //sdf gravity
            {
                bllV[j+0] += n0*grty2;
                bllV[j+1] += n1*grty2;
                bllV[j+2] += n2*grty2;
            }

            var l = bll0[j+3];
            if(l>=1){continue;}
            l = 1-l;

            var v0 = bllV[j+0];
            var v1 = bllV[j+1];
            var v2 = bllV[j+2];

            var s0 = 0;
            var s1 = 0;
            var s2 = 0;
            if(bllP[j+3] >= 512+256)//sticky
            {
                var v = v0*n0 + v1*n1 + v2*n2;
                var frc2 = -.5; //sticky friction
                s0 = (v0 - n0*v)*frc2;
                s1 = (v1 - n1*v)*frc2;
                s2 = (v2 - n2*v)*frc2;
                l-=.2;
            }
            var frc1 = -.25;//only collision friction
            v0 *= frc1;
            v1 *= frc1;
            v2 *= frc1;
            
            if(l<0){l=0;}
            
            bllV[j+0] += n0*l + v0 + s0;
            bllV[j+1] += n1*l + v1 + s1;
            bllV[j+2] += n2*l + v2 + s2;
        }
        //possessed ball collision
        for(var j = 0; j < plyMx; ++j)
        {
            if((plyE&(1<<j))==0){continue;}
            var a  = camB[j];
            var a4 = a<<2;

            //collision with checkpoint
            var c4 = chckP[j];  c4 = c4<<2;
            var ck0 = bllP[a4+0]-chckL[c4+0];
            var ck1 = bllP[a4+1]-chckL[c4+1];
            var ck2 = bllP[a4+2]-chckL[c4+2];
            if(ck0*ck0 + ck1*ck1 + ck2*ck2 < chckZ*chckZ)
            {
                chckLv[j] = chckLvO;
                ++chckP[j];  if(campainW>=0 && j==plyMe && chckP[j]==chckN){/*campainNxt = true;*/ nxtWB = .001;}
                             if(chckP[j]==    1){chckTim[j] = kysR*kysPs+ii;}
                             if(chckP[j]==chckN){chckTim[j] = kysR*kysPs+ii-chckTim[j];
                                                 if(campainW>=0 && j==plyMe){lvlTim[campainW] = chckTim[j];}}
                chckAP[j] = .001*(chckP[j]!=1);

                //save machine for revive
                var jcb = (j*chckBn+0)*2;
                var pa0 = chckBM[jcb+0]*4     ;
                var pa1 = chckBM[jcb+1]*4     ;
                var ja0 = chckBM[jcb+2]*bJotNe;
                var ja1 = chckBM[jcb+3]*bJotNe;
                var ra0 = chckBM[jcb+4]*bRotNe;
                var ra1 = chckBM[jcb+5]*bRotNe;

                //hack variables
                var pb0 = pa1*chckHk;     var pb4 = pb0>>2;
                var jb0 = chckHkJ*bJotNe;
                var rb0 = chckHkR*bRotNe;

                for(var k = 0; k < pa1; ++k){chckBP2[k+pa0] = chckBP[k+pa0];}
                for(var k = 0; k < pa1; ++k){chckBP [k+pa0] =   bllP[k+pb0];}
                for(var k = 0; k < ja1; ++k){chckBJ2[k+ja0] = chckBJ[k+ja0];}
                for(var k = 0; k < ja1; ++k){chckBJ [k+ja0] =   bJot[k+jb0]-pb4*((k%bJotNe)<=1);}
                for(var k = 0; k < ra1; ++k){chckBR2[k+ra0] = chckBR[k+ra0];}
                for(var k = 0; k < ra1; ++k){chckBR [k+ra0] =   bRot[k+rb0]-pb4*((k%bRotNe)<=2);}
                //chckBc1[j] = a; posses ball of machine never changes through race
                var j4 = j<<2;  var cmr = camN*j;
                chckBc2[j4+0] = cam[cmr+0];
                chckBc2[j4+1] = cam[cmr+1];
                chckBc2[j4+2] = cam[cmr+2];
                chckBc2[j4+3] = cam[cmr+8];
            }
            if(bll0[a4+3] > 1){continue;}//collision with floor
            bJotD[bJotDN] =      a;    ++bJotDN;
            bJotD[bJotDN] = bJotDe;    ++bJotDN;
            //get out of posses mode
            var cmr = camN*j;
            plyE = plyE ^ (1<<j);
            var l = cam[cmr+8];
            var b = camB[j]<<2;
            cam[cmr+3] = bllP[b+0]-cam[cmr+0]*l+shdVec[0]*l*camHl;
            cam[cmr+4] = bllP[b+1]-cam[cmr+1]*l+shdVec[1]*l*camHl;
            cam[cmr+5] = bllP[b+2]-cam[cmr+2]*l+shdVec[2]*l*camHl;
            cam[cmr+7] = 1/8;
            if(j==plyMe)
            {
                camAt = 1;
                camA[0] = cam[cmr+0];
                camA[1] = cam[cmr+1];
                camA[2] = cam[cmr+2];
                camA[3] = cam[cmr+3];
                camA[4] = cam[cmr+4];
                camA[5] = cam[cmr+5];
                camA[6] = shdVec[0];
                camA[7] = shdVec[1];
                camA[8] = shdVec[2];
                if((chckBo&(1<<plyMe))!=0){helpBs = 1;}

                if(campainW>=0){++lvlDed[campainW];}
            }
        }

        //balls-balls collision
        for(var j = 0; j < bllMx; ++j)//fill 3D space
        {
            var j4 = j<<2;
            var f0 = (bllP[j4+0]+bigp) & bll3Dk;
            var f1 = (bllP[j4+1]+bigp) & bll3Dk;
            var f2 = (bllP[j4+2]+bigp) & bll3Dk;
          //var f3 = (bllP[j4+3]+bigp) & bll3Dk;
            bllS[f2*bll3D2 + f1*bll3D + f0] = j;
        }
        for(var j = 0; j < bllMx; ++j)
        {
            var j4 = j<<2;
            var p0 = bllP[j4+0];
            var p1 = bllP[j4+1];
            var p2 = bllP[j4+2];
          //var p3 = bllP[j4+3];
            var f0 = p0+bigp;  var h0 = f0 & bll3Dk;  f0 -= 2;
            var f1 = p1+bigp;  var h1 = f1 & bll3Dk;  f1 -= 2;
            var f2 = p2+bigp;  var h2 = f2 & bll3Dk;  f2 -= 2;
            var id = bllS[h2*bll3D2 + h1*bll3D + h0];
            var me = id == j;
            for(var z = 0; z < 5; ++z){
            for(var y = 0; y < 5; ++y){
            for(var x = 0; x < 5; ++x){
                var g0 = (f0+x) & bll3Dk;
                var g1 = (f1+y) & bll3Dk;
                var g2 = (f2+z) & bll3Dk;
                var id2= bllS[g2*bll3D2 + g1*bll3D + g0];   
                                                            if(id2==bllMx || id2==id){continue;}
                var r4 = id2<<2;
                var n0 = p0 - bllP[r4+0];
                var n1 = p1 - bllP[r4+1];
                var n2 = p2 - bllP[r4+2];
                var l = n0*n0 + n1*n1 + n2*n2;              if(l<.00001 || l>=4){continue;}
                    l = Math.sqrt(l);
                    l = 2/l-1;
                    l*= .4;
                n0 *= l;
                n1 *= l;
                n2 *= l;
                bllV[j4+0] += n0;
                bllV[j4+1] += n1;
                bllV[j4+2] += n2;  
                                                            if(me){continue;}
                bllV[r4+0] -= n0;
                bllV[r4+1] -= n1;
                bllV[r4+2] -= n2;
            }}}
        }
        for(var j = 0; j < bllMx; ++j)//empty 3D space
        {
            var j4 = j<<2;
            var f0 = (bllP[j4+0]+bigp) & bll3Dk;
            var f1 = (bllP[j4+1]+bigp) & bll3Dk;
            var f2 = (bllP[j4+2]+bigp) & bll3Dk;
          //var f3 = (bllP[j4+3]+bigp) & bll3Dk;
            bllS[f2*bll3D2 + f1*bll3D + f0] = bllMx;
        }

        if(chckT!=0){--chckT;}
        if(chckT!=0)//pause physics in race countdown or world transition
        {
            for(var j = 0; j < bllMx4; ++j){bllV[j] = 0;}
        }

        //velocity to position
        for(var j = 0; j < bllMx4; )
        {
            bllP[j] += bllV[j]; ++j;
            bllP[j] += bllV[j]; ++j;
            bllP[j] += bllV[j]; ++j; ++j;
        }
      }
      ++kysR;
    }
}
function render()
{
    if(endGe <= 2)
    {
    phyStep();

    //if(fucus==0 && pMenu[plyMe]==5 && machBn[machS[plyMe]]!=0)//animate library pic of selected machine
    //{
    //    cnvs.width  = machRz;
    //    cnvs.height = machRz;
    //    gl.viewport(0,0, machRz,machRz);
    //
    //    var pr = plyMe*camN;
    //    shdMtx[0] = cam[pr+0];
    //    shdMtx[1] = cam[pr+1];
    //    shdMtx[2] = cam[pr+2];
    //
    //    shdMtx[4] = cam[pr+3];
    //    shdMtx[5] = cam[pr+4] + Math.cos(timW*.001);
    //    shdMtx[6] = cam[pr+5];
    //    renderMach(true);
    //
    //    var wp = machS[plyMe];
    //    machCnv2[wp].drawImage(cnvs, 0, 0);
    //    cnvs.width  = scrX;
    //    cnvs.height = scrY;
    //}

    shdVec[0] = 0;
    shdVec[1] = 1;
    shdVec[2] = 0;
    var cb  = camB[plyMe]<<2;
    shdVec[4] = bllP[cb+0];
    shdVec[5] = bllP[cb+1];
    shdVec[6] = bllP[cb+2];
    if((plyE&(1<<plyMe))!=0 && ((nGair&(1<<1))!=0 || (nGair&(1<<2))!=0))//center gravity
    {
        var l = 1/Math.sqrt(+shdVec[4]*shdVec[4]
                            +shdVec[5]*shdVec[5]
                            +shdVec[6]*shdVec[6]);
        shdVec[0] = shdVec[4]*l;
        shdVec[1] = shdVec[5]*l;
        shdVec[2] = shdVec[6]*l;
    }
    shdVec[4] += shdVec[0];
    shdVec[5] += shdVec[1];
    shdVec[6] += shdVec[2];

    var pr = plyMe*camN;
    if(pMenu[plyMe]==0)//game intro
    {
        cam[pr+0] = Math.cos(timW*.00001);
        cam[pr+1] = 0;
        cam[pr+2] = Math.sin(timW*.00001);
        cam[pr+3] = -cam[pr+0]*444;
        cam[pr+4] = 2444;
        cam[pr+5] = -cam[pr+2]*444;
    }
    shdMtx[ 0] = cam[pr+0];
    shdMtx[ 1] = cam[pr+1];
    shdMtx[ 2] = cam[pr+2];
    shdMtx[ 3] = bllMx;
    shdMtx[ 4] = cam[pr+3];
    shdMtx[ 5] = cam[pr+4];
    shdMtx[ 6] = cam[pr+5];
    shdMtx[ 7] = timW*.001;
    shdMtx[ 8] = prj0;
    shdMtx[ 9] = prj1;
    shdMtx[10] = meshXz3;
    if((plyE&(1<<plyMe))!=0)//possess
    {
        var l = cam[pr+8];
        shdMtx[4] = shdVec[4] - shdMtx[0]*l + shdVec[0]*l*camHl;
        shdMtx[5] = shdVec[5] - shdMtx[1]*l + shdVec[1]*l*camHl;
        shdMtx[6] = shdVec[6] - shdMtx[2]*l + shdVec[2]*l*camHl;
    }
    
    if(camAt!=0)//camera transition from place to place animation
    {
        var a1 = camAt*camAt;
        var a0 = 1-a1;
        shdMtx[0] = shdMtx[0]*a0 + camA[0]*a1;
        shdMtx[1] = shdMtx[1]*a0 + camA[1]*a1;
        shdMtx[2] = shdMtx[2]*a0 + camA[2]*a1;

        shdMtx[4] = shdMtx[4]*a0 + camA[3]*a1;
        shdMtx[5] = shdMtx[5]*a0 + camA[4]*a1;
        shdMtx[6] = shdMtx[6]*a0 + camA[5]*a1;
        
        shdVec[0] = shdVec[0]*a0 + camA[6]*a1;
        shdVec[1] = shdVec[1]*a0 + camA[7]*a1;
        shdVec[2] = shdVec[2]*a0 + camA[8]*a1;
        camAt -= timD*.001;  if(camAt<0){camAt = 0;}
    }
    if(camWT!=0)//campain camera world transition
    {
        var a = camWT;
        camWT -= timD*.0003;  if(camWT<0){camWT = 0;}
        if(camWT>2){a = .9999; camWT = a;}
        if(camWT<1 && a>=1)
        {
            tblMain.style.display = hivi[0];
            wrldCompile(true);
            camWT = 99999; //no matter compile time, animation will not skip zoomin
        }
        if(camWT==0){strtrace();}
            var b = a-Math.floor(a);
        if(a>1){b = 1-b;}
                b = b*b*111;
        shdMtx[4] -= shdMtx[0]*b;
        shdMtx[5] -= shdMtx[1]*b;
        shdMtx[6] -= shdMtx[2]*b;
    }

    //players head position
    for(var i = 0; i < plyMx; ++i)
    {
        var i8 = i<<3;
        var ir = i*camN;

        var d0 = 0;
        var d1 = 0;
        var d2 = 0;
        var p0 = 0;
        var p1 = 0;
        var p2 = 0;
        if((plyE&(1<<i))==0){  //no possess
            d0 = cam[ir+0];
            d1 = cam[ir+1];
            d2 = cam[ir+2];

            p0 = cam[ir+3];
            p1 = cam[ir+4];
            p2 = cam[ir+5];
        }else{                 //ye possess
            var b = camB[i]<<2;

            var p00 = bllP[b+0];
            var p01 = bllP[b+1];
            var p02 = bllP[b+2];

            var p10 = bllP[(b+4)&(bllMx4-1)]-p00;
            var p11 = bllP[(b+5)&(bllMx4-1)]-p01;
            var p12 = bllP[(b+6)&(bllMx4-1)]-p02;

            var l = 1/Math.sqrt(p10*p10+
                                p11*p11+
                                p12*p12);

            d0 = p10*l;
            d1 = p11*l;
            d2 = p12*l;
            
            p0 = p00 + 3*shdVec[0];
            p1 = p01 + 3*shdVec[1];
            p2 = p02 + 3*shdVec[2];
        }
        camTx[i8+0] = d0;
        camTx[i8+1] = d1;
        camTx[i8+2] = d2;
        camTx[i8+3] = ((plyA&(1<<i))!=0 && !(i==plyMe && (plyE&(1<<i))==0));
        camTx[i8+4] = p0;
        camTx[i8+5] = p1;
        camTx[i8+6] = p2;
        camTx[i8+7] = chckAP[i];
    }
    gl.activeTexture(gl.TEXTURE5);
    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, plyMx<<1,1, gl.RGBA, gl.FLOAT, camTx);
    if(bJotGPUo)
    {
        bJotGPUo = false;
        for(var j = 0; j < bJotN; ++j)
        {
            var jr = j*bJotNe;
            var j0 = bJot[jr+0];
            var j1 = bJot[jr+1];
            var j4 = j<<2;
            bJotGPU[j4+0] = (j0   )&255;
            bJotGPU[j4+1] = (j0>>8)&255;
            bJotGPU[j4+2] = (j1   )&255;
            bJotGPU[j4+3] = (j1>>8)&255;
        }
        gl.activeTexture(gl.TEXTURE3);
        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bJotN,1, gl.RGBA, gl.UNSIGNED_BYTE, bJotGPU);
    }
    if(bRotGPUo)
    {
        bRotGPUo = false;
        for(var j = 0; j < bRotN; ++j)
        {
            var jr = j*bRotNe;
            var j0 = bRot[jr+0];
            var j1 = bRot[jr+1];
            var j2 = bRot[jr+2];
            var j8 = j<<3;
            bRotGPU[j8+0] = (j0   )&255;
            bRotGPU[j8+1] = (j0>>8)&255;
            bRotGPU[j8+2] = (j1   )&255;
            bRotGPU[j8+3] = (j1>>8)&255;
            bRotGPU[j8+4] = (j2   )&255;
            bRotGPU[j8+5] = (j2>>8)&255;
        }
        gl.activeTexture(gl.TEXTURE4);
        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bRotN<<1,1, gl.RGBA, gl.UNSIGNED_BYTE, bRotGPU);
    }
    if(chckGPUo)
    {
        chckGPUo = false;
        gl.activeTexture(gl.TEXTURE6);
        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, chckMx,2, gl.RGBA, gl.FLOAT, chckL);
    }
    gl.activeTexture(gl.TEXTURE0);

    gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    gl.viewport(0,0, scrX,scrY);
  //gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    //draw world
    gl.depthFunc(gl.ALWAYS);
    gl.useProgram(shaderP1);
    gl.uniformMatrix4fv(shdMtx1, false, shdMtx);
    gl.uniformMatrix4fv(shdVec1, false, shdVec);
    gl.vertexAttribPointer(shdVtx1, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx1);
    gl.drawArrays(gl.TRIANGLES, 0, 3);
    gl.depthFunc(gl.GEQUAL);

    //draw balls
    shdMtx[14] = icoMsh3;
    gl.useProgram(shaderP0);
    gl.uniform1i(shdTex00, 0);
    gl.uniform1i(shdTex01, 2);
    gl.uniformMatrix4fv(shdMtx0, false, shdMtx);
    gl.uniformMatrix4fv(shdVec0, false, shdVec);
    gl.vertexAttribPointer(shdVtx0, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx0);
    gl.drawArrays(gl.TRIANGLES, 0, icoMsh3*bllMx);
    if(pMenu[plyMe]==5)//show selected balls
    {
        var rd = plyMe*bSelH;
        var rw = 0;
        for(var j = 0; j < bllMx; ++j)
        {
            bll0[rw] = bllP[rw];                         ++rw;
            bll0[rw] = bllP[rw];                         ++rw;
            bll0[rw] = bllP[rw];                         ++rw;
            bll0[rw] = (bSel[rd+(j>>5)] >> (j&31)) & 1;  ++rw;
        }
        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bllMx,1, gl.RGBA, gl.FLOAT, bll0);
        gl.useProgram(shaderP9);
        gl.uniform1i(shdTex90, 0);
        gl.uniform1i(shdTex91, 2);
        gl.uniformMatrix4fv(shdMtx9, false, shdMtx);
        gl.uniformMatrix4fv(shdVec9, false, shdVec);
        gl.vertexAttribPointer(shdVtx9, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx9);
        gl.drawArrays(gl.TRIANGLES, 0, icoMsh3*bllMx);
        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bllMx,1, gl.RGBA, gl.FLOAT, bllP);
    }
    //draw joints
    shdMtx[11] = bJotMx;
    shdMtx[14] = jotMsh3;
    gl.useProgram(shaderP4);
    gl.uniform1i(shdTex40, 0);
    gl.uniform1i(shdTex41, 2);
    gl.uniform1i(shdTex42, 3);
    gl.uniformMatrix4fv(shdMtx4, false, shdMtx);
    gl.uniformMatrix4fv(shdVec4, false, shdVec);
    gl.vertexAttribPointer(shdVtx4, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx4);
    gl.drawArrays(gl.TRIANGLES, 0, jotMsh3*bJotN);
    if(pMenu[plyMe]==1 && bSeln[plyMe]!=0)//consruct joint
    {
        shdMtx[12] = (bSelMe[0]+.5)/bllMx;//selected ball
        gl.useProgram(shaderP5);
        gl.uniform1i(shdTex50, 0);
        gl.uniform1i(shdTex51, 2);
        gl.uniformMatrix4fv(shdMtx5, false, shdMtx);
        gl.uniformMatrix4fv(shdVec5, false, shdVec);
        gl.vertexAttribPointer(shdVtx5, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx5);
        gl.drawArrays(gl.TRIANGLES, 0, jotMsh3);
    }
    //draw rotors
    shdMtx[11] = bRotMx;
    shdMtx[14] = rotMsh3;
    gl.useProgram(shaderP6);
    gl.uniform1i(shdTex60, 0);
    gl.uniform1i(shdTex61, 2);
    gl.uniform1i(shdTex62, 4);
    gl.uniformMatrix4fv(shdMtx6, false, shdMtx);
    gl.uniformMatrix4fv(shdVec6, false, shdVec);
    gl.vertexAttribPointer(shdVtx6, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx6);
    gl.drawArrays(gl.TRIANGLES, 0, rotMsh3*bRotN*3);
    if(pMenu[plyMe]==2 && bSeln[plyMe]!=0)//consruct rotors
    {
        shdMtx[12] = (bSelMe[0]+.5)/bllMx;//selected balls
        shdMtx[13] = (bSelMe[1]+.5)/bllMx;  if(bSeln[plyMe]==1){shdMtx[13] = -1;}
        gl.useProgram(shaderP7);
        gl.uniform1i(shdTex70, 0);
        gl.uniform1i(shdTex71, 2);
        gl.uniformMatrix4fv(shdMtx7, false, shdMtx);
        gl.uniformMatrix4fv(shdVec7, false, shdVec);
        gl.vertexAttribPointer(shdVtx7, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx7);
        gl.drawArrays(gl.TRIANGLES, 0, rotMsh3*3);
    }
    //draw heads
    shdMtx[11] = plyMx;
    shdMtx[14] = icoMsh3;
    gl.useProgram(shaderP8);
    gl.uniform1i(shdTex80,5);
    gl.uniform1i(shdTex81,2);
    gl.uniformMatrix4fv(shdMtx8, false, shdMtx);
    gl.uniformMatrix4fv(shdVec8, false, shdVec);
    gl.vertexAttribPointer(shdVtx8, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx8);
    gl.drawArrays(gl.TRIANGLES, 0, icoMsh3*plyMx);

    if(machAdd[plyMe]==1)//view machine may add
    {
        renderMach(machS[plyMe]);
    }

    shdMtx[11] = chckMx;
    shdMtx[12] = chckZ;                 if(campainW>=0 && chckA > chckN-1){shdMtx[12] = chckZ * (1-(chckA - (chckN-1)));}
    shdMtx[13] = (plyE&(1<<plyMe))!=0;  if(chckT!=0){shdMtx[13]=2;}
    shdMtx[14] = chkMsh3;
    shdMtx[15] = chckA;                 if((plyE&(1<<plyMe))==0){shdMtx[15] = 0;}
    shdVec[ 3] = chckN-1;
    
    if(campainW<0)//draw lines connecting checkpoints
    {
        gl.useProgram(shaderP12);
        gl.uniform1i(shdTex12, 6);
        gl.uniformMatrix4fv(shdMtx12, false, shdMtx);
        gl.uniformMatrix4fv(shdVec12, false, shdVec);
        gl.vertexAttribPointer(shdVtx12, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx12);
        gl.drawArrays(gl.LINE_STRIP, 0, chckN);
    }

    gl.depthMask(false);
    gl.enable(gl.BLEND);
  //gl.disable(gl.CULL_FACE);

    //draw checkpoints balls
    gl.useProgram(shaderP10);
    gl.uniform1i(shdTex100, 6);
    gl.uniform1i(shdTex101, 2);
    gl.uniformMatrix4fv(shdMtx10, false, shdMtx);
    gl.uniformMatrix4fv(shdVec10, false, shdVec);
    gl.vertexAttribPointer(shdVtx10, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx10);
    gl.drawArrays(gl.TRIANGLES, 0, chkMsh3*chckN);

    //draw checkpoints particles
    gl.useProgram(shaderP15);
    gl.uniform1i(shdTex15, 6);
    gl.uniformMatrix4fv(shdMtx15, false, shdMtx);
    gl.uniformMatrix4fv(shdVec15, false, shdVec);
    gl.vertexAttribPointer(shdVtx15, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx15);
    gl.drawArrays(gl.TRIANGLES, 0, chkMsh3*(chckN!=0));

    //draw world XYZ arrow to save machine
    if(pMenu[plyMe]==5)
    {
        gl.useProgram(shaderP11);
        gl.uniform1i(shdTex11, 2);
        gl.uniformMatrix4fv(shdMtx11, false, shdMtx);
        gl.uniformMatrix4fv(shdVec11, false, shdVec);
        gl.vertexAttribPointer(shdVtx11, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx11);
        gl.drawArrays(gl.TRIANGLES, 960>>2, (1008>>2)-(960>>2));//960>>2
    }

    //draw press key space tutorial
    if(sdfO==18)//campainW==0)
    {
        gl.useProgram(shaderP18);
        gl.uniformMatrix4fv(shdMtx18, false, shdMtx);
        gl.uniformMatrix4fv(shdVec18, false, shdVec);
        gl.vertexAttribPointer(shdVtx18, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx18);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
    }
    //draw screen color fade to black in world transition 
    if(camWT!= 0)
    {
        shdMtx[12] = camWT-1; if(camWT == 99999){shdMtx[12] = 0;}
        gl.depthFunc(gl.ALWAYS);
        gl.useProgram(shaderP13);
        gl.uniformMatrix4fv(shdMtx13, false, shdMtx);
        gl.vertexAttribPointer(shdVtx13, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx13);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
        gl.depthFunc(gl.GEQUAL);
    }
    //draw center point
    if(campainW<0)
    {
        gl.depthFunc(gl.ALWAYS);
        gl.useProgram(shaderP3);
        gl.uniformMatrix4fv(shdMtx3, false, shdMtx);
        gl.vertexAttribPointer(shdVtx3, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx3);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
        gl.depthFunc(gl.GEQUAL);
    }
    //draw orb
    if(drwOrb!=0)
    {
        var preo = drwOrb;
        drwOrb += timD*.001;
        if(drwOrb>=1          ){drwOrb = 1;}
        if(drwOrb>=0 && preo<0){drwOrb = 0;}
        shdMtx[12] = drwOrb;
        gl.depthFunc(gl.ALWAYS);
        gl.useProgram(shaderP14);
        gl.uniformMatrix4fv(shdMtx14, false, shdMtx);
        gl.vertexAttribPointer(shdVtx14, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx14);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
        gl.depthFunc(gl.GEQUAL);
    }

    gl.depthMask(true);
    gl.disable(gl.BLEND);
  //gl.enable(gl.CULL_FACE);

    if(campainRspw!=0){campainRspwT += timD*.001;}
    if(campainRspw==0){campainRspwT  =         0;}
    if(campainRspwT> 2)
    {
        if((plyE&(1<<plyMe))!=0){inpKy = inpKy|(1<<7);                 }
        else                    {inpKy = inpKy|(1<<6);campainRspwT = 0;}
    }

    for(var i = 0; i < plyMx; ++i){if(chckAP[i] != 0){chckAP[i] += timD*.001; if(chckAP[i] > 1){chckAP[i] = 0;}}}
    var cc = chckP[plyMe];
    if(chckA < cc){chckA += timD*.0003;}
    if(chckA > cc){chckA  = cc;}
    if(chckT != 0)
    {
        var a = (chckT/(inpPs*kysPs)+1)|0;
        if(a != chckT2)
        {
            chckT2 = a;
            //chckE.innerHTML = a;
        }
        chckA = 0;
    }
    if(chckT==0 && chckT2!=0)
    {
        chckT2 = 0;
        //chckE.style.display = hivi[0];
    }
    if(helpBs>=1)
    {
        helpBs2 = helpBs;
        if(helpBs==1)
        {
            helpB.innerHTML = "key [space] revives";
        }
        if(helpBs==2)
        {
            helpB.innerHTML = "key [space] cancels";
        }
        if(helpBs==3)
        {
            helpB.innerHTML = "click     on ball to select it\n"+
                              "click not on ball to add machine";
        }
        if(helpBs==4)
        {
            helpB.innerHTML = "key [space] auto-selects more balls if it is connected";
        }
        if(helpBs==5)
        {
            helpB.innerHTML = "click on ball of a machine to control it";
        }
        if(helpBs==6)
        {
            helpB.innerHTML = "hold [enter] to respawn";
        }
        helpB.style.display = hivi[1];
        helpBs = 0;
    }
    if(helpBs<0)
    {
        helpBs = 0;
        helpB.style.display = hivi[0];
    }
    //if(campainNxt)
    //{
    //    campainNxt = false;
    //    campainEl.style.transform = "translateY(300px)";
    //}

    if(fdag!=0){++fdag;}
    if(fdag==8){fdag = 0; inpKy = inpKy & (~(1<<6));}

    //next world timing
    if(nxtWB!=0)
    {
        nxtWB += timD*.001;
        if(campainW==campainL2 && endGe==0){endGe=1;}
        if(nxtWB>1 && endGe==1)
        {
            nxtWB = 0;
            endGe = 2;
        }
        if(nxtWB>3.5)
        {
            nxtWB = 0;
            clickToNxtWrld();
        }
    }
    //end of game
    if(endGe == 1){iniEndGame1();}
    if(endGe == 2)
    {
        ++endGe;
        iniEndGame2();
        endGTbl.style.display = hivi[1];
        for(var i = 0; i < endGTblP.length; ++i)
        {
            endGTblP[i].style.opacity = "1";
        }
    }
    }
    else
    {
        ++endGe;
        shdMtx[12] = scrX;
        shdMtx[13] = scrY;
        gl.viewport(0,0, scrX,scrY);

        gl.bindFramebuffer(gl.FRAMEBUFFER, endGFb[endGe&1]);
        gl.useProgram(shaderP16);
        gl.uniform1i(shdTex16, (endGe+1)&1);
        gl.uniformMatrix4fv(shdMtx16, false, shdMtx);
        gl.vertexAttribPointer(shdVtx16, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx16);
        gl.drawArrays(gl.TRIANGLES, 0, 3);

        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
        gl.useProgram(shaderP17);
        gl.uniform1i(shdTex17, endGe&1);
        gl.vertexAttribPointer(shdVtx17, 1, gl.FLOAT, 0, 0, 0);
        gl.enableVertexAttribArray(shdVtx17);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
    }
    
    requestAnimationFrame(render);
}
function renderMach(wp)//wp is the machine
{
    var w  = 0;
    w = wp*mchJMx*bJotNe;
    for(var i = 0; i < machJn[wp]; ++i)
    {
        var j0 = machJ[w+0];
        var j1 = machJ[w+1];  w+=bJotNe;
        var i4 = i<<2;
        bSelGPU[i4+0] = (j0   )&255;
        bSelGPU[i4+1] = (j0>>8)&255;
        bSelGPU[i4+2] = (j1   )&255;
        bSelGPU[i4+3] = (j1>>8)&255;
    }
    gl.activeTexture(gl.TEXTURE3);
    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, machJn[wp],1, gl.RGBA, gl.UNSIGNED_BYTE, bSelGPU);
    w = wp*mchRMx*bRotNe;
    for(var i = 0; i < machRn[wp]; ++i)
    {
        var r0 = machR[w+0];
        var r1 = machR[w+1];
        var r2 = machR[w+2];  w+=bRotNe;
        var i8 = i<<3;
        bSelGPU[i8+0] = (r0   )&255;
        bSelGPU[i8+1] = (r0>>8)&255;
        bSelGPU[i8+2] = (r1   )&255;
        bSelGPU[i8+3] = (r1>>8)&255;
        bSelGPU[i8+4] = (r2   )&255;
        bSelGPU[i8+5] = (r2>>8)&255;
    }
    gl.activeTexture(gl.TEXTURE4);
    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, machRn[wp]<<1,1, gl.RGBA, gl.UNSIGNED_BYTE, bSelGPU);
    w = wp*mchBMx*4;    var ml = machL[wp]*2.4;
    var cd0 = cam[plyMe*camN+0]*ml + cam[plyMe*camN+3];
    var cd1 = cam[plyMe*camN+1]*ml + cam[plyMe*camN+4];
    var cd2 = cam[plyMe*camN+2]*ml + cam[plyMe*camN+5];
    for(var i = 0; i < machBn[wp]; ++i)
    {
        var i4 = i<<2;
        bll0[i4+0] = machB[w+0]+cd0;
        bll0[i4+1] = machB[w+1]+cd1;
        bll0[i4+2] = machB[w+2]+cd2;
        bll0[i4+3] = machB[w+3];  w+=4;
    }
    gl.activeTexture(gl.TEXTURE0);
    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, machBn[wp],1, gl.RGBA, gl.FLOAT, bll0);

    var pr = plyMe*camN;
  //shdMtx[ 0] = -1;
  //shdMtx[ 1] = 0;
  //shdMtx[ 2] = 0;
    shdMtx[ 3] = bllMx;
  //shdMtx[ 4] = dl*2;
  //shdMtx[ 5] = 0;
  //shdMtx[ 6] = 0;
    shdMtx[ 7] = timW*.001;
  //shdMtx[ 8] = prj0;
  //shdMtx[ 9] = prj1;
    shdMtx[10] = meshXz3;

    //draw balls
    shdMtx[14] = icoMsh3;
    gl.useProgram(shaderP0);
    gl.uniform1i(shdTex00, 0);
    gl.uniform1i(shdTex01, 2);
    gl.uniformMatrix4fv(shdMtx0, false, shdMtx);
    gl.uniformMatrix4fv(shdVec0, false, shdVec);
    gl.vertexAttribPointer(shdVtx0, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx0);
    gl.drawArrays(gl.TRIANGLES, 0, icoMsh3*machBn[wp]);
    //draw joints
    shdMtx[11] = bJotMx;
    shdMtx[14] = jotMsh3;
    gl.useProgram(shaderP4);
    gl.uniform1i(shdTex40, 0);
    gl.uniform1i(shdTex41, 2);
    gl.uniform1i(shdTex42, 3);
    gl.uniformMatrix4fv(shdMtx4, false, shdMtx);
    gl.uniformMatrix4fv(shdVec4, false, shdVec);
    gl.vertexAttribPointer(shdVtx4, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx4);
    gl.drawArrays(gl.TRIANGLES, 0, jotMsh3*machJn[wp]);
    //draw rotors
    shdMtx[11] = bRotMx;
    shdMtx[14] = rotMsh3;
    gl.useProgram(shaderP6);
    gl.uniform1i(shdTex60, 0);
    gl.uniform1i(shdTex61, 2);
    gl.uniform1i(shdTex62, 4);
    gl.uniformMatrix4fv(shdMtx6, false, shdMtx);
    gl.uniformMatrix4fv(shdVec6, false, shdVec);
    gl.vertexAttribPointer(shdVtx6, 1, gl.FLOAT, 0, 0, 0);
    gl.enableVertexAttribArray(shdVtx6);
    gl.drawArrays(gl.TRIANGLES, 0, rotMsh3*machRn[wp]*3);

    //restore textures
    bJotGPUo = true;
    bRotGPUo = true;
    gl.activeTexture(gl.TEXTURE0);
    gl.texSubImage2D(gl.TEXTURE_2D, 0, 0,0, bllMx,1, gl.RGBA, gl.FLOAT, bllP);
}
function rndrAllMch()//update HTML canvas table showing all machines
{
    cnvs.width  = machRz;
    cnvs.height = machRz;
    gl.viewport(0,0, machRz,machRz);
    gl.bindFramebuffer(gl.FRAMEBUFFER, null);

    var pr = plyMe*camN;
    shdMtx[0] = cam[pr+0];
    shdMtx[1] = cam[pr+1];
    shdMtx[2] = cam[pr+2];

    shdMtx[4] = cam[pr+3];
    shdMtx[5] = cam[pr+4];
    shdMtx[6] = cam[pr+5];

    shdMtx[8] = 1.2;
    shdMtx[9] = 1.2;
    for(var j = 0; j < plyMx; ++j)
    {
        if((plyA&(1<<j))==0){continue;}
        for(var i = 0; i < machMx; ++i)
        {
            var rpi = j*machMx+i;
            if(machBn[rpi]!=0){gl.clearColor(.0,.0,.0,1); gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT); renderMach(rpi);}
            else              {gl.clearColor(.4,.4,.4,1); gl.clear(gl.COLOR_BUFFER_BIT);}
            machCnv2[rpi].drawImage(cnvs, 0, 0);
        }
    }
    
    cnvs.width  = scrX;
    cnvs.height = scrY;
}

var endGTx = new Array(2);
var endGFb = new Array(2);
var endGi = true; //first time reach endgame
var endGTbl;
var endGTblP = new Array(1+campainL.length+1);
var endGe = 0;//0=playgame 1=iniEndGame 2=show endgame score
function iniEndGame1()
{
    if(endGi)
    {
        endGi = false;

        var tbl = document.createElement("table");  endGTbl = tbl;
        //tbl.style.zIndex = "1";
        tbl.style.position = "relative";//fixed relative
        tbl.style.marginLeft  = "auto";
        tbl.style.marginRight = "auto";
        tbl.style.pointerEvents = "none";
        //tbl.style.width  = "100px";
        //tbl.style.height = "100px";
        //tbl.style.display = hivi[0];
        document.body.appendChild(tbl);

        var tr = document.createElement("tr");  tbl.appendChild(tr);
        var th = document.createElement("th");   tr.appendChild(th);

            var p = document.createElement("p");  endGTblP[0] = p;
            //p.style.width  = "200px";
            //p.style.height = "200px";
            p.style.margin = "0px";
            p.style.border = "0px";
            p.style.whiteSpace = "pre";
            p.style.fontFamily = "inherit";
            p.style.fontSize = Math.floor(window.innerHeight*.1)+"px";
            p.style.opacity = "0";
            p.style.transition = "all 1s ease-out";
            p.style.fontWeight = "bold";
            p.style.textShadow = `0px 1px 0px rgb(220,220,220),
                                  0px 2px 0px rgb(180,180,180),
                                  0px 3px 0px rgb(140,140,140),
                                  0px 4px 0px rgb(100,100,100),
                                  0px 5px 0px rgb(80,80,80)`;
            p.style.color = "rgb(190,255,200)";
            p.innerHTML = "FINISH";
            th.appendChild(p);

        for(var i = 0; i < campainL.length; ++i)
        {
            tr = document.createElement("tr");  tbl.appendChild(tr);
            th = document.createElement("th");   tr.appendChild(th);

                p = document.createElement("p");  endGTblP[1+i] = p;
              //p.style.width  = "200px";
              //p.style.height = "200px";
                p.style.margin = "0px";
                p.style.border = "0px";
              //p.style.borderRadius = "8px";
              //p.style.background = "rgb(134,123,235)";
                p.style.whiteSpace = "pre";
                p.style.fontFamily = "inherit";
                p.style.fontSize = Math.floor(window.innerHeight*.037)+"px";
                p.style.opacity = "0";
                p.style.transition = "all 500ms ease-out "+(500*(i+5))+"ms";
                p.style.fontWeight = "bold";
                p.style.textShadow = `0px 1px 0px rgb(220,220,220),
                                      0px 2px 0px rgb(180,180,180),
                                      0px 3px 0px rgb(140,140,140),
                                      0px 4px 0px rgb(100,100,100),
                                      0px 5px 0px rgb(80,80,80)`;
                p.style.color = "rgb(250,250,250)";
                th.appendChild(p);
        }

        tr = document.createElement("tr");  tbl.appendChild(tr);
        th = document.createElement("th");   tr.appendChild(th);

            p = document.createElement("p");  endGTblP[1+campainL.length] = p;
            //p.style.width  = "200px";
            //p.style.height = "200px";
            p.style.margin = "0px";
            p.style.border = "0px";
            p.style.whiteSpace = "pre";
            p.style.fontFamily = "inherit";
            p.style.fontSize = Math.floor(window.innerHeight*.04)+"px";
            p.style.opacity = "0";
            p.style.transition = "all 500ms ease-out "+(500*(campainL.length+6))+"ms";
            p.style.fontWeight = "bold";
            p.style.textShadow = `0px 1px 0px rgb(220,220,220),
                                  0px 2px 0px rgb(180,180,180),
                                  0px 3px 0px rgb(140,140,140),
                                  0px 4px 0px rgb(100,100,100),
                                  0px 5px 0px rgb(80,80,80)`;
            p.style.color = "rgb(190,255,200)";
            th.appendChild(p);
    }
    var tt = 0;
    var td = 0;
    for(var i = 0; i < campainL.length; ++i)
    {
        var lt = lvlTim[i];
        var ld = lvlDed[i];
        tt += lt;
        td += ld;
                   lt /= inpPs*kysPs;
        endGTblP[1+i              ].innerHTML = "Level "+i+"    Time "+Math.floor(lt/60)+":"+(Math.floor(lt)%60)+":"+(lt-Math.floor(lt)).toFixed(3)+"    Deaths "+ld;
    }   tt /= inpPs*kysPs;
        endGTblP[1+campainL.length].innerHTML = "TOTAL    Time "      +Math.floor(tt/60)+":"+(Math.floor(tt)%60)+":"+(tt-Math.floor(tt)).toFixed(3)+"    Deaths "+td;
}
function iniEndGame2()
{
    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);

    gl.activeTexture(gl.TEXTURE0);   
    endGTx[0] = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, endGTx[0]);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.FLOAT, cnvs);

    gl.activeTexture(gl.TEXTURE1);   
    endGTx[1] = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, endGTx[1]);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.FLOAT, cnvs);

    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, false);

    endGFb[0] = frameBuffCreator(endGTx[0]);
    endGFb[1] = frameBuffCreator(endGTx[1]);
}
function hideEndGame()
{
    endGe =  0;

    gl.bindFramebuffer(gl.FRAMEBUFFER, null);

    gl.deleteTexture(endGTx[0]);        endGTx[0] = null;
    gl.deleteTexture(endGTx[1]);        endGTx[1] = null;
    gl.deleteFramebuffer(endGFb[0]);    endGFb[0] = null;
    gl.deleteFramebuffer(endGFb[1]);    endGFb[1] = null;
    gl.activeTexture(gl.TEXTURE0);  gl.bindTexture(gl.TEXTURE_2D, tex0);
    gl.activeTexture(gl.TEXTURE1);  gl.bindTexture(gl.TEXTURE_2D, tex1);

    endGTbl.style.display = hivi[0];
    for(var i = 0; i < endGTblP.length; ++i)
    {
        endGTblP[i].style.opacity = "0";
    }

    for(var i = 0; i < lvlDed.length; ++i){lvlDed[i] = 0;}
}

</script>
</body>
</html>
